;/T/ Gestion des périodes comptables (Holding)
;
;//M/GRA01/Francois Richard/1999-06-18
;  Description.: PROSIG
;                Modification des traitements dans le quel
;                on retrouve des années, périodes
;                tel que select, sort, choose, define, if.
;                Correction des formats sur les dates dans les écrans.
;

;/P/ Programmeur..: Guy Chabot
;    Date Création: 24-Feb-1992
;
;    Description..: Permet de définir les périodes comptables au niveau
;                   du Holding. et de definir les periode par cie.
;
;    La procedure generation compagnie fait la relation entre
;                 MCPERIODE_CTB et MCPERIODE_CIE. voici les differente
;                 relation qui peut existe selon le holding
;
;
;-------------------------------------------------------------------------------
; /A/ Adaptation Nancy Marceau , 22 mars 1994
;       - Ajout des périodes achat et inventaire
;       - Valider lors de la fermeture des C/P et du  G/L que les périodes
;         d'achat et inventaire soient fermées.


;/V/ Écran vérifier pour le passage à l'an 2000


SCREEN mc012 ACTIONBAR &
             MODE LABEL "" AT 2,80 &
             NOACTION FIELDMARK RETAIN STARTUP &

@IF UNIX

             TRANSACTION MODE DUAL &
@ENDIF
             HELP POPUP FROM 4,9 TO 20,72 &
             RECEIVING T_CIENOM


TEMPORARY T_PECCLE_SIE21 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE20 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE19 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE18 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE17 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE16 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE15 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE14 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE13 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE12 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE10 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE9 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCOUIM_SIE8 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE8 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCOUIN_SIE7 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE7 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCOUAR_SIE6 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE6 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCOUCR_SIE5 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE5 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCOUCP_SIE4 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE4 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLEGL_SIE CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE3 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE2 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle

TEMPORARY T_PECCLE_SIE1 CHARACTER SIZE 5 ; Temporaire servant pour le changement de siècle



USE ussectmp  NOLIST
    "MC012"

USE mc012.hlp NOLIST

USE usactecr NOLIST

@IF FRANCAIS
ACTIONMENU LABEL "Procédure"
  MENUITEM LABEL "Génération cie" ACTION DESIGNER MC01
@ELSE
ACTIONMENU LABEL "Procedure"
  MENUITEM LABEL "Co Generation" ACTION DESIGNER MC01
@ENDIF

;-------------------------------------------------------------------------------
;
TEMPORARY T_CIENOM   CHARACTER SIZE 40; Nom de la compagnie-holding


;-------------------------------------------------------------------------------
;
; Pour valider le nombre de période.
;
FILE MCHOLDING        REFERENCE
  ACCESS VIA CIENMC USING "1"

;
;
FILE MCPERIODE_CTB    PRIMARY NOITEM
  ACCESS REQUEST PECCLE OF MCPERIODE_CTB &
         VIA     PECCLE &
         USING   PECCLE OF MCPERIODE_CTB &
         ORDERED
 ACCESS SEQUENTIAL &
        ORDERBY PECCLE

;
; Destruction des périodes par compagnie si on détruit la période.
;
FILE MCPERIODE_CIE    DELETE ALIAS A_PCC_DELETE &
                      NOITEM
  ACCESS VIA PECCLE &
         USING PECCLE OF MCPERIODE_CTB

;
; Table pour la vérification des intervalles de date.
;
; le select est la car l'access de cette table est sequentiel dans un
; while retrieving.
;
FILE MCPERIODE_CTB    DESIGNER &
                      OPEN READ &
                      ALIAS A_PEC_INTERVALLE
  SELECT IF PECCLE OF A_PEC_INTERVALLE <> PECCLE OF MCPERIODE_CTB

;
; Sert à la génération des périodes-compagnie et au changement de statut
;
FILE MCPERIODE_CTB    ALIAS A_PERIODE_CTB &
                      DESIGNER

;
; Sert à la génération des périodes-compagnie.
;
FILE MCCOMPAGNIE      DESIGNER &
                      OPEN READ

;
; Sert à la génération des périodes-compagnie et au changement de statut.
;
FILE MCPERIODE_CIE    DESIGNER

;
; Validation des codes bilingues
;
FILE VCBI_DSC         DESIGNER &
                      OPEN READ

;
; Pour valider s'il reste des lots non journalisés sur le Holding.
;
FILE GLLOT            DESIGNER &
                      OPEN READ

;-------------------------------------------------------------------------------
;
DEFINE    D_PECSTUGL CHARACTER SIZE 16 = "PECSTUGL"
DEFINE    D_PECSTUCP CHARACTER SIZE 16 = "PECSTUCP"
DEFINE    D_PECSTUCR CHARACTER SIZE 16 = "PECSTUCR"
DEFINE    D_PECSTUAR CHARACTER SIZE 16 = "PECSTUAR"
DEFINE    D_PECSTUIN CHARACTER SIZE 16 = "PECSTUIN"
DEFINE    D_PECSTUIM CHARACTER SIZE 16 = "PECSTUIM"

TEMPORARY T_PECSTUGL CHARACTER SIZE 4
TEMPORARY T_PECSTUCP CHARACTER SIZE 4
TEMPORARY T_PECSTUCR CHARACTER SIZE 4
TEMPORARY T_PECSTUAR CHARACTER SIZE 4
TEMPORARY T_PECSTUIN CHARACTER SIZE 4
TEMPORARY T_PECSTUIM CHARACTER SIZE 4

;
; ancienne valeur des statuts
;
TEMPORARY T_OLDSTU   CHARACTER SIZE 1
TEMPORARY T_OLDSTUGL CHARACTER SIZE 1
TEMPORARY T_OLDSTUCP CHARACTER SIZE 1
TEMPORARY T_OLDSTUCR CHARACTER SIZE 1
TEMPORARY T_OLDSTUAR CHARACTER SIZE 1
TEMPORARY T_OLDSTUIN CHARACTER SIZE 1
TEMPORARY T_OLDSTUIM CHARACTER SIZE 1

TEMPORARY T_PECCLE   CHARACTER SIZE 4 ; Pour accèder la période suivante

TEMPORARY T_PECCOUGL CHARACTER SIZE 4 ; Pour la génération des périodes/cie.
TEMPORARY T_PECCOUCR CHARACTER SIZE 4 ; Pour la génération des périodes/cie.
TEMPORARY T_PECCOUCP CHARACTER SIZE 4 ; Pour la génération des périodes/cie.
TEMPORARY T_PECCOUAR CHARACTER SIZE 4 ; Pour la génération des périodes/cie.
TEMPORARY T_PECCOUIN CHARACTER SIZE 4 ; Pour la génération des périodes/cie.
TEMPORARY T_PECCOUIM CHARACTER SIZE 4 ; Pour la génération des périodes/cie.

TEMPORARY T_FLGDEL CHARACTER SIZE 1 ; Flag pour le sous-écran de destruction

DEFINE DZ_CIECLE CHARACTER SIZE 4 = " "
DEFINE DZ_CIENOM CHARACTER SIZE 40 = CENTER( T_CIENOM )

;-------------------------------------------------------------------------------
;
USE usdrwecr NOLIST
USE ustitstd NOLIST
USE ushilite NOLIST

SKIP

@IF FRANCAIS
 TITLE " Périodes comptables " CENTERED AT ,1
@ELSE
 TITLE " Accounting Periods " CENTERED AT ,1
@ENDIF

DRAW 11,1 TO 11,80
DRAW 13,1 TO 13,80

USE ustitoff NOLIST

SKIP

ALIGN (3,3,19)

FIELD PECCLE      OF MCPERIODE_CTB HIDDEN ID 05 REQUIRED NOCHANGE &
label "Période ......:" &
      PATTERN "##((1(0|1|2|3|4))|(0(1|2|3|4|5|6|7|8|9)))"   &
      LOOKUP NOTON MCPERIODE_CTB &
             VIA PECCLE USING PECCLE OF MCPERIODE_CTB &
      MESSAGE 137 ; cette periode existe deja
SKIP 1

FIELD PECRGL      OF MCPERIODE_CTB HIDDEN ID 10 NOCHANGE DEFAULT "0" &
label "Régularisation:"
SKIP 1

;
; Les dates sont requis que pour des période autre que de régularisation
;
FIELD PECDATDEB   OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 20 REQUIRED &
label "Date début....:" &
      IF PECRGL OF MCPERIODE_CTB = "0"
SKIP 1
FIELD PECDATFIN   OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 25 REQUIRED &
label "Date fin......:" &
      IF PECRGL OF MCPERIODE_CTB = "0"

SKIP 1

@IF FRANCAIS
 TITLE "Module"            AT ,7
 TITLE "Date Fermeture"    AT ,27
 TITLE "Statut"            AT ,47
@ELSE
 TITLE "Module"       AT ,7
 TITLE "Closing Date" AT ,27
 TITLE "Status"       AT ,47
@ENDIF

SKIP 2

ALIGN (30,3,30) (,,50)
FIELD PECDATFERGL OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 30 DISPLAY &
@IF FRANCAIS
        LABEL "Grand Livre      "
@ELSE
        LABEL "General Ledger   "
@ENDIF

FIELD PECSTUGL    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUGL, &
                PECSTUGL OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide

FIELD PECDATFERCR OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 35 DISPLAY &
@IF FRANCAIS
        LABEL "Compte à recevoir"
@ELSE
        LABEL "Accounts Receivable"
@ENDIF

FIELD PECSTUCR    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUCR, &
                PECSTUCR OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide

FIELD PECDATFERCP OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 40 DISPLAY &
@IF FRANCAIS
        LABEL "Compte à payer   "
@ELSE
        LABEL "Accounts Payable "
@ENDIF

FIELD PECSTUCP    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUCP, &
                PECSTUCP OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide

FIELD PECDATFERAR OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 45 DISPLAY &
@IF FRANCAIS
        LABEL "Achats/Réceptions"
@ELSE
        LABEL "%%%Achats/Réceptions"
@ENDIF

FIELD PECSTUAR    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUAR, &
                PECSTUAR OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide

FIELD PECDATFERIN OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 50 DISPLAY &
@IF FRANCAIS
        LABEL "Inventaire       "
@ELSE
        LABEL "%%%Inventaire       "
@ENDIF

FIELD PECSTUIN    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUIN, &
                PECSTUIN OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide


FIELD PECDATFERIM OF MCPERIODE_CTB  FORMAT YYYYMMDD PATTERN "####/##/##" HIDDEN ID 55 DISPLAY &
@IF FRANCAIS
        LABEL "Immobilisation   "
@ELSE
        LABEL "%%%immobilisation"
@ENDIF

FIELD PECSTUIM    OF MCPERIODE_CTB ID SAME NOENTRY &
        LOOKUP ON VCBI_DSC &
          VIA XELNOM, &
              CBICLE &
          USING D_PECSTUIM , &
                PECSTUIM OF MCPERIODE_CTB &
          MESSAGE 112 ; Code invalide

;-------------------------------------------------------------------------------
;
;
; Valide la sécurité d'accès de l'écran.
;
;
PROCEDURE INITIALIZE
BEGIN
  USE ussececr NOLIST
END


;-------------------------------------------------------------------------------
;
; Transformation des champs oui ou non en 1 et 0
;
PROCEDURE INPUT PECRGL
BEGIN
  USE usflginp NOLIST
END

;-------------------------------------------------------------------------------
;
; Affichage selon la langue
;
;
PROCEDURE OUTPUT PECRGL
BEGIN
  USE usflgout NOLIST
END

;-------------------------------------------------------------------------------
;
;
PROCEDURE INTERNAL VALIDE_STATUT
BEGIN
  ;
  ; Validation de la valeur saisie, on ne peut pas saisir la valeur S.
  ;
  IF "F" <> FIELDTEXT AND &
     "C" <> FIELDTEXT
  THEN ERROR 138 ; la valeur saisie n'est pas autorisé

  ;
  ; Chagement de statut valide.
  ;
  ; S ==> C  Pour inscrire la première période courante dans le système.
  ; C ==> F  Pour fermer la période courante.
  ; F ==> C  Pour réouvrire une période.
  ;
  IF (T_OLDSTU = "S" AND FIELDTEXT = "C") OR &
     (T_OLDSTU = "C" AND FIELDTEXT = "F") OR &
     (T_OLDSTU = "F" AND FIELDTEXT = "C") OR &
     (T_OLDSTU = FIELDTEXT)
  THEN NULL
  ELSE ERROR 138 ; la valeur saisie n'est pas autorisé
  ;
  ;
  IF T_OLDSTU <> FIELDTEXT
  THEN BEGIN
    ;
    ; Seul la première période peut devenir courante.(initialisation du système)
    ;
    IF (T_OLDSTU = "S" AND FIELDTEXT = "C")
    THEN BEGIN
      WHILE RETRIEVING A_PERIODE_CTB SEQUENTIAL
      BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
        THEN LET T_PECCLE_SIE1 = "1" + PECCLE OF A_PERIODE_CTB
        ELSE LET T_PECCLE_SIE1 = "0" + PECCLE OF A_PERIODE_CTB

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
        THEN LET T_PECCLE_SIE2 = "1" + PECCLE OF MCPERIODE_CTB
        ELSE LET T_PECCLE_SIE2 = "0" + PECCLE OF MCPERIODE_CTB

        IF T_PECCLE_SIE1 < T_PECCLE_SIE2
        THEN ERROR 139 ; On peut ouvrir que la première période.
      END
    END
    ;
    ; On valide les 2 autres cas.
    ;
    ELSE BEGIN
      ;
      ; Calcul pour avoir le prochain numéro de période, si la séquence de la
      ; période est inférieure au nombre de période défini dans le holding,
      ; alors cela indique qu'on reste dans la même année, sinon c'est un
      ; changement d'année.
      ;
      ; ex: nombre de période = 12
      ;     Si 9210 la suivante est 9211
      ;     si 9212 la suivante est 9301
      ;

      IF HLDNBRPERCTB OF MCHOLDING > NCONVERT(PECCLE OF MCPERIODE_CTB[3:2])
      THEN LET T_PECCLE = PECCLE OF MCPERIODE_CTB[1:2] + &
                          ASCII(NCONVERT(PECCLE OF MCPERIODE_CTB[3:2]) + 1,2)
                          ; Ajustement pour le changement de siècle
      ELSE LET T_PECCLE = ASCII(NCONVERT(PECCLE OF MCPERIODE_CTB[1:2]) + 1,3)[2:2] &
                          + "01"
      ;
      ; La période suivante doit exister dans le cas d'une fermeture ou d'une
      ; réouverture.
      ;
      GET A_PERIODE_CTB VIA PECCLE USING T_PECCLE OPTIONAL
      IF NOT ACCESSOK
      THEN ERROR 140 ; La periode suivante doit exister
    END
  END
END

;-------------------------------------------------------------------------------
;
;
; Popup des statuts pour le module G/L.
;
;
PROCEDURE INPUT PECSTUGL
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUGL = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F PASSING D_PECSTUGL, T_PECSTUGL
    LET FIELDTEXT = TRUNC(T_PECSTUGL)
  END
END


;-------------------------------------------------------------------------------
;
;
; Valide le statut de la période pour le module G/L.
;
;
PROCEDURE EDIT PECSTUGL
BEGIN
  LET T_OLDSTU = T_OLDSTUGL
  DO INTERNAL VALIDE_STATUT

  ;
  ; Dans le cas d'une réouverture la période suivante doit courante.
  ;
  IF T_OLDSTUGL = "F" AND FIELDTEXT = "C" AND &
     PECSTUGL OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ; On peut réouvrir que la dernière période fermée.
  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUGL OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END

  IF FIELDTEXT = "F"
  THEN BEGIN
    IF PECSTUCP OF MCPERIODE_CTB <> "F" OR &
       PECSTUCR OF MCPERIODE_CTB <> "F" OR &
       PECSTUAR OF MCPERIODE_CTB <> "F" OR &
       PECSTUIN OF MCPERIODE_CTB <> "F" OR &
       PECSTUIM OF MCPERIODE_CTB <> "F"
    THEN ERROR 142 ; Le grand livre doit être fermé en dernier
    ;
    ; On vérifie s'il reste des lots non journalisés sur le Holding.
    ;
    GET GLLOT VIA LGLCIECLE, &
                  PECCLE   , &
                  LGLDATJOU  &
              USING HLDCHRSUB OF MCHOLDING[1:4], &
                    PECCLE    OF MCPERIODE_CTB , &
                    0                            &
              OPTIONAL
    IF ACCESSOK
    THEN ERROR 144 ; Il reste des lots non journalisés.
  END
END


;-------------------------------------------------------------------------------
;
;
PROCEDURE INPUT PECSTUCP
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUCP = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F PASSING D_PECSTUCP, T_PECSTUCP
    LET FIELDTEXT = TRUNC(T_PECSTUCP)
  END
END

;-------------------------------------------------------------------------------
;
; Valide le statut de la période pour le module C.A.P.
;
;
PROCEDURE EDIT PECSTUCP
BEGIN
  LET T_OLDSTU = T_OLDSTUCP
  DO INTERNAL VALIDE_STATUT
  ;
  ; Dans le cas d'une réouverture la période suivante doit être courante.
  ;
  IF T_OLDSTUCP = "F" AND FIELDTEXT = "C" AND &
     PECSTUCP OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ;On peut réouvrir que la dernière période fermée.
  ;
  ;
  ; On ne peut pas réouvrir la période si le grand livre est fermé.
  ;
  IF FIELDTEXT = "C" AND &
     PECSTUGL OF MCPERIODE_CTB = "F"
  THEN ERROR 145 ; Le grand livre est fermé

  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUCP OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END

  IF FIELDTEXT = "F"
  THEN BEGIN
    IF PECSTUAR OF MCPERIODE_CTB <> "F" OR &
       PECSTUIN OF MCPERIODE_CTB <> "F"
    THEN ERROR 190 ; Les périodes d'achat et d'inventaire doivent être fermées.
  END

END

;-------------------------------------------------------------------------------
;
;
;
PROCEDURE INPUT PECSTUCR
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUCR = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F PASSING D_PECSTUCR, T_PECSTUCR
    LET FIELDTEXT = TRUNC(T_PECSTUCR)
  END
END

;-------------------------------------------------------------------------------
;
; Valide le statut de la période pour le module C.A.R.
;
;
PROCEDURE EDIT PECSTUCR
BEGIN
  LET T_OLDSTU = T_OLDSTUCR
  DO INTERNAL VALIDE_STATUT
  ;
  ; Dans le cas d'une réouverture la période suivante doit courante.
  ;
  IF T_OLDSTUCR = "F" AND FIELDTEXT = "C" AND &
     PECSTUCR OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ; On peut réouvrir que la dernière période fermée.

  ;
  ;
  ; On ne peut pas réouvrir la période si le grand livre est fermé.
  ;
  IF FIELDTEXT = "C" AND &
     PECSTUCR OF MCPERIODE_CTB = "F"
  THEN ERROR 145 ; Le grand livre est fermé

  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUCR OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END
END


;-------------------------------------------------------------------------------
;
;
PROCEDURE INPUT PECSTUAR
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUAR = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F PASSING D_PECSTUAR, T_PECSTUAR
    LET FIELDTEXT = TRUNC(T_PECSTUAR)
  END
END

;-------------------------------------------------------------------------------
;
; Valide le statut de la période pour le module Achats/Réceptions
;
;
PROCEDURE EDIT PECSTUAR
BEGIN
  LET T_OLDSTU = T_OLDSTUAR
  DO INTERNAL VALIDE_STATUT
  ;
  ; Dans le cas d'une réouverture la période suivante doit être courante.
  ;
  IF T_OLDSTUAR = "F" AND FIELDTEXT = "C" AND &
     PECSTUAR OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ;On peut réouvrir que la dernière période fermée.
  ;
  ;
  ; On ne peut pas réouvrir la période si le grand livre est fermé.
  ;
  IF FIELDTEXT = "C" AND &
     PECSTUGL OF MCPERIODE_CTB = "F"
  THEN ERROR 145 ; Le grand livre est fermé

  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUAR OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END
END


;-------------------------------------------------------------------------------
;
;
PROCEDURE INPUT PECSTUIN
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUIN = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F PASSING D_PECSTUIN, T_PECSTUIN
    LET FIELDTEXT = TRUNC(T_PECSTUIN)
  END
END

;-------------------------------------------------------------------------------
;
; Valide le statut de la période pour le module Achats/Réceptions
;
;
PROCEDURE EDIT PECSTUIN
BEGIN
  LET T_OLDSTU = T_OLDSTUIN
  DO INTERNAL VALIDE_STATUT
  ;
  ; Dans le cas d'une réouverture la période suivante doit être courante.
  ;
  IF T_OLDSTUIN = "F" AND FIELDTEXT = "C" AND &
     PECSTUIN OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ;On peut réouvrir que la dernière période fermée.
  ;
  ;
  ; On ne peut pas réouvrir la période si le grand livre est fermé.
  ;
  IF FIELDTEXT = "C" AND &
     PECSTUGL OF MCPERIODE_CTB = "F"
  THEN ERROR 145 ; Le grand livre est fermé

  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUIN OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END
END

;-------------------------------------------------------------------------------
;
;
;
PROCEDURE INPUT PECSTUIM
BEGIN
  IF 0 <> IND(FIELDTEXT,"*")
  THEN BEGIN
    LET T_PECSTUIM = FIELDTEXT[1:IND(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN mc102 MODE F &
                     PASSING D_PECSTUIM , &
                             T_PECSTUIM
    LET FIELDTEXT = TRUNCATE( T_PECSTUIM )
  END
END


;-------------------------------------------------------------------------------
;
;
; Valide le statut de la période pour le module C.A.R.
;
;
PROCEDURE EDIT PECSTUIM
BEGIN
  LET T_OLDSTU = T_OLDSTUIM
  DO INTERNAL VALIDE_STATUT
  ;
  ; Dans le cas d'une réouverture la période suivante doit être courante.
  ;
  IF T_OLDSTUIM = "F" AND FIELDTEXT = "C" AND &
     PECSTUIM OF A_PERIODE_CTB <> "C"
  THEN ERROR 141 ; On peut réouvrir que la dernière période fermée.

  ;
  ; On ne peut pas réouvrir la période si le grand livre est fermé.
  ;
  IF FIELDTEXT = "C" AND &
     PECSTUGL OF MCPERIODE_CTB = "F"
  THEN ERROR 145 ; Le grand livre est fermé
  ;
  ; Fermeture de période.
  ;
  IF FIELDTEXT = "F"
  THEN BEGIN
    WHILE RETRIEVING MCPERIODE_CIE VIA PECCLE USING PECCLE OF MCPERIODE_CTB
    BEGIN
      IF PCCSTUIM OF MCPERIODE_CIE <> "F"
      THEN ERROR 143 ; Une des compagnies n'est pas fermé
    END
  END
END


;-------------------------------------------------------------------------------
;
;
; Valide si l'usager peut faire de la saisie.
;
;
PROCEDURE PREENTRY
BEGIN
  USE ussecent NOLIST
END


;-------------------------------------------------------------------------------
;
; On demande les date de debut et de fin que pour les periode autres
; que les periode de regularisation.
;
PROCEDURE DESIGNER 20
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECDATDEB OF MCPERIODE_CTB
  END
END
;-------------------------------------------------------------------------------
;
;
;
PROCEDURE DESIGNER 25
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECDATFIN OF MCPERIODE_CTB
  END
END
;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 30
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUGL OF MCPERIODE_CTB
  END
END
;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 35
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUCR OF MCPERIODE_CTB
  END
END
;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 40
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUCP OF MCPERIODE_CTB
  END
END

;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 45
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUAR OF MCPERIODE_CTB
  END
END

;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 50
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUIN OF MCPERIODE_CTB
  END
END

;-------------------------------------------------------------------------------
;
PROCEDURE DESIGNER 55
BEGIN
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    ACCEPT PECSTUIM OF MCPERIODE_CTB
  END
END

;-------------------------------------------------------------------------------
;
; Génération des périodes lors du mode de comptabilisation
; "transaction supplémentaire".
;
; ici on genere les periode comptables a partir de MCPERIODE_CTB
;                                        jusqu'à   MCPERIODE_CIE par
; la relation mccompagnie
;
PROCEDURE INTERNAL TRANSACTION
BEGIN
  WHILE RETRIEVING MCCOMPAGNIE SEQUENTIAL
  BEGIN
    ;
    ; On va chercher la période courante de chaque module, pour la compagnie
    ; à traiter.
    ;
    LET T_PECCOUGL = ""
    LET T_PECCOUCR = ""
    LET T_PECCOUCP = ""
    LET T_PECCOUAR = ""
    LET T_PECCOUIN = ""
    LET T_PECCOUIM = ""

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUGL &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUGL = PECCLE OF MCPERIODE_CIE

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUCP &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUCP = PECCLE OF MCPERIODE_CIE

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUCR &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUCR = PECCLE OF MCPERIODE_CIE

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUAR &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUAR = PECCLE OF MCPERIODE_CIE

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUIN &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUIN = PECCLE OF MCPERIODE_CIE

    GET MCPERIODE_CIE VIA CIECLE , &
                          PCCSTUIM &
                      USING CIECLE OF MCCOMPAGNIE , &
                            "C"                     &
                      OPTIONAL
    IF ACCESSOK
    THEN LET T_PECCOUIM = PECCLE OF MCPERIODE_CIE


    GET MCPERIODE_CIE VIA CIECLE, PECCLE &
        USING CIECLE OF MCCOMPAGNIE, &
              PECCLE OF A_PERIODE_CTB OPTIONAL
    IF NOT ACCESSOK
    THEN BEGIN
      LET CIECLE      OF MCPERIODE_CIE = CIECLE      OF MCCOMPAGNIE
      LET PECCLE      OF MCPERIODE_CIE = PECCLE      OF A_PERIODE_CTB
      ;
      ; Pour chaque module,
      ;  - s'il n'y a pas de période courante on prend
      ;    l'information dans les périodes du holding,
      ;  - si la période est inférieure à la période courante on met le statut
      ;    à fermé.
      ;  - si la période est supérieure à la période courante on met le statut
      ;    à subséquent.
      ;
      IF T_PECCOUGL = ""
      THEN BEGIN
        LET PCCSTUGL    OF MCPERIODE_CIE = PECSTUGL    OF A_PERIODE_CTB
        LET PCCDATFERGL OF MCPERIODE_CIE = PECDATFERGL OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE3 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE3 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUGL[1:1] < "8"
        THEN LET T_PECCLEGL_SIE = "1" + T_PECCOUGL
        ELSE LET T_PECCLEGL_SIE = "0" + T_PECCOUGL

        IF T_PECCLE_SIE3 < T_PECCLEGL_SIE
        THEN BEGIN
          LET PCCSTUGL    OF MCPERIODE_CIE = "F"
          LET PCCDATFERGL OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUGL    OF MCPERIODE_CIE = "S"
          LET PCCDATFERGL OF MCPERIODE_CIE = 0
        END
      END

      IF T_PECCOUCP = ""
      THEN BEGIN
        LET PCCSTUCP    OF MCPERIODE_CIE = PECSTUCP    OF A_PERIODE_CTB
        LET PCCDATFERCP OF MCPERIODE_CIE = PECDATFERCP OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE4 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE4 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUCP[1:1] < "8"
        THEN LET T_PECCOUCP_SIE4 = "1" + T_PECCOUCP
        ELSE LET T_PECCOUCP_SIE4 = "0" + T_PECCOUCP

        IF T_PECCLE_SIE4 < T_PECCOUCP_SIE4
        THEN BEGIN
          LET PCCSTUCP    OF MCPERIODE_CIE = "F"
          LET PCCDATFERCP OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUCP    OF MCPERIODE_CIE = "S"
          LET PCCDATFERCP OF MCPERIODE_CIE = 0
        END
      END

      IF T_PECCOUCR = ""
      THEN BEGIN
        LET PCCSTUCR    OF MCPERIODE_CIE = PECSTUCR    OF A_PERIODE_CTB
        LET PCCDATFERCR OF MCPERIODE_CIE = PECDATFERCR OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE5 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE5 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUCR[1:1] < "8"
        THEN LET T_PECCOUCR_SIE5 = "1" + T_PECCOUCR
        ELSE LET T_PECCOUCR_SIE5 = "0" + T_PECCOUCR

        IF T_PECCLE_SIE5 < T_PECCOUCR_SIE5
        THEN BEGIN
          LET PCCSTUCR    OF MCPERIODE_CIE = "F"
          LET PCCDATFERCR OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUCR    OF MCPERIODE_CIE = "S"
          LET PCCDATFERCR OF MCPERIODE_CIE = 0
        END
      END


      IF T_PECCOUAR = ""
      THEN BEGIN
        LET PCCSTUAR    OF MCPERIODE_CIE = PECSTUAR    OF A_PERIODE_CTB
        LET PCCDATFERAR OF MCPERIODE_CIE = PECDATFERAR OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE6 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE6 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUAR[1:1] < "8"
        THEN LET T_PECCOUAR_SIE6 = "1" + T_PECCOUAR
        ELSE LET T_PECCOUAR_SIE6 = "0" + T_PECCOUAR

        IF T_PECCLE_SIE6 < T_PECCOUAR_SIE6
        THEN BEGIN
          LET PCCSTUAR    OF MCPERIODE_CIE = "F"
          LET PCCDATFERAR OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUAR    OF MCPERIODE_CIE = "S"
          LET PCCDATFERAR OF MCPERIODE_CIE = 0
        END
      END

      IF T_PECCOUIN = ""
      THEN BEGIN
        LET PCCSTUIN    OF MCPERIODE_CIE = PECSTUIN    OF A_PERIODE_CTB
        LET PCCDATFERIN OF MCPERIODE_CIE = PECDATFERIN OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE7 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE7 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUIN[1:1] < "8"
        THEN LET T_PECCOUIN_SIE7 = "1" + T_PECCOUIN
        ELSE LET T_PECCOUIN_SIE7 = "0" + T_PECCOUIN

        IF T_PECCLE_SIE7 < T_PECCOUIN_SIE7
        THEN BEGIN
          LET PCCSTUIN    OF MCPERIODE_CIE = "F"
          LET PCCDATFERIN OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUIN    OF MCPERIODE_CIE = "S"
          LET PCCDATFERIN OF MCPERIODE_CIE = 0
        END
      END

      IF T_PECCOUIM = ""
      THEN BEGIN
        LET PCCSTUIM    OF MCPERIODE_CIE = PECSTUIM    OF A_PERIODE_CTB
        LET PCCDATFERIM OF MCPERIODE_CIE = PECDATFERIM OF A_PERIODE_CTB
      END
      ELSE BEGIN

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CIE[1:1] < "8"
        THEN LET T_PECCLE_SIE8 = "1" + PECCLE OF MCPERIODE_CIE
        ELSE LET T_PECCLE_SIE8 = "0" + PECCLE OF MCPERIODE_CIE

        ; Ajustement pour le changement de siècle
        IF T_PECCOUIM[1:1] < "8"
        THEN LET T_PECCOUIM_SIE8 = "1" + T_PECCOUIM
        ELSE LET T_PECCOUIM_SIE8 = "0" + T_PECCOUIM

        IF T_PECCLE_SIE8 < T_PECCOUIM_SIE8
        THEN BEGIN
          LET PCCSTUIM    OF MCPERIODE_CIE = "F"
          LET PCCDATFERIM OF MCPERIODE_CIE = SYSDATE
        END
        ELSE BEGIN
          LET PCCSTUIM    OF MCPERIODE_CIE = "S"
          LET PCCDATFERIM OF MCPERIODE_CIE = 0
        END
      END

      PUT MCPERIODE_CIE RESET
    END
  END
END


;-------------------------------------------------------------------------------
;
; Procédure designer qui appel la procédure qui génère les période par
; compagnie
;
;
PROCEDURE DESIGNER MC01 NODATA
BEGIN
  IF ALTEREDRECORD OF MCPERIODE_CTB
  THEN ERROR 132 ; faire une mise a jour avant la procedure
  ;
  ; Avant de générer les périodes par compagnie if faut
  ; vérifer qu'il y a une période courante active par module.
  ;
  GET A_PERIODE_CTB VIA PECSTUGL USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  GET A_PERIODE_CTB VIA PECSTUCP USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  GET A_PERIODE_CTB VIA PECSTUCR USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  GET A_PERIODE_CTB VIA PECSTUAR USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  GET A_PERIODE_CTB VIA PECSTUIN USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  GET A_PERIODE_CTB VIA PECSTUIM USING "C" OPTIONAL
  IF NOT ACCESSOK
  THEN ERROR 146 ; Il faut définir la période courante avant l'éxécution de cette procédure

  WHILE RETRIEVING A_PERIODE_CTB SEQUENTIAL
  BEGIN
    ;
    ; On ne genere que pour les periode non de regularisation
    ;
    IF PECRGL OF A_PERIODE_CTB <> "1"
    THEN BEGIN
      DO INTERNAL TRANSACTION
    END
  END
END


;-------------------------------------------------------------------------------
;
;
; Valide les traitements permis par écran et par usager.
;
;
PROCEDURE PREUPDATE
BEGIN
  ;
  ; Validation de la destruction
  ;
  IF     DELETEDRECORD OF MCPERIODE_CTB &
     AND TZ_SECDEL = "0"
  THEN ERROR 1
  ;
  ; Validation de la modification.
  ;
  IF     ALTEREDRECORD     OF MCPERIODE_CTB &
     AND NOT NEWRECORD     OF MCPERIODE_CTB &
     AND NOT DELETEDRECORD OF MCPERIODE_CTB &
     AND TZ_SECMOD = "0"
  THEN ERROR 2
  ;
  ; Validation du nombre maximum de périodes
  ;
  IF     HLDNBRPERCTB OF MCHOLDING < NCONVERT(PECCLE OF MCPERIODE_CTB[3:2]) &
     AND PECRGL OF MCPERIODE_CTB = "0"
  THEN ERROR 188 ; Cette période est supérieure au nombre maximum déterminé.
  ;
  ; Validation de la période de type régularisation.
  ;
  IF     HLDNBRPERCTB OF MCHOLDING <> NCONVERT(PECCLE OF MCPERIODE_CTB[3:2]) - 1 &
     AND PECRGL OF MCPERIODE_CTB = "1"
  THEN ERROR 189 ; Seul la période 13 ou 14 est valide pour une période de
                 ; régularisation

  ; Vérification des intervalles de dates que pour les periode autre
  ; que des periode de regularisation.
  ;
  IF PECRGL OF MCPERIODE_CTB = "0"
  THEN BEGIN
    IF PECDATDEB OF MCPERIODE_CTB >= PECDATFIN OF MCPERIODE_CTB
    THEN ERROR 147 ; la date de fin doit etres supp a la date de debut
    ;
    ; Retrouve toutes les periodes pour valider les intervalles de date
    ;
    WHILE RETRIEVING A_PEC_INTERVALLE SEQUENTIAL ORDERBY PECCLE
    BEGIN
      IF ( PECDATDEB OF MCPERIODE_CTB >= PECDATDEB OF A_PEC_INTERVALLE AND &
           PECDATDEB OF MCPERIODE_CTB <= PECDATFIN OF A_PEC_INTERVALLE ) OR &
         ( PECDATFIN OF MCPERIODE_CTB >= PECDATDEB OF A_PEC_INTERVALLE AND &
           PECDATFIN OF MCPERIODE_CTB <= PECDATFIN OF A_PEC_INTERVALLE ) OR &
         ( PECDATDEB OF MCPERIODE_CTB < PECDATDEB OF A_PEC_INTERVALLE AND &
           PECDATFIN OF MCPERIODE_CTB > PECDATFIN OF A_PEC_INTERVALLE )
      THEN ERROR 123 ; Il y a un conflit dans les intervalles.
    END
  END
  ;
  ; Dans le cas de la création d'une nouvelle période, on initialise le statut
  ; de cette période en fonction des périodes existantes. Si la nouvelle période
  ; est inférieur à la période courante, son statut sera "F" fermé, Sinon, son
  ; statut sera "S" Subséquent. Cette recherche se fait pour chaque module
  ;
  IF NEWRECORD OF MCPERIODE_CTB
  THEN BEGIN
    ;
    ; Si c'est la première période que l'on saisie, alors les status sont
    ; tous à S, sinon on vérifie le statut du module.
    ;
    GET A_PERIODE_CTB SEQUENTIAL OPTIONAL
    IF ACCESSOK
    THEN BEGIN
      ;
      ; Comptes à recevoir.
      ;
      GET A_PERIODE_CTB VIA PECSTUCR USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUCR OF MCPERIODE_CTB = "S"
      ELSE &

          ; Ajustement pour le changement de siècle
          IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
          THEN LET T_PECCLE_SIE9 = "1" + PECCLE OF MCPERIODE_CTB
          ELSE LET T_PECCLE_SIE9 = "0" + PECCLE OF MCPERIODE_CTB

          ; Ajustement pour le changement de siècle
          IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
          THEN LET T_PECCLE_SIE10 = "1" + PECCLE OF A_PERIODE_CTB
          ELSE LET T_PECCLE_SIE10 = "0" + PECCLE OF A_PERIODE_CTB

          IF T_PECCLE_SIE9 < T_PECCLE_SIE10
           THEN LET PECSTUCR OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUCR OF MCPERIODE_CTB = "S"
      ;
      ; Comptes à payer
      ;
      GET A_PERIODE_CTB VIA PECSTUCP USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUCP OF MCPERIODE_CTB = "S"
      ELSE &

         ; Ajustement pour le changement de siècle
         IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
         THEN LET T_PECCLE_SIE12 = "1" + PECCLE OF MCPERIODE_CTB
         ELSE LET T_PECCLE_SIE12 = "0" + PECCLE OF MCPERIODE_CTB

         ; Ajustement pour le changement de siècle
         IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
         THEN LET T_PECCLE_SIE13 = "1" + PECCLE OF A_PERIODE_CTB
         ELSE LET T_PECCLE_SIE13 = "0" + PECCLE OF A_PERIODE_CTB

         IF T_PECCLE_SIE12 < T_PECCLE_SIE13
           THEN LET PECSTUCP OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUCP OF MCPERIODE_CTB = "S"
      ;
      ; Grand Livre.
      ;
      GET A_PERIODE_CTB VIA PECSTUGL USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUGL OF MCPERIODE_CTB = "S"
      ELSE &

      ; Ajustement pour le changement de siècle
      IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
      THEN LET T_PECCLE_SIE14 = "1" + PECCLE OF MCPERIODE_CTB
      ELSE LET T_PECCLE_SIE14 = "0" + PECCLE OF MCPERIODE_CTB

       ; Ajustement pour le changement de siècle
       IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
       THEN LET T_PECCLE_SIE15 = "1" + PECCLE OF A_PERIODE_CTB
       ELSE LET T_PECCLE_SIE15 = "0" + PECCLE OF A_PERIODE_CTB

       IF T_PECCLE_SIE14 < T_PECCLE_SIE15
           THEN LET PECSTUGL OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUGL OF MCPERIODE_CTB = "S"
      ;
      ; Achats et Réceptions
      ;
      GET A_PERIODE_CTB VIA PECSTUAR USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUAR OF MCPERIODE_CTB = "S"
      ELSE &

        ; Ajustement pour le changement de siècle
        IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
        THEN LET T_PECCLE_SIE16 = "1" + PECCLE OF MCPERIODE_CTB
        ELSE LET T_PECCLE_SIE16 = "0" + PECCLE OF MCPERIODE_CTB

        ; Ajustement pour le changement de siècle
        IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
        THEN LET T_PECCLE_SIE17 = "1" + PECCLE OF A_PERIODE_CTB
        ELSE LET T_PECCLE_SIE17 = "0" + PECCLE OF A_PERIODE_CTB

        IF T_PECCLE_SIE16 < T_PECCLE_SIE17
           THEN LET PECSTUAR OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUAR OF MCPERIODE_CTB = "S"
      ;
      ; Inventaire
      ;
      GET A_PERIODE_CTB VIA PECSTUIN USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUIN OF MCPERIODE_CTB = "S"
      ELSE &

       ; Ajustement pour le changement de siècle
       IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
       THEN LET T_PECCLE_SIE18 = "1" + PECCLE OF MCPERIODE_CTB
       ELSE LET T_PECCLE_SIE18 = "0" + PECCLE OF MCPERIODE_CTB

       ; Ajustement pour le changement de siècle
       IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
       THEN LET T_PECCLE_SIE19 = "1" + PECCLE OF A_PERIODE_CTB
       ELSE LET T_PECCLE_SIE19 = "0" + PECCLE OF A_PERIODE_CTB

       IF T_PECCLE_SIE18 < T_PECCLE_SIE19
           THEN LET PECSTUIN OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUIN OF MCPERIODE_CTB = "S"

      ;
      ; Immobilisation.
      ;
      GET A_PERIODE_CTB VIA PECSTUIM USING "C" OPTIONAL
      IF NOT ACCESSOK
      THEN LET PECSTUIM OF MCPERIODE_CTB = "S"
      ELSE &

      ; Ajustement pour le changement de siècle
      IF PECCLE OF MCPERIODE_CTB[1:1] < "8"
      THEN LET T_PECCLE_SIE20 = "1" + PECCLE OF MCPERIODE_CTB
      ELSE LET T_PECCLE_SIE20 = "0" + PECCLE OF MCPERIODE_CTB

      ; Ajustement pour le changement de siècle
      IF PECCLE OF A_PERIODE_CTB[1:1] < "8"
      THEN LET T_PECCLE_SIE21 = "1" + PECCLE OF A_PERIODE_CTB
      ELSE LET T_PECCLE_SIE21 = "0" + PECCLE OF A_PERIODE_CTB

      IF T_PECCLE_SIE20 < T_PECCLE_SIE21
           THEN LET PECSTUIM OF MCPERIODE_CTB = "F"
           ELSE LET PECSTUIM OF MCPERIODE_CTB = "S"

    END
  END

  ;
  ; On vérifi s'il y a eu un changement de statut pour mettre à jour les
  ; statuts de période.
  ;
  IF (T_OLDSTUGL = "C" AND PECSTUGL OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUGL = "F" AND PECSTUGL OF MCPERIODE_CTB = "C") OR &
     (T_OLDSTUCP = "C" AND PECSTUCP OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUCP = "F" AND PECSTUCP OF MCPERIODE_CTB = "C") OR &
     (T_OLDSTUCR = "C" AND PECSTUCR OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUCR = "F" AND PECSTUCR OF MCPERIODE_CTB = "C") OR &
     (T_OLDSTUAR = "C" AND PECSTUAR OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUAR = "F" AND PECSTUAR OF MCPERIODE_CTB = "C") OR &
     (T_OLDSTUIN = "C" AND PECSTUIN OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUIN = "F" AND PECSTUIN OF MCPERIODE_CTB = "C") or &
     (T_OLDSTUIM = "C" AND PECSTUIM OF MCPERIODE_CTB = "F") OR &
     (T_OLDSTUIM = "F" AND PECSTUIM OF MCPERIODE_CTB = "C")

  THEN BEGIN
    ;
    ; Calcul pour avoir le prochain numéro de période, si la séquence de la
    ; période est inférieure au nombre de période défini dans le holding,
    ; alors cela indique qu'on reste dans la même année, sinon c'est un
    ; changement d'année.
    ;
    ; ex: nombre de période = 12
    ;     Si 9210 la suivante est 9211
    ;     si 9212 la suivante est 9301
    ;
    IF HLDNBRPERCTB OF MCHOLDING > NCONVERT(PECCLE OF MCPERIODE_CTB[3:2])
    THEN LET T_PECCLE = PECCLE OF MCPERIODE_CTB[1:2] + &
                        ASCII(NCONVERT(PECCLE OF MCPERIODE_CTB[3:2]) + 1,2)
    ELSE LET T_PECCLE = ASCII(NCONVERT(PECCLE OF MCPERIODE_CTB[1:2]) + 1,3)[2:2] &
                        + "01"
    ;
    ; Lecture de la période suivante.
    ;
    GET A_PERIODE_CTB VIA PECCLE USING T_PECCLE
    ;
    IF T_OLDSTUGL = "C" AND PECSTUGL OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERGL OF MCPERIODE_CTB = SYSDATE
      LET PECSTUGL    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUGL = "F" AND PECSTUGL OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERGL OF MCPERIODE_CTB = 0
      LET PECSTUGL    OF A_PERIODE_CTB = "S"
    END
    ;
    ;
    IF T_OLDSTUCP = "C" AND PECSTUCP OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERCP OF MCPERIODE_CTB = SYSDATE
      LET PECSTUCP    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUCP = "F" AND PECSTUCP OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERCP OF MCPERIODE_CTB = 0
      LET PECSTUCP    OF A_PERIODE_CTB = "S"
    END
    ;
    ;
    IF T_OLDSTUCR = "C" AND PECSTUCR OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERCR OF MCPERIODE_CTB = SYSDATE
      LET PECSTUCR    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUCR = "F" AND PECSTUCR OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERCR OF MCPERIODE_CTB = 0
      LET PECSTUCR    OF A_PERIODE_CTB = "S"
    END
    ;
    ;
    IF T_OLDSTUAR = "C" AND PECSTUAR OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERAR OF MCPERIODE_CTB = SYSDATE
      LET PECSTUAR    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUAR = "F" AND PECSTUAR OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERAR OF MCPERIODE_CTB = 0
      LET PECSTUAR    OF A_PERIODE_CTB = "S"
    END
    ;
    ;
    IF T_OLDSTUIN = "C" AND PECSTUIN OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERIN OF MCPERIODE_CTB = SYSDATE
      LET PECSTUIN    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUIN = "F" AND PECSTUIN OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERIN OF MCPERIODE_CTB = 0
      LET PECSTUIN    OF A_PERIODE_CTB = "S"
    END
    ;
    ;
    IF T_OLDSTUIM = "C" AND PECSTUIM OF MCPERIODE_CTB = "F"
    THEN BEGIN
      ;
      ; La période suivante devient courante.
      ;
      LET PECDATFERIM OF MCPERIODE_CTB = SYSDATE
      LET PECSTUIM    OF A_PERIODE_CTB = "C"
    END
    ;
    IF T_OLDSTUIM = "F" AND PECSTUIM OF MCPERIODE_CTB = "C"
    THEN BEGIN
      ;
      ; La période suivante devient subséquente.
      ;
      LET PECDATFERIM OF MCPERIODE_CTB = 0
      LET PECSTUIM    OF A_PERIODE_CTB = "S"
    END

    PUT A_PERIODE_CTB
  END
  ;
  ; Destruction d'une période comptable.
  ;
  IF DELETEDRECORD OF MCPERIODE_CTB
  THEN BEGIN
    ;
    ; On initialise le flag de retour pour savoir si le sous-écran a
    ; bien fonctionné.
    ;
    LET T_FLGDEL = ""
    ;
    ; Appel du sous-écran qui valide si la période est référée.
    ;
    RUN SCREEN mc012x MODE SAME &
                      PASSING MCPERIODE_CTB , &
                              T_FLGDEL
    ;
    ; Si la valeur de retour égale 1, cela indique que le sous-écran
    ; n'a trouvé aucune référence pour l'identifiant demandé.
    ;
    IF T_FLGDEL = ""
    THEN ERROR " "
  END
END


;-------------------------------------------------------------------------------
;
;
; les 2 etapes suivante sont pour conserver les ancienne valeurs
;
;
PROCEDURE POSTUPDATE
BEGIN
  LET T_OLDSTUGL = PECSTUGL OF MCPERIODE_CTB
  LET T_OLDSTUCP = PECSTUCP OF MCPERIODE_CTB
  LET T_OLDSTUCR = PECSTUCR OF MCPERIODE_CTB
  LET T_OLDSTUAR = PECSTUAR OF MCPERIODE_CTB
  LET T_OLDSTUIN = PECSTUIN OF MCPERIODE_CTB
  LET T_OLDSTUIM = PECSTUIM OF MCPERIODE_CTB
END
;
PROCEDURE POSTFIND
BEGIN
  LET T_OLDSTUGL = PECSTUGL OF MCPERIODE_CTB
  LET T_OLDSTUCP = PECSTUCP OF MCPERIODE_CTB
  LET T_OLDSTUCR = PECSTUCR OF MCPERIODE_CTB
  LET T_OLDSTUAR = PECSTUAR OF MCPERIODE_CTB
  LET T_OLDSTUIN = PECSTUIN OF MCPERIODE_CTB
  LET T_OLDSTUIM = PECSTUIM OF MCPERIODE_CTB
END


;-------------------------------------------------------------------------------
;
;
PROCEDURE DELETE
BEGIN
  IF    PECSTUCR OF MCPERIODE_CTB <> "C" &
    AND PECSTUCP OF MCPERIODE_CTB <> "C" &
    AND PECSTUGL OF MCPERIODE_CTB <> "C" &
    AND PECSTUAR OF MCPERIODE_CTB <> "C" &
    AND PECSTUIN OF MCPERIODE_CTB <> "C" &
    AND PECSTUIM OF MCPERIODE_CTB <> "C"
  THEN BEGIN
    DELETE MCPERIODE_CTB
    DELETE MCPERIODE_CIE
  END
  ELSE ERROR 171 ; Vous ne pouvez pas supprimer une période courante
END


BUILD
@IF FORMAT

xxxx                xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                   x
***************************** Périodes comptables ******************************
* Période ......: xxxxx                                                        *
*                                                                              *
* Régularisation: x                                                            *
*                                                                              *
* Date début....: xxxxxxxx                                                     *
*                                                                              *
* Date fin......: xxxxxxxx                                                     *
********************************************************************************
*     Module              Date Fermeture      Statut                           *
********************************************************************************
*                                                                              *
* Grand Livre                xxxxxxxx            x                             *
* Compte à recevoir          xxxxxxxx            x                             *
* Compte à payer             xxxxxxxx            x                             *
* Achats/Réceptions          xxxxxxxx            x                             *
* Inventaire                 xxxxxxxx            x                             *
* Immobilisation             xxxxxxxx            x                             *
*                                                                              *
*                                                                              *
********************************************************************************
@ENDIF
