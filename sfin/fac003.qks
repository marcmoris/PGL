;/T/ Impression de facture
;
;/P/ Programmeur.....: Éric Brochu
;    Date création...: 1 Février 1996
;    Description.....: Impression de la facture
;
;/M/ François Déry, 6 mai 1999
;       Ajuster l'Affectation du défine d_sigle_cptcle*. Enlever un file qui
;       était en double. Enlver la fonction pour trouver le SYMBOL de USERNAME
;       par LOGONID.
;       Changer le nom physique du fichier séquentielle pour l'impression de la
;       facture pour qu'il soit unique sur unix.
;       Modifier la commande d'impression.
;       Ajout d'un code de retour dans le fichier séquentielle pour qu'il
;       s'imprime comme il le faut.
;
;***********************************************************************************************************************************
;
;/M/ Modifié par.......: Marc Poulin     
;    Date modification.: 06 mars 2000
;    Description.......: Afficher la description associée au type de granit. Tenir compte que la description 3 et 4 sont possibles.
;
;    Référence.........: Demande de changement 000020.
;
;    Signet............: MP-00-03-06_D20.
;
;-----------------------------------------------------------------------------------------------------------------------------------

;/V/ Écran vérifier pour le passage à l'an 2000

SET NESTING 100
SCREEN fac003 MENU

TEMPORARY T_CIECLEMNU         CHARACTER SIZE 04 ;Num. compagnie du menu
TEMPORARY T_FACNUM INTEGER   SIZE 04 ;Num. facture à imprimer

;-------------------------------------------------------------------------------
;
; Définition des éléments de travail.
;
TEMPORARY T_LTRNUMLOT INT SIZE 4
TEMPORARY T_SURFACE_1 FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_SURFACE_2 FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_SURFACE_3 FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_SURFACE_4 FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_SURFACE_5 FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_SURFACE_T FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_NOMBRE_NUM INTEGER SIZE 4

TEMPORARY T_CBIDSC              CHARACTER SIZE 40
TEMPORARY T_SURFACE_M2          FLOAT SIZE 8
TEMPORARY T_FOR                 FLOAT SIZE 8
TEMPORARY T_AJFOR               FLOAT SIZE 8 RESET AT STARTUP
TEMPORARY T_UNM                 CHAR SIZE 2
TEMPORARY T_AJFSUR              FLOAT SIZE 8
TEMPORARY T_AJFVEN                 FLOAT SIZE 8
TEMPORARY T_VENPRIX FLOAT SIZE 8
TEMPORARY T_TOT_VENPRIX FLOAT SIZE 8
TEMPORARY T_T FLOAT SIZE 8
TEMPORARY T_SOMPRIX FLOAT SIZE 8
TEMPORARY T_AJFVEN001              FLOAT SIZE 8
TEMPORARY T_AJFVEN002              FLOAT SIZE 8
TEMPORARY T_AJFVEN003              FLOAT SIZE 8
TEMPORARY T_AJFVEN004              FLOAT SIZE 8
TEMPORARY T_AJFVEN005              FLOAT SIZE 8
TEMPORARY T_NBRE_CPTCLE_AUTRE   INTEGER  SIZE 2
TEMPORARY T_NBRE_CPTCLE_FRAIS   INTEGER  SIZE 2
TEMPORARY T_NBRE_CPTCLE         INTEGER  SIZE 2

TEMPORARY T_CPTCLETRPTER        CHARACTER SIZE 6
TEMPORARY T_UNACLETRPTER        CHARACTER SIZE 8
TEMPORARY T_STTTRPTER           FLOAT SIZE 8

TEMPORARY T_CPTCLETRPMER        CHARACTER SIZE 6
TEMPORARY T_UNACLETRPMER        CHARACTER SIZE 8
TEMPORARY T_STTTRPMER           FLOAT SIZE 8

TEMPORARY T_CPTCLECOU           CHARACTER SIZE 6
TEMPORARY T_UNACLECOU           CHARACTER SIZE 6
TEMPORARY T_STTCOUR             FLOAT SIZE 8

TEMPORARY T_BLANC               CHARACTER SIZE 132
TEMPORARY T_CMD                 CHARACTER SIZE 255  ;Commande du système d'exploitation
TEMPORARY T_FICPRT              CHARACTER SIZE 40   RESET AT STARTUP
TEMPORARY T_MAX_LIGNE           INTEGER   SIZE 2    RESET AT STARTUP
TEMPORARY T_MIN_PAG_FOO         INTEGER   SIZE 2    RESET AT STARTUP
TEMPORARY T_NB_LIGNE            INTEGER   SIZE 2
TEMPORARY T_NB_PAGE             INTEGER   SIZE 2
TEMPORARY T_TYP_GRA             CHARACTER SIZE 20
TEMPORARY T_TYP_FIN             CHARACTER SIZE 20
TEMPORARY T_EPAI                CHARACTER SIZE 7
TEMPORARY T_HAUT                CHARACTER SIZE 7
TEMPORARY T_LONG                CHARACTER SIZE 7
TEMPORARY T_SUR_VEN             CHARACTER SIZE 15
TEMPORARY T_PRI_VEN             CHARACTER SIZE 12
TEMPORARY T_UNI_VEN             CHARACTER SIZE 2
TEMPORARY T_TOT_VEN             CHARACTER SIZE 16
TEMPORARY T_DETAIL              CHARACTER SIZE 53
TEMPORARY T_IMPLIGDET           INTEGER   SIZE 2

TEMPORARY T_CTRPIE              INTEGER   SIZE 04
TEMPORARY T_MNTTOT              FLOAT     SIZE 08
TEMPORARY T_PREMIER_MONTANT     FLOAT     SIZE 08
TEMPORARY T_MNTTOTAL            FLOAT     SIZE 08
TEMPORARY T_SURFACE             FLOAT     SIZE 08
TEMPORARY T_SURFACE_MNT         FLOAT     SIZE 08

TEMPORARY T_TAXPCTTPS           FLOAT     SIZE 4  ; % Taxe TPS
TEMPORARY T_TAXPCTTVQ           FLOAT     SIZE 4  ; % Taxe TVQ

;
; Variable pour les lignes de détails
;
TEMPORARY T_TGRCODGRA           CHARACTER SIZE 03
TEMPORARY T_TGRDSC              CHARACTER SIZE 40
TEMPORARY T_TYFCODFIN           CHARACTER SIZE 02
TEMPORARY T_TYFDSC              CHARACTER SIZE 40
TEMPORARY T_TPDTYPPRD           CHARACTER SIZE 02
TEMPORARY T_DCIUNMVEN           CHARACTER SIZE 02
TEMPORARY T_DCIPRIVEN           FLOAT SIZE 8
TEMPORARY T_CLILNG              CHARACTER SIZE 1
;
; Variables temporaire pour l'entete ligne 3
;
TEMPORARY T_FACNUMFAC           CHARACTER SIZE 07 ; Num. facture
TEMPORARY T_FACNUMDEB           INT SIZE 04 ; Num. facture DEBUT
TEMPORARY T_FACNUMFIN           INT SIZE 04 ; Num. facture FIN
;
; Variables temporaire pour l'entete ligne 6
;
TEMPORARY T_COMNUMCOM           CHARACTER SIZE 7  ; Num commande
TEMPORARY T_COMNOM              CHARACTER SIZE 40 ; commande
TEMPORARY T_COMNUMCMD           CHARACTER SIZE 40 ; Num commande client
TEMPORARY T_CLICLE              CHARACTER SIZE 06 ; Num. client
TEMPORARY T_NUMBONLIV           CHARACTER SIZE 12 ; Num. bon livraison
TEMPORARY T_BLINUMBLI           CHARACTER SIZE 2  ; Num. bon commande
TEMPORARY T_EXPNUMEXP           INTEGER   SIZE 4  ; Num expédition
TEMPORARY T_FACDATFAC           CHARACTER SIZE 10 ; Date facture
;
; Variables temporaire pour l'entete ligne 9
;
TEMPORARY T_PJTNUMPRO           CHARACTER SIZE 09 ; Num. projet
TEMPORARY T_COMFRSCOUINC        CHARACTER SIZE 40 ; Frais de courtage
;
; Variables temporaire pour l'entete ligne 10
;
TEMPORARY T_PJTNOM              CHARACTER SIZE 40 ; Nom projet
;
; Variables temporaire pour l'entete ligne 12
;
TEMPORARY T_COLCODLIV           CHARACTER SIZE 03 ; Code de condition de livraison
TEMPORARY T_COMCOMLIV           CHARACTER SIZE 40 ; Précision sur la livraison
TEMPORARY T_COMLIV              CHARACTER SIZE 40
;
; Variables temporaire pour l'entete ligne 13
;
TEMPORARY T_ADRFAC001           CHARACTER SIZE 40 ; Adresse fact. 001
TEMPORARY T_ADRLIV001           CHARACTER SIZE 40 ; Adresse livr. 001
TEMPORARY T_CODLIVDSC           CHARACTER SIZE 25 ; Desc. code liv.
;
; Variables temporaire pour l'entete ligne 14
;
TEMPORARY T_ADRFAC002           CHARACTER SIZE 40 ; Adresse fact. 002
TEMPORARY T_ADRLIV002           CHARACTER SIZE 40 ; Adresse livr. 002
TEMPORARY T_VIA                 CHARACTER SIZE 40 ; Nom du transporteur
;
; Variables temporaire pour l'entete ligne 15
;
TEMPORARY T_ADRFAC003           CHARACTER SIZE 40 ; Adresse fact. 003
TEMPORARY T_ADRLIV003           CHARACTER SIZE 40 ; Adresse livr. 003
;
; Variables temporaire pour l'entete ligne 16
;
TEMPORARY T_ADRFAC004           CHARACTER SIZE 40 ; Adresse fact. 004
TEMPORARY T_ADRLIV004           CHARACTER SIZE 40 ; Adresse livr. 004
;
; Variables temporaire pour l'entete ligne 17
;
TEMPORARY T_ADRFAC005           CHARACTER SIZE 40 ; Adresse fact. 005
TEMPORARY T_ADRLIV005           CHARACTER SIZE 40 ; Adresse livr. 005
TEMPORARY T_TAXTPS              CHARACTER SIZE 25 ; Taxe TPS
;
; Variables temporaire pour l'entete ligne 18
;
TEMPORARY T_ADRFAC006           CHARACTER SIZE 40 ; Adresse fact. 006
TEMPORARY T_ADRLIV006           CHARACTER SIZE 40 ; Adresse livr. 006
TEMPORARY T_TAXTVQ              CHARACTER SIZE 25 ; Taxe TVQ
;
; Détail de la facture
;
TEMPORARY T_NOMBRE              CHARACTER SIZE 06 ;
TEMPORARY T_TYPE                CHARACTER SIZE 03 ;
TEMPORARY T_TYPE2               CHARACTER SIZE 05 ;
TEMPORARY T_DESCRIPTION         CHARACTER SIZE 53 ;
TEMPORARY T_QTE                 CHARACTER SIZE 15 ;
TEMPORARY T_PRIX                CHARACTER SIZE 12 ;
TEMPORARY T_UN                  CHARACTER SIZE 02 ;
TEMPORARY T_MONTANT             CHARACTER SIZE 16 ;
;
; En bas ligne 44
;
TEMPORARY T_STT001              CHARACTER SIZE 18 ; Sous-total avant frais
TEMPORARY T_STTCOU              CHARACTER SIZE 12 ; Courtage
TEMPORARY T_STTTRP              CHARACTER SIZE 12 ; Transport
TEMPORARY T_STT002              CHARACTER SIZE 18 ; Sout-total
TEMPORARY T_PCTTPS              CHARACTER SIZE 06 ; Pourcent. TPS
TEMPORARY T_NUMTPS              CHARACTER SIZE 12 ; Mnt Taxe TPS
TEMPORARY T_PCTTVQ              CHARACTER SIZE 06 ; Pourcent. TVQ
TEMPORARY T_NUMTVQ              CHARACTER SIZE 12 ; MNT. TVQ
TEMPORARY T_TOTDEVCLI           CHARACTER SIZE 18 ; total devise client
;
; En bas ligne 45
;
TEMPORARY T_TMEDSC              CHARACTER SIZE 40 ; Conditions de paiement
TEMPORARY T_DEVTAU              FLOAT     SIZE 8  ; Devise client
TEMPORARY T_DEVDESC             CHARACTER SIZE 15 ; Description Devise client
;
; En bas ligne 46
;
TEMPORARY T_CONPAI001           CHARACTER SIZE 99 ; Condition de paiement
TEMPORARY T_CPTCLE001           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE001           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT001           FLOAT SIZE 8      ; Montant
TEMPORARY T_CPTCLE005           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE005           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT005           FLOAT SIZE 8      ; Montant
;
; En bas ligne 47
;
TEMPORARY T_CONPAI002           CHARACTER SIZE 99 ; Condition de paiement
TEMPORARY T_CPTCLE002           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE002           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT002           FLOAT SIZE 8      ; Montant
TEMPORARY T_CPTCLE006           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE006           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT006           FLOAT SIZE 8      ; Montant
;
; En bas ligne 48
;
TEMPORARY T_CPTCLE003           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE003           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT003           FLOAT SIZE 8      ; Montant
TEMPORARY T_CPTCLE007           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE007           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT007           FLOAT SIZE 8      ; Montant
;
; En bas ligne 49
;
TEMPORARY T_CPTCLE004           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE004           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT004           FLOAT SIZE 8      ; Montant
TEMPORARY T_CPTCLE008           CHARACTER SIZE 06 ; Num. compte
TEMPORARY T_UNACLE008           CHARACTER SIZE 08 ; Unité adm.
TEMPORARY T_MNTVNT008           FLOAT SIZE 8      ; Montant
TEMPORARY T_PAGE_1              CHARACTER SIZE 23 ; Page

TEMPORARY T_VENPRIUNI   FLOAT SIZE 8 INIT 0
TEMPORARY T_SURFACE_OLD FLOAT SIZE 8 INIT 0
TEMPORARY T_FLAG_AJFOR      CHARACTER SIZE 1 INIT  "N"

DEFINE D_SIGLE_UNACLE001 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE001)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE002 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE002)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE003 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE003)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE004 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE004)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE005 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE005)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE006 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE006)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE007 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE007)) &
                        ELSE " "
DEFINE D_SIGLE_UNACLE008 CHARACTER SIZE 1 = "-" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE008)) &
                        ELSE " "


DEFINE D_SIGLE_CPTCLE001 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE001)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE002 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE002)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE003 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE003)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE004 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE004)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE005 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE005)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE006 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE006)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE007 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE007)) &
                        ELSE " "
DEFINE D_SIGLE_CPTCLE008 CHARACTER SIZE 1 = ":" &
                        IF 0 <> SIZE(TRUNCATE(T_UNACLE008)) &
                        ELSE " "

;-------------------------------------------------------------------------------
;
; Déclaration des fichiers
;
TEMPORARY T_RETURN INTEGER SIZE 1 INITIAL 10 ; Code ascii pour un <return>

FILE PDIMPRIM_DOC                  DESIGNER
  ITEM PDIFLGRET OF PDIMPRIM_DOC FINAL CHAR( T_RETURN )
                                   ;Fichier séquentiel
                                   ;pour la création du document

FILE PDFACTURE                     DESIGNER
                                   ;Fichier principal de la facture
FILE PDLOT_FACTURE                 DESIGNER

FILE PDCOMMAN_INTERNE              DESIGNER
                                   ;Fichier principal pour commande interne


FILE PDTRANCHE                     DESIGNER

FILE PDEMBAL_TRANCHE               DESIGNER

FILE PDFAC_IMPUTATION              DESIGNER

FILE PDCAISSON                     DESIGNER

FILE PDLIVRE_CAISSON               DESIGNER

FILE PDBON_LIVRAISON               DESIGNER

FILE PDTRANCHE_FAC                 DESIGNER

FILE PDPROD_FACTURE                DESIGNER

;FILE PDPROD_DIMENSION              DESIGNER

FILE PDBLOC_FACTURE                DESIGNER

FILE PDBLOC                        DESIGNER

FILE PDCOMMEN_TRANCHE              DESIGNER

FILE PDCOMMEN_PROD                 DESIGNER

FILE PDCOMMEN_BLOC                 DESIGNER

FILE PDDETAIL_C_I                  DESIGNER

FILE PDDIAGRAMME                   DESIGNER

FILE PDEMBAL_DIAG                  DESIGNER

FILE PDTYPE_GRANIT                 DESIGNER

FILE PDTYPE_FINI                   DESIGNER

FILE PDCONVERT_UN_M                DESIGNER

FILE VEXPDIA                       DESIGNER

FILE VEXPTRA                       DESIGNER

FILE PDEMBAL_PROD_DIM              DESIGNER

FILE PDCOM_FACTURE                 DESIGNER

FILE PDTRANP_DOU_ECT               DESIGNER

FILE PDCHARGES_DIVERS              DESIGNER

FILE PDVENTILATION                 DESIGNER
;
; Recherche de l'imprimante, la forme
;
FILE VXPRIMP          DESIGNER
  ACCESS VIA   XPRNOM, &
               USRCLE  &
         USING "PD805", &
               LOGONID

;-------------------------------------------------------------------------------
;
; Variable de travail
;

DEFINE D_FLAG_LIGNE             ZONED SIZE 1 &
        = 1 &
          IF T_NB_LIGNE >= ((T_MAX_LIGNE - 1) - T_MIN_PAG_FOO ) &
          ELSE 0


;-------------------------------------------------------------------------------
;
; Définition d'un champ qui éditera un champ d'un maximum de 9 chiffres dans
; une chaine de treize caractères
;

;TEMPORARY T_ED_MO_1                     ZONED SIZE 9
TEMPORARY T_ED_MO_1                     FLOAT SIZE 8

DEFINE D_ZE_1                           CHARACTER SIZE 14 &
     =    ASCII(ABS(T_ED_MO_1 * 100))

DEFINE D_ZE_MO_1                        CHARACTER SIZE 14 &
     =    D_ZE_1 &
          IF 3 <= SIZE(TRUNCATE(D_ZE_1)) &
     ELSE PACK("0" + D_ZE_1) &
          IF 2 = SIZE(TRUNCATE(D_ZE_1)) &
     ELSE PACK("00" + D_ZE_1) &
          IF 1 = SIZE(TRUNCATE(D_ZE_1)) &
     ELSE "000"

DEFINE D_MO_1                           CHARACTER SIZE 15 &
     =    RJ(D_ZE_MO_1)

DEFINE D_MO_2_1                         CHARACTER SIZE 16 &
     =       D_MO_1 + " "  &
          IF T_ED_MO_1 >= 0 &
     ELSE    D_MO_1 + "-"

;     123456789-
;  1234567890123
;  1,234,567.89_

DEFINE D_EDIT_1                         CHARACTER SIZE 16 &
     =    D_MO_2_1[4:1] &
          + "," &
          + D_MO_2_1[5:3] &
          + "," &
          + D_MO_2_1[8:3] &
          + "." + D_MO_2_1[11:2] &
          + D_MO_2_1[15:2] &            ;----TEST
          IF D_MO_2_1[4:1] <> " " &
     ELSE D_MO_2_1[4:1] &
          + " " &
          + D_MO_2_1[5:3] &
          + "," &
          + D_MO_2_1[8:3] &
          + "." + D_MO_2_1[11:2] &
          + D_MO_2_1[15:2] &            ;----TEST
          IF D_MO_2_1[7:1] <> " " &
     ELSE D_MO_2_1[4:1] &
          + " " &
          + D_MO_2_1[5:3] &
          + " " &
          + D_MO_2_1[8:3] &
          + "." + D_MO_2_1[11:2] &
          + D_MO_2_1[15:2] &            ;----TEST
          IF D_MO_2_1[10:1] <> " " &
     ELSE "       0." + D_MO_2_1[11:2] &
          + D_MO_2_1[15:2] &            ;----TEST
          IF D_MO_2_1[11:1]<> " " &
     ELSE "                "
;-------------------------------------------------------------------------------
;
; Définition d'un champ qui éditera un champ d'un maximum de 9 chiffres dans
; une chaine de treize caractères
;

TEMPORARY T_ED_MO_2                     FLOAT SIZE 8

DEFINE D_ZE_2                           CHARACTER SIZE 14 &
     =    ASCII(ABS(T_ED_MO_2 * 100))

DEFINE D_ZE_MO_2                        CHARACTER SIZE 14 &
     =    D_ZE_2 &
          IF 3 <= SIZE(TRUNCATE(D_ZE_2)) &
     ELSE PACK("0" + D_ZE_2) &
          IF 2 = SIZE(TRUNCATE(D_ZE_2)) &
     ELSE PACK("00" + D_ZE_2) &
          IF 1 = SIZE(TRUNCATE(D_ZE_2)) &
     ELSE "000"

DEFINE D_MO_2                           CHARACTER SIZE 15 &
     =    RJ(D_ZE_MO_2)

DEFINE D_MO_2_2                         CHARACTER SIZE 16 &
     =       D_MO_2 + " "  &
          IF T_ED_MO_2 >= 0 &
     ELSE    D_MO_2 + "-"

;     123456789-
;  1234567890123
;  1,234,567.89_

DEFINE D_EDIT_2                         CHARACTER SIZE 16 &
     =    D_MO_2_2[4:1] &
          + "," &
          + D_MO_2_2[5:3] &
          + "," &
          + D_MO_2_2[8:3] &
          + "." + D_MO_2_2[11:2] &
          + D_MO_2_2[15:2] &            ;----TEST
          IF D_MO_2_2[4:1] <> " " &
     ELSE D_MO_2_2[4:1] &
          + " " &
          + D_MO_2_2[5:3] &
          + "," &
          + D_MO_2_2[8:3] &
          + "." + D_MO_2_2[11:2] &
          + D_MO_2_2[15:2] &            ;----TEST
          IF D_MO_2_2[7:1] <> " " &
     ELSE D_MO_2_2[4:1] &
          + " " &
          + D_MO_2_2[5:3] &
          + " " &
          + D_MO_2_2[8:3] &
          + "." + D_MO_2_2[11:2] &
          + D_MO_2_2[15:2] &            ;----TEST
          IF D_MO_2_2[10:1] <> " " &
     ELSE "       0." + D_MO_2_2[11:2] &
          + D_MO_2_2[15:2] &            ;----TEST
          IF D_MO_2_2[11:1]<> " " &
     ELSE "                "

;-------------------------------------------------------------------------------
;
; Définition d'un champ qui éditera un champ d'un maximum de 9 chiffres dans
; une chaine de treize caractères
;

TEMPORARY T_ED_MO_3                     FLOAT SIZE 8

DEFINE D_ZE_3                           CHARACTER SIZE 14 &
     =    ASCII(ABS(T_ED_MO_3 * 100))

DEFINE D_ZE_MO_3                        CHARACTER SIZE 14 &
     =    D_ZE_3 &
          IF 3 <= SIZE(TRUNCATE(D_ZE_3)) &
     ELSE PACK("0" + D_ZE_3) &
          IF 2 = SIZE(TRUNCATE(D_ZE_3)) &
     ELSE PACK("00" + D_ZE_3) &
          IF 1 = SIZE(TRUNCATE(D_ZE_3)) &
     ELSE "000"

DEFINE D_MO_3                           CHARACTER SIZE 15 &
     =    RJ(D_ZE_MO_3)

DEFINE D_MO_2_3                         CHARACTER SIZE 16 &
     =       D_MO_3 + " "  &
          IF T_ED_MO_3 >= 0 &
     ELSE    D_MO_3 + "-"

;     123456789-
;  1234567890123
;  1,234,567.89_

DEFINE D_EDIT_3                         CHARACTER SIZE 16 &
     =    D_MO_2_3[4:1] &
          + "," &
          + D_MO_2_3[5:3] &
          + "," &
          + D_MO_2_3[8:3] &
          + "." + D_MO_2_3[11:2] &
          + D_MO_2_3[15:2] &            ;----TEST
          IF D_MO_2_3[4:1] <> " " &
     ELSE D_MO_2_3[4:1] &
          + " " &
          + D_MO_2_3[5:3] &
          + "," &
          + D_MO_2_3[8:3] &
          + "." + D_MO_2_3[11:2] &
          + D_MO_2_3[15:2] &            ;----TEST
          IF D_MO_2_3[7:1] <> " " &
     ELSE D_MO_2_3[4:1] &
          + " " &
          + D_MO_2_3[5:3] &
          + " " &
          + D_MO_2_3[8:3] &
          + "." + D_MO_2_3[11:2] &
          + D_MO_2_3[15:2] &            ;----TEST
          IF D_MO_2_3[10:1] <> " " &
     ELSE "       0." + D_MO_2_3[11:2] &
          + D_MO_2_3[15:2] &            ;----TEST
          IF D_MO_2_3[11:1]<> " " &
     ELSE "                "

;D_MO_2_3[4:1] &
;          + " " &
;          + D_MO_2_3[5:3] &
;          + " " &
;          + D_MO_2_3[8:3] &
;          + "   "



;-------------------------------------------------------------------------------
;
; Définition d'un champ qui éditera un champ pour la les surface et les volumes
; d'un maximum de 8 chiffres dans une chaine de onze caractères
;

TEMPORARY T_ED_SU_1             FLOAT SIZE 08

DEFINE D_ED_SU_1                INTEGER SIZE 8 = ROUND (T_ED_SU_1,4)

DEFINE D_ZE_SU                        CHARACTER SIZE 14 &
     =    ASCII(ABS(T_ED_SU_1 * 100000))

DEFINE D_ZE_SU_1                      CHARACTER SIZE 14 &
     =    D_ZE_SU &
          IF 3 <= SIZE(TRUNCATE(D_ZE_SU)) &
     ELSE PACK("0" + D_ZE_SU) &
          IF 2 = SIZE(TRUNCATE(D_ZE_SU)) &
     ELSE PACK("00" + D_ZE_SU) &
          IF 1 = SIZE(TRUNCATE(D_ZE_SU)) &
     ELSE "000"


DEFINE D_SU_1                           CHARACTER SIZE 15 &
     =    RJ(D_ZE_SU_1)


DEFINE D_SU_2_1                         CHARACTER SIZE 16 &
     =    D_SU_1 + " "  &
          IF T_ED_SU_1 >= 0 &
     ELSE D_SU_1 + "-"

; 00123456789-
;1234567890123
;012,345.6789_

DEFINE D_EDIT_SU_1                      CHARACTER SIZE 16 &
     =    D_SU_2_1[4:2] &
          + "," &
          + D_SU_2_1[6:3] &
          + "." &
          + D_SU_2_1[9:4] &
          IF D_SU_2_1[6:1] <> " " &
     ELSE D_SU_2_1[4:3] &
          + " " &
          + D_SU_2_1[6:3] &
          + "." &
          + D_SU_2_1[9:4]
;----------------------------------------------------------------------------
SKIP TO LINE 3
TITLE &
      "Impression des factures " &
      CENTERED AT ,1

USE ustitoff  NOLIST

SKIP TO LINE 4

ALIGN (2,5,21)
FIELD T_CIECLEMNU &
  LABEL "Organisme.....:"
FIELD T_FACNUMDEB &
  LABEL "Facture.......:"
FIELD T_FACNUMFIN &
  LABEL "Facture.......:"

;-------------------------------------------------------------------------------
;
; Préparation du fichier d'impression.
;

PROCEDURE INTERNAL PREPARATION_FICHIER_PRT
BEGIN

  LET T_FICPRT = "PG_TEMP:FAC003" &
               + "_" &
               + TRUNCATE ( LOGONID ) & ;Nom de l'usager
               + "_" &
               + ASCII(SYSDATE)[3:6] &
               + "_" &
               + ASCII((SYSTIME/100),6) &
               + ".PRT"

  ;
  ; Assignation du fichier de commande
  ;   INFO = "MESSAGE " NOW RES

  LET T_CMD = 'echo "create file pdimprim_doc" | qutil'
  RUN COMMAND T_CMD

END


;-------------------------------------------------------------------------------
;
; Initialide les variables pour le traitement
;

PROCEDURE INTERNAL INITTIAL_VAR
BEGIN
  LET T_FACNUMFAC           = " "
  LET T_COMNOM              = " "
  LET T_CLICLE              = " "
  LET T_NUMBONLIV           = " "
  LET T_FACDATFAC           = " "
  LET T_PJTNUMPRO           = " "
  LET T_COMFRSCOUINC        = " "
  LET T_PJTNOM              = " "
  LET T_COLCODLIV           = " "
  LET T_COMCOMLIV           = " "
  LET T_ADRFAC001           = " "
  LET T_ADRLIV001           = " "
  LET T_ADRFAC002           = " "
  LET T_ADRLIV002           = " "
  LET T_VIA                 = " "
  LET T_ADRFAC003           = " "
  LET T_ADRLIV003           = " "
  LET T_ADRFAC004           = " "
  LET T_ADRLIV004           = " "
  LET T_ADRFAC005           = " "
  LET T_ADRLIV005           = " "
  LET T_TAXTPS              = " "
  LET T_ADRFAC006           = " "
  LET T_ADRLIV006           = " "
  LET T_TAXTVQ              = " "

  LET T_STT001              = " "
  LET T_STTCOU              = " "
  LET T_STTTRP              = " "
  LET T_STT002              = " "
  LET T_PCTTPS              = " "
  LET T_NUMTPS              = " "
  LET T_PCTTVQ              = " "
  LET T_NUMTVQ              = " "
  LET T_TOTDEVCLI           = " "
  LET T_DEVDESC             = " "

  LET T_CONPAI001           = " "
  LET T_CPTCLE001           = " "
  LET T_UNACLE001           = " "
  LET T_CPTCLE005           = " "
  LET T_UNACLE005           = " "
  LET T_CONPAI001           = " "
  LET T_CPTCLE002           = " "
  LET T_UNACLE002           = " "
  LET T_CPTCLE006           = " "
  LET T_UNACLE006           = " "
  LET T_CPTCLE003           = " "
  LET T_UNACLE003           = " "
  LET T_CPTCLE007           = " "
  LET T_UNACLE007           = " "
  LET T_CPTCLE004           = " "
  LET T_UNACLE004           = " "
  LET T_CPTCLE008           = " "
  LET T_UNACLE008           = " "
  LET T_PAGE_1              = " "

END


;-------------------------------------------------------------------------------
;
; Lecture des tables
;
PROCEDURE INTERNAL LIRE_FICHIER
BEGIN

  IF FTRTYPFAC OF PDFACTURE = "C"
  THEN BEGIN
    ;
    ; Lecture commande interne
    ;
    GET PDCOMMAN_INTERNE OPTIONAL               &
      VIA   CIECLE,                             &
            COMNUMCOM                           &
      USING CIECLE    OF PDFACTURE,             &
            COMNUMCOM OF PDFACTURE

    IF ACCESSOK
    THEN BEGIN
      LET T_COMNUMCMD    = COMNUMCMD    OF PDCOMMAN_INTERNE
      LET T_COMNUMCOM    = COMNUMCOM    OF PDCOMMAN_INTERNE
      LET T_COMNOM       = COMNOM       OF PDCOMMAN_INTERNE
      LET T_COMCOMLIV    = COMCOMLIV    OF PDCOMMAN_INTERNE
      LET T_COLCODLIV    = PLVCODLIV    OF PDCOMMAN_INTERNE
    END
  END
  ELSE BEGIN
      LET T_COMNOM       = CENTER("Vente Direct")
      LET T_COMCOMLIV    = ""
      LET T_COLCODLIV    = ""
  END
  RUN SCREEN fac001a MODE F PASSING  &
                              PDFACTURE,              &
                              PDCOMMAN_INTERNE,       &
                              T_TMEDSC,               &
                              T_CBIDSC,               &
                              T_ADRFAC001,            &
                              T_ADRFAC002,            &
                              T_ADRFAC003,            &
                              T_ADRFAC004,            &
                              T_ADRFAC005,            &
                              T_ADRFAC006,            &
                              T_ADRLIV001,            &
                              T_ADRLIV002,            &
                              T_ADRLIV003,            &
                              T_ADRLIV004,            &
                              T_ADRLIV005,            &
                              T_ADRLIV006,            &
                              T_COMFRSCOUINC,         &
                              T_CODLIVDSC,            &
                              T_PJTNUMPRO,            &
                              T_PJTNOM,               &
                              T_NUMBONLIV,            &
                              T_VIA,                  &
                              T_CLILNG,               &
                              T_TAXTPS,               &
                              T_TAXTVQ,               &
                              T_TAXPCTTPS,            &
                              T_TAXPCTTVQ,            &
                              T_DEVTAU,               &
                              T_DEVDESC,              &
                              T_BLINUMBLI,            &
                              T_EXPNUMEXP
END


;-------------------------------------------------------------------------------
;
; Procédure qui permettra d'imprimer des lignes blanches
; et ainsi forcer un saut de page
;

PROCEDURE INTERNAL IMPRIME_FIN_PAGE
BEGIN
  LET IMPLIG          = "X"
  LET IMPLIG          = " "
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  IF D_FLAG_LIGNE <> 1
  THEN BEGIN
    DO INTERNAL IMPRIME_FIN_PAGE
  END
;  IF T_NB_LIGNE < T_MAX_LIGNE
;  THEN BEGIN
;    DO INTERNAL IMPRIME_FIN_PAGE
;  END
END


;-------------------------------------------------------------------------------
;
; Procédure pour créer l'entête de la facture
;

PROCEDURE INTERNAL IMPRIME_ENTETE
BEGIN
  ;
  ; Si le numéro de page n'est pas à zero, il faudra imprimer des lignes
  ; blanches pour éffectuer un saut de page
  ;
;  IF T_NB_PAGE <> 0
;  THEN BEGIN
;    LET T_NB_LIGNE = T_NB_LIGNE + 1
;    DO INTERNAL IMPRIME_FIN_PAGE
;  END
  ;
  ; 1 LIGNE ENTETE (BLANCHE)
  ;
;  LET IMPLIG     = "X"
;  LET IMPLIG     = T_BLANC[1:132]
;  LET T_NB_LIGNE = T_NB_LIGNE + 1
;  PUT PDIMPRIM_DOC RESET
  ;
  ; 2 LIGNE ENTETE (BLANCHE)
  ;
;  LET IMPLIG     = "X"
;  LET IMPLIG     = T_BLANC[1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 3
  LET T_NB_PAGE  = T_NB_PAGE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 3 LIGNE ENTETE
  ;
  LET IMPLIG     = T_BLANC[1:117] &
                   + T_FACNUMFAC
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 4 LIGNE ENTETE (BLANCHE)
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 5 LIGNE ENTETE (BLANCHE)
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 6 LIGNE ENTETE
  ;
  LET IMPLIG     = T_BLANC [1:45] &
                   + T_COMNUMCMD &
                   + "    " &
                   + T_CLICLE &
                   + "      "&
                   + T_NUMBONLIV &
                   + "    " &
                   + T_FACDATFAC
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 7 LIGNE ENTETE (BLANCHE)
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 8 LINGE ENTETE (BLANCHE)
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET

  IF FTRTYPFAC OF PDFACTURE = "C"
  THEN BEGIN
    ;
    ; 9 LIGNE ENTETE
    ;
    LET IMPLIG     = T_BLANC [1:45] &
                     + T_COMNUMCOM &
                     + T_BLANC [1:35] &
                     + T_COMFRSCOUINC
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
    ;
    ; 10 LIGNE ENTETE
    ;
    LET IMPLIG     = T_BLANC [1:45] &
                     + T_COMNOM
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
  END
  ELSE BEGIN
    ;
    ; 09 LIGNE ENTETE
    ;
    LET IMPLIG     = "X"
    LET IMPLIG     = T_BLANC [1:132]
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
    ;
    ; 10 LIGNE ENTETE
    ;
    LET IMPLIG     = "X"
    LET IMPLIG     = T_BLANC [1:132]
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
  END
  ;
  ; 11 LIGNE ENTETE
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET

  IF FTRTYPFAC OF PDFACTURE = "C"
  THEN BEGIN
    ;
    ; 12 LIGNE ENTETE
    ;
      LET IMPLIG     = T_BLANC [1:89] &
                     + T_COLCODLIV + " : " + T_CBIDSC[1:33]
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
  END
  ELSE BEGIN
    ;
    ; 12 LIGNE ENTETE
    ;
    LET IMPLIG     = "X"
    LET IMPLIG     = T_BLANC [1:132]
    LET T_NB_LIGNE = T_NB_LIGNE + 1
    PUT PDIMPRIM_DOC RESET
  END
  ;
  ; 13 LIGNE ENTETE
  ;
  LET IMPLIG = "  " &
               + T_ADRFAC001 &
               + "   " &
               + T_ADRLIV001 &
               + "    "&
               + T_COMCOMLIV
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 14 LIGNE ENTETE
  ;
  LET IMPLIG   = "  " &
                 + T_ADRFAC002 &
                 + "   " &
                 + T_ADRLIV002 &
                 + "         " &
                 + T_VIA    ;      T_COMCOMLIV
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 15 LIGNE ENTETE
  ;
  LET IMPLIG     = "  " &
                     + T_ADRFAC003 &
                     + "   " &
                     + T_ADRLIV003
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 16 LIGNE ENTETE
  ;
  LET IMPLIG    = "  " &
                  + T_ADRFAC004 &
                  + "   " &
                  + T_ADRLIV004
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 17 LIGNE ENTETE
  ;
  LET IMPLIG      = "  " &
                    + T_ADRFAC005 &
                    + "   " &
                    + T_ADRLIV005 &
                    + "    " &
                    + T_TAXTPS
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 18 LIGNE ENTETE
  ;
  LET IMPLIG        = "  " &
                    + T_ADRFAC006 &
                    + "   " &
                    + T_ADRLIV006 &
                    + "    " &
                    + T_TAXTVQ
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 19 LIGNE ENTETE
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  ;
  ; 20 LIGNE ENTETE
  ;
  LET IMPLIG     = "X"
  LET IMPLIG     = T_BLANC [1:132]
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
END

;-------------------------------------------------------------------------------
;
; Init. des variables pour l'impression d'une ligne de détail de la facture
;
PROCEDURE INTERNAL INIT_LIGNE_DETAIL
BEGIN
  LET T_NOMBRE              = " "
  LET T_TYPE                = " "
  LET T_DESCRIPTION         = " "
  LET T_QTE                 = " "
  LET T_PRIX                = " "
  LET T_UN                  = " "
  LET T_MONTANT             = " "
END

;-------------------------------------------------------------------------------
;
; Init. des variables pour l'impression d'une ligne de détail de la facture
;
PROCEDURE INTERNAL INIT_LIGNE_DETAIL2
BEGIN
  LET T_NOMBRE              = " "
  LET T_TYPE2               = " "
  LET T_DETAIL              = " "
  LET T_SUR_VEN             = " "
  LET T_PRI_VEN             = " "
  LET T_UNI_VEN             = " "
  LET T_TOT_VEN             = " "
END

;-------------------------------------------------------------------------------
;
;
;PROCEDURE INTERNAL IMPRIM_BLANC
;BEGIN
;  LET IMPLIG    = "X"
;  LET IMPLIG    = " "
;  PUT PDIMPRIM_DOC RESET
;
;  LET T_NB_LIGNE = T_NB_LIGNE + 1
;  LET T_TEMP_A = T_MAX_LIGNE - T_MIN_PAGE_FOO
;  IF T_NB_LIGNE < T_TEMP_A
;  THEN BEGIN
;    DO INTERNAL IMPRIME_BLANC
;  END
;END

PROCEDURE INTERNAL AJOUTER_VENTILATION
BEGIN
  WHILE RETRIEVING PDTRANP_DOU_ECT &
    VIA    CIECLE,                    &
           FTRNUMFAC                  &
    USING  CIECLE    OF PDFACTURE,    &
           FTRNUMFAC OF PDFACTURE
  BEGIN
    GET PDCHARGES_DIVERS OPTIONAL &
        VIA   CIECLE,   &
              CDICODCHR &
        USING CIECLE    OF PDTRANP_DOU_ECT, &
              CDICODCHR OF PDTRANP_DOU_ECT
    IF CDICODCHR OF PDTRANP_DOU_ECT <> "TRANS" AND &
       CDICODCHR OF PDTRANP_DOU_ECT <> "COURT"
    THEN BEGIN


          IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE001 AND &
             CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE001
          THEN BEGIN
                 LET T_MNTVNT001 = T_MNTVNT001 + TDEPRI OF PDTRANP_DOU_ECT
          END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE002 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE002
               THEN BEGIN
                LET T_MNTVNT002 = T_MNTVNT002 + TDEPRI OF PDTRANP_DOU_ECT
                END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE003 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE003
               THEN BEGIN
                  LET T_MNTVNT003 = T_MNTVNT003 + TDEPRI OF PDTRANP_DOU_ECT
                  END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE005 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE005
               THEN BEGIN
                  LET T_MNTVNT005 = T_MNTVNT005 + TDEPRI OF PDTRANP_DOU_ECT
                  END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE006 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE006
               THEN BEGIN
                  LET T_MNTVNT006 = T_MNTVNT006 + TDEPRI OF PDTRANP_DOU_ECT
                  END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE007 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE007
               THEN BEGIN
                 LET T_MNTVNT007 = T_MNTVNT007 + TDEPRI OF PDTRANP_DOU_ECT
                 END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE004 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE004
               THEN BEGIN
                  LET T_MNTVNT004 = T_MNTVNT004 + TDEPRI OF PDTRANP_DOU_ECT
                  END
          ELSE IF UNACLE OF PDCHARGES_DIVERS = T_UNACLE008 AND &
                  CPTCLE OF PDCHARGES_DIVERS = T_CPTCLE008
               THEN BEGIN
                  LET T_MNTVNT008 = T_MNTVNT008 + TDEPRI OF PDTRANP_DOU_ECT
                  END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE001)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE001))
          THEN BEGIN
                 LET T_MNTVNT001 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE001 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE001 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE002)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE002))
          THEN BEGIN
                 LET T_MNTVNT002 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE002 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE002 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE003)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE003))
          THEN BEGIN
                 LET T_MNTVNT003 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE003 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE003 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE005)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE005))
          THEN BEGIN
                 LET T_MNTVNT005 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE005 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE005 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE006)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE006))
          THEN BEGIN
                 LET T_MNTVNT006 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE006 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE006 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE007)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE007))
          THEN BEGIN
                 LET T_MNTVNT007 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE007 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE007 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE004)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE004))
          THEN BEGIN
                 LET T_MNTVNT004 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE004 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE004 = CPTCLE OF PDCHARGES_DIVERS
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE008)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE008))
          THEN BEGIN
                 LET T_MNTVNT008 = TDEPRI OF PDTRANP_DOU_ECT
                 LET T_UNACLE008 = UNACLE OF PDCHARGES_DIVERS
                 LET T_CPTCLE008 = CPTCLE OF PDCHARGES_DIVERS
          END
    END
  END


  WHILE RETRIEVING PDCOM_FACTURE         &
    VIA    FTRNUMFAC                     &
    USING  FTRNUMFAC OF PDFACTURE
  BEGIN
    IF COFFLGIMP OF PDCOM_FACTURE <> "0" AND COFFLGIMP OF PDCOM_FACTURE <> " "
    THEN BEGIN
          IF 0 <> COFMNT OF PDCOM_FACTURE
          THEN BEGIN


          IF UNACLE OF PDCOM_FACTURE = T_UNACLE001 AND &
             CPTCLE OF PDCOM_FACTURE = T_CPTCLE001
          THEN BEGIN
                 LET T_MNTVNT001 = T_MNTVNT001 + COFMNT OF PDCOM_FACTURE

          END
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE002 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE002
               THEN BEGIN
               LET T_MNTVNT002 = T_MNTVNT002 + COFMNT OF PDCOM_FACTURE
               END
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE003 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE003
               THEN LET T_MNTVNT003 = T_MNTVNT003 + COFMNT OF PDCOM_FACTURE
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE005 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE005
               THEN LET T_MNTVNT005 = T_MNTVNT005 + COFMNT OF PDCOM_FACTURE
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE006 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE006
                THEN LET T_MNTVNT006 = T_MNTVNT006 + COFMNT OF PDCOM_FACTURE
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE007 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE007
               THEN LET T_MNTVNT007 = T_MNTVNT007 + COFMNT OF PDCOM_FACTURE
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE004 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE004
               THEN LET T_MNTVNT004 = T_MNTVNT004 + COFMNT OF PDCOM_FACTURE
          ELSE IF UNACLE OF PDCOM_FACTURE = T_UNACLE008 AND &
                  CPTCLE OF PDCOM_FACTURE = T_CPTCLE008
               THEN LET T_MNTVNT008 = T_MNTVNT008 + COFMNT OF PDCOM_FACTURE
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE001)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE001))
          THEN BEGIN
                 LET T_MNTVNT001 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE001 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE001 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE002)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE002))
          THEN BEGIN
                 LET T_MNTVNT002 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE002 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE002 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE003)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE003))
          THEN BEGIN
                 LET T_MNTVNT003 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE003 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE003 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE005)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE005))
          THEN BEGIN
                 LET T_MNTVNT005 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE005 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE005 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE006)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE006))
          THEN BEGIN
                 LET T_MNTVNT006 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE006 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE006 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE007)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE007))
          THEN BEGIN
                 LET T_MNTVNT007 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE007 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE007 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE004)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE004))
          THEN BEGIN
                 LET T_MNTVNT004 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE004 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE004 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
          ELSE IF 0 = SIZE(TRUNC(T_UNACLE008)) AND &
                  0 = SIZE(TRUNC(T_CPTCLE008))
          THEN BEGIN
                 LET T_MNTVNT008 = COFMNT OF PDCOM_FACTURE
                 LET T_UNACLE008 = UNACLE OF PDCOM_FACTURE
                 LET T_CPTCLE008 = CPTCLE OF PDCOM_FACTURE
                 LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
          END
        END
     END
   END
END

;-------------------------------------------------------------------------------
;
; Procedure pour le page footing
;

PROCEDURE INTERNAL PAGE_FOOTING
BEGIN

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET


  IF FTRTYPFAC OF PDFACTURE = "C"
  THEN BEGIN

    IF T_NBRE_CPTCLE_AUTRE = 0
    THEN BEGIN
      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE001 = T_CPTCLETRPTER
        LET T_UNACLE001 = T_UNACLETRPTER
        LET T_MNTVNT001 = T_STTTRPTER
        LET T_CPTCLE002 = T_CPTCLETRPMER
        LET T_UNACLE002 = T_UNACLETRPMER
        LET T_MNTVNT002 = T_STTTRPMER
        LET T_CPTCLE003 = T_CPTCLECOU
        LET T_UNACLE003 = T_UNACLECOU
        LET T_MNTVNT003 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE001 = T_CPTCLETRPTER
          LET T_UNACLE001 = T_UNACLETRPTER
          LET T_MNTVNT001 = T_STTTRPTER
          LET T_CPTCLE002 = T_CPTCLETRPMER
          LET T_UNACLE002 = T_UNACLETRPMER
          LET T_MNTVNT002 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE001 = T_CPTCLETRPTER
            LET T_UNACLE001 = T_UNACLETRPTER
            LET T_MNTVNT001 = T_STTTRPTER
            LET T_CPTCLE002 = T_CPTCLECOU
            LET T_UNACLE002 = T_UNACLECOU
            LET T_MNTVNT002 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE001 = T_CPTCLETRPMER
              LET T_UNACLE001 = T_UNACLETRPMER
              LET T_MNTVNT001 = T_STTTRPMER
              LET T_CPTCLE002 = T_CPTCLECOU
              LET T_UNACLE002 = T_UNACLECOU
              LET T_MNTVNT002 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE001 = T_CPTCLETRPTER
                LET T_UNACLE001 = T_UNACLETRPTER
                LET T_MNTVNT001 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE001 = T_CPTCLECOU
                  LET T_UNACLE001 = T_UNACLECOU
                  LET T_MNTVNT001 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE001 = T_CPTCLETRPMER
                    LET T_UNACLE001 = T_UNACLETRPMER
                    LET T_MNTVNT001 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

    IF T_NBRE_CPTCLE_AUTRE = 1
    THEN BEGIN
      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE002 = T_CPTCLETRPTER
        LET T_UNACLE002 = T_UNACLETRPTER
        LET T_MNTVNT002 = T_STTTRPTER
        LET T_CPTCLE003 = T_CPTCLETRPMER
        LET T_UNACLE003 = T_UNACLETRPMER
        LET T_MNTVNT003 = T_STTTRPMER
        LET T_CPTCLE004 = T_CPTCLECOU
        LET T_UNACLE004 = T_UNACLECOU
        LET T_MNTVNT004 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE002 = T_CPTCLETRPTER
          LET T_UNACLE002 = T_UNACLETRPTER
          LET T_MNTVNT002 = T_STTTRPTER
          LET T_CPTCLE003 = T_CPTCLETRPMER
          LET T_UNACLE003 = T_UNACLETRPMER
          LET T_MNTVNT003 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE002 = T_CPTCLETRPTER
            LET T_UNACLE002 = T_UNACLETRPTER
            LET T_MNTVNT002 = T_STTTRPTER
            LET T_CPTCLE003 = T_CPTCLECOU
            LET T_UNACLE003 = T_UNACLECOU
            LET T_MNTVNT003 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE002 = T_CPTCLETRPMER
              LET T_UNACLE002 = T_UNACLETRPMER
              LET T_MNTVNT002 = T_STTTRPMER
              LET T_CPTCLE003 = T_CPTCLECOU
              LET T_UNACLE003 = T_UNACLECOU
              LET T_MNTVNT003 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE002 = T_CPTCLETRPTER
                LET T_UNACLE002 = T_UNACLETRPTER
                LET T_MNTVNT002 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE002 = T_CPTCLECOU
                  LET T_UNACLE002 = T_UNACLECOU
                  LET T_MNTVNT002 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE002 = T_CPTCLETRPMER
                    LET T_UNACLE002 = T_UNACLETRPMER
                    LET T_MNTVNT002 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

    IF T_NBRE_CPTCLE_AUTRE = 2
    THEN BEGIN

      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE003 = T_CPTCLETRPTER
        LET T_UNACLE003 = T_UNACLETRPTER
        LET T_MNTVNT003 = T_STTTRPTER
        LET T_CPTCLE004 = T_CPTCLETRPMER
        LET T_UNACLE004 = T_UNACLETRPMER
        LET T_MNTVNT004 = T_STTTRPMER
        LET T_CPTCLE005 = T_CPTCLECOU
        LET T_UNACLE005 = T_UNACLECOU
        LET T_MNTVNT005 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE003 = T_CPTCLETRPTER
          LET T_UNACLE003 = T_UNACLETRPTER
          LET T_MNTVNT003 = T_STTTRPTER
          LET T_CPTCLE004 = T_CPTCLETRPMER
          LET T_UNACLE004 = T_UNACLETRPMER
          LET T_MNTVNT004 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE003 = T_CPTCLETRPTER
            LET T_UNACLE003 = T_UNACLETRPTER
            LET T_MNTVNT003 = T_STTTRPTER
            LET T_CPTCLE004 = T_CPTCLECOU
            LET T_UNACLE004 = T_UNACLECOU
            LET T_MNTVNT004 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE003 = T_CPTCLETRPMER
              LET T_UNACLE003 = T_UNACLETRPMER
              LET T_MNTVNT003 = T_STTTRPMER
              LET T_CPTCLE004 = T_CPTCLECOU
              LET T_UNACLE004 = T_UNACLECOU
              LET T_MNTVNT004 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE003 = T_CPTCLETRPTER
                LET T_UNACLE003 = T_UNACLETRPTER
                LET T_MNTVNT003 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE003 = T_CPTCLECOU
                  LET T_UNACLE003 = T_UNACLECOU
                  LET T_MNTVNT003 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE003 = T_CPTCLETRPMER
                    LET T_UNACLE003 = T_UNACLETRPMER
                    LET T_MNTVNT003 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

    IF T_NBRE_CPTCLE_AUTRE = 3
    THEN BEGIN

      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE004 = T_CPTCLETRPTER
        LET T_UNACLE004 = T_UNACLETRPTER
        LET T_MNTVNT004 = T_STTTRPTER
        LET T_CPTCLE005 = T_CPTCLETRPMER
        LET T_UNACLE005 = T_UNACLETRPMER
        LET T_MNTVNT005 = T_STTTRPMER
        LET T_CPTCLE006 = T_CPTCLECOU
        LET T_UNACLE006 = T_UNACLECOU
        LET T_MNTVNT006 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE004 = T_CPTCLETRPTER
          LET T_UNACLE004 = T_UNACLETRPTER
          LET T_MNTVNT004 = T_STTTRPTER
          LET T_CPTCLE005 = T_CPTCLETRPMER
          LET T_UNACLE005 = T_UNACLETRPMER
          LET T_MNTVNT005 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE004 = T_CPTCLETRPTER
            LET T_UNACLE004 = T_UNACLETRPTER
            LET T_MNTVNT004 = T_STTTRPTER
            LET T_CPTCLE005 = T_CPTCLECOU
            LET T_UNACLE005 = T_UNACLECOU
            LET T_MNTVNT005 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE004 = T_CPTCLETRPMER
              LET T_UNACLE004 = T_UNACLETRPMER
              LET T_MNTVNT004 = T_STTTRPMER
              LET T_CPTCLE005 = T_CPTCLECOU
              LET T_UNACLE005 = T_UNACLECOU
              LET T_MNTVNT005 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE004 = T_CPTCLETRPTER
                LET T_UNACLE004 = T_UNACLETRPTER
                LET T_MNTVNT004 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE004 = T_CPTCLECOU
                  LET T_UNACLE004 = T_UNACLECOU
                  LET T_MNTVNT004 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE004 = T_CPTCLETRPMER
                    LET T_UNACLE004 = T_UNACLETRPMER
                    LET T_MNTVNT004 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

    IF T_NBRE_CPTCLE_AUTRE = 4
    THEN BEGIN

      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE005 = T_CPTCLETRPTER
        LET T_UNACLE005 = T_UNACLETRPTER
        LET T_MNTVNT005 = T_STTTRPTER
        LET T_CPTCLE006 = T_CPTCLETRPMER
        LET T_UNACLE006 = T_UNACLETRPMER
        LET T_MNTVNT006 = T_STTTRPMER
        LET T_CPTCLE007 = T_CPTCLECOU
        LET T_UNACLE007 = T_UNACLECOU
        LET T_MNTVNT007 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE005 = T_CPTCLETRPTER
          LET T_UNACLE005 = T_UNACLETRPTER
          LET T_MNTVNT005 = T_STTTRPTER
          LET T_CPTCLE006 = T_CPTCLETRPMER
          LET T_UNACLE006 = T_UNACLETRPMER
          LET T_MNTVNT006 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE005 = T_CPTCLETRPTER
            LET T_UNACLE005 = T_UNACLETRPTER
            LET T_MNTVNT005 = T_STTTRPTER
            LET T_CPTCLE006 = T_CPTCLECOU
            LET T_UNACLE006 = T_UNACLECOU
            LET T_MNTVNT006 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE005 = T_CPTCLETRPMER
              LET T_UNACLE005 = T_UNACLETRPMER
              LET T_MNTVNT005 = T_STTTRPMER
              LET T_CPTCLE006 = T_CPTCLECOU
              LET T_UNACLE006 = T_UNACLECOU
              LET T_MNTVNT006 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE005 = T_CPTCLETRPTER
                LET T_UNACLE005 = T_UNACLETRPTER
                LET T_MNTVNT005 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE005 = T_CPTCLECOU
                  LET T_UNACLE005 = T_UNACLECOU
                  LET T_MNTVNT005 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE005 = T_CPTCLETRPMER
                    LET T_UNACLE005 = T_UNACLETRPMER
                    LET T_MNTVNT005 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

    IF T_NBRE_CPTCLE_AUTRE = 5
    THEN BEGIN

      IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
         0 <> SIZE(TRUNCATE(T_CPTCLECOU))
      THEN BEGIN
        LET T_CPTCLE006 = T_CPTCLETRPTER
        LET T_UNACLE006 = T_UNACLETRPTER
        LET T_MNTVNT006 = T_STTTRPTER
        LET T_CPTCLE007 = T_CPTCLETRPMER
        LET T_UNACLE007 = T_UNACLETRPMER
        LET T_MNTVNT007 = T_STTTRPMER
        LET T_CPTCLE008 = T_CPTCLECOU
        LET T_UNACLE008 = T_UNACLECOU
        LET T_MNTVNT008 = T_STTCOUR
      END
      ELSE BEGIN
        IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLECOU))
        THEN BEGIN
          LET T_CPTCLE006 = T_CPTCLETRPTER
          LET T_UNACLE006 = T_UNACLETRPTER
          LET T_MNTVNT006 = T_STTTRPTER
          LET T_CPTCLE007 = T_CPTCLETRPMER
          LET T_UNACLE007 = T_UNACLETRPMER
          LET T_MNTVNT007 = T_STTTRPMER
        END
        ELSE BEGIN
          IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
             0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
             0 <> SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLE006 = T_CPTCLETRPTER
            LET T_UNACLE006 = T_UNACLETRPTER
            LET T_MNTVNT006 = T_STTTRPTER
            LET T_CPTCLE007 = T_CPTCLECOU
            LET T_UNACLE007 = T_UNACLECOU
            LET T_MNTVNT007 = T_STTCOUR
          END
          ELSE BEGIN
            IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
               0 <> SIZE(TRUNCATE(T_CPTCLECOU))
            THEN BEGIN
              LET T_CPTCLE006 = T_CPTCLETRPMER
              LET T_UNACLE006 = T_UNACLETRPMER
              LET T_MNTVNT006 = T_STTTRPMER
              LET T_CPTCLE007 = T_CPTCLECOU
              LET T_UNACLE007 = T_UNACLECOU
              LET T_MNTVNT007 = T_STTCOUR
            END
            ELSE BEGIN
              IF 0 <> SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                 0 =  SIZE(TRUNCATE(T_CPTCLECOU))
              THEN BEGIN
                LET T_CPTCLE006 = T_CPTCLETRPTER
                LET T_UNACLE006 = T_UNACLETRPTER
                LET T_MNTVNT006 = T_STTTRPTER
              END
              ELSE BEGIN
                IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                   0 =  SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                   0 <> SIZE(TRUNCATE(T_CPTCLECOU))
                THEN BEGIN
                  LET T_CPTCLE006 = T_CPTCLECOU
                  LET T_UNACLE006 = T_UNACLECOU
                  LET T_MNTVNT006 = T_STTCOUR
                END
                ELSE BEGIN
                  IF 0 =  SIZE(TRUNCATE(T_CPTCLETRPTER)) AND &
                     0 <> SIZE(TRUNCATE(T_CPTCLETRPMER)) AND &
                     0 =  SIZE(TRUNCATE(T_CPTCLECOU))
                  THEN BEGIN
                    LET T_CPTCLE006 = T_CPTCLETRPMER
                    LET T_UNACLE006 = T_UNACLETRPMER
                    LET T_MNTVNT006 = T_STTTRPMER
                  END
                END
              END
            END
          END
        END
      END
    END

DO INTERNAL AJOUTER_VENTILATION

    LET T_PREMIER_MONTANT = T_PREMIER_MONTANT + (FTRMNTBRU OF PDFACTURE &
                                                - (T_STTCOUR + &
                                                T_STTTRPTER + &
                                                T_STTTRPMER))
    LET T_ED_MO_1 = T_PREMIER_MONTANT
    LET IMPLIG = "    " &
                  + D_EDIT_1 &
                  + " "
    LET T_ED_MO_1 = T_STTCOUR
    LET IMPLIG = IMPLIG[1:20] + D_EDIT_1[5:10] &
                  + " "
    LET T_ED_MO_1 = T_STTTRPTER + T_STTTRPMER
    LET IMPLIG = IMPLIG[1:32] + D_EDIT_1[3:12] &
                  + "  "
    LET T_ED_MO_1 = T_PREMIER_MONTANT + (T_STTCOUR + T_STTTRPTER + &
                                        T_STTTRPMER)
    LET T_PCTTPS = LJ(ASCII(ROUND(T_TAXPCTTPS * 1000)))
    LET IMPLIG = IMPLIG[1:48] + D_EDIT_1 &
                  + "  " &
                  + T_PCTTPS [1:1] &
                  + "." &
                  + T_PCTTPS [2:1] &
                  + "%" &
                  + " "
    LET T_ED_MO_1 = FTRMNTTPS OF PDFACTURE
    LET T_PCTTVQ = LJ(ASCII(ROUND(T_TAXPCTTVQ * 1000)))
    LET IMPLIG = IMPLIG[1:70] + D_EDIT_1 &
                  + " " &
                  + T_PCTTVQ [1:1] &
                  + "." &
                  + T_PCTTVQ [2:1] &
                  + "%" &
                  + " "
    LET T_ED_MO_1 = FTRMNTTVQ OF PDFACTURE
    LET IMPLIG = IMPLIG[1:91] + D_EDIT_1 &
                  + "    "
    LET T_ED_MO_1 = FTRMNT OF PDFACTURE
    LET IMPLIG = IMPLIG[1:112] + D_EDIT_1
    PUT PDIMPRIM_DOC RESET

  END
  ELSE BEGIN

  DO INTERNAL AJOUTER_VENTILATION
    LET T_PREMIER_MONTANT = T_PREMIER_MONTANT + (FTRMNTBRU OF PDFACTURE &
                                                - (T_STTCOUR + &
                                                T_STTTRPTER + &
                                                T_STTTRPMER))
    LET T_ED_MO_1 = T_PREMIER_MONTANT
    LET IMPLIG = "    " &
                  + D_EDIT_1 &
;                  + T_BLANC[1:34]
;---
                  + " "


    LET T_ED_MO_1 = T_STTCOUR
    LET IMPLIG = IMPLIG[1:20] + D_EDIT_1[5:10] &
                  + " "
    LET T_ED_MO_1 = T_STTTRPTER + T_STTTRPMER
    LET IMPLIG = IMPLIG[1:32] + D_EDIT_1[3:12] &
                  + "  "
    LET T_ED_MO_1 = T_PREMIER_MONTANT + (T_STTCOUR + T_STTTRPTER + &
                                        T_STTTRPMER)


;----
    LET T_ED_MO_1 = T_PREMIER_MONTANT + (T_STTCOUR + T_STTTRPTER + &
                                        T_STTTRPMER)


    LET T_PCTTPS = LJ(ASCII(T_TAXPCTTPS * 1000))
    LET IMPLIG = IMPLIG[1:48] + D_EDIT_1 &
                  + "  " &
                  + T_PCTTPS [1:1] &
                  + "." &
                  + T_PCTTPS [2:1] &
                  + "%" &
                  + " "
    LET T_ED_MO_1 = FTRMNTTPS OF PDFACTURE
    LET T_PCTTVQ = LJ(ASCII(T_TAXPCTTVQ * 1000))
    LET IMPLIG = IMPLIG[1:70] + D_EDIT_1 &
                  + " " &
                  + T_PCTTVQ [1:1] &
                  + "." &
                  + T_PCTTVQ [2:1] &
                  + "%" &
                  + " "
    LET T_ED_MO_1 = FTRMNTTVQ OF PDFACTURE
    LET IMPLIG = IMPLIG[1:91] + D_EDIT_1 &
                  + "    "
    LET T_ED_MO_1 = FTRMNT OF PDFACTURE
    LET IMPLIG = IMPLIG[1:112] + D_EDIT_1
    PUT PDIMPRIM_DOC RESET

  END

  LET IMPLIG          = T_BLANC[1:112] + &
                        T_DEVDESC
  PUT PDIMPRIM_DOC RESET
;-----------------------------------------------------------------------
;----nouvelle recherche de compte....via pdfac_imputation
;
LET T_MNTVNT001 = 0
LET T_MNTVNT002 = 0
LET T_MNTVNT003 = 0
LET T_MNTVNT004 = 0
LET T_MNTVNT005 = 0
LET T_MNTVNT006 = 0
LET T_MNTVNT007 = 0
LET T_MNTVNT008 = 0

WHILE RETRIEVING PDFAC_IMPUTATION &
  VIA         CIECLE, &
              FTRNUMFAC &
  USING       CIECLE OF PDFACTURE, &
              FTRNUMFAC OF PDFACTURE
BEGIN

  IF T_MNTVNT001 = 0
  THEN BEGIN
   LET T_CPTCLE001 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE001 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT001 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
 END
 IF T_MNTVNT002 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION)
  THEN BEGIN
   LET T_CPTCLE002 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE002 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT002 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT003 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION)
  THEN BEGIN
   LET T_CPTCLE003 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE003 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT003 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT004 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
(T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE003 <> CPTCLE OF PDFAC_IMPUTATION)

  THEN BEGIN
   LET T_CPTCLE004 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE004 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT004 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT005 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
(T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE003 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE004 <> CPTCLE OF PDFAC_IMPUTATION)

  THEN BEGIN
   LET T_CPTCLE005 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE005 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT005 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT006 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
(T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE003 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE004 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE005 <> CPTCLE OF PDFAC_IMPUTATION)

  THEN BEGIN
   LET T_CPTCLE006 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE006 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT006 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT007 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
(T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE003 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE004 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE005 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE006 <> CPTCLE OF PDFAC_IMPUTATION)

  THEN BEGIN
   LET T_CPTCLE007 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE007 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT007 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
 IF T_MNTVNT008 = 0 AND (T_CPTCLE001 <> CPTCLE OF PDFAC_IMPUTATION) AND &
(T_CPTCLE002 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE003 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE004 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE005 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE006 <> CPTCLE OF PDFAC_IMPUTATION) AND &
 (T_CPTCLE007 <> CPTCLE OF PDFAC_IMPUTATION)

  THEN BEGIN
   LET T_CPTCLE008 = CPTCLE OF PDFAC_IMPUTATION
   LET T_UNACLE008 = UNACLE OF PDFAC_IMPUTATION
   LET T_MNTVNT008 = CRIMNT OF PDFAC_IMPUTATION
   LET T_NBRE_CPTCLE_AUTRE = T_NBRE_CPTCLE_AUTRE + 1
  END
END

  LET T_NBRE_CPTCLE = T_NBRE_CPTCLE_AUTRE + T_NBRE_CPTCLE_FRAIS

  IF T_NBRE_CPTCLE = 0
  THEN BEGIN

    LET IMPLIG            = T_BLANC[1:10] &
                            + T_TMEDSC
    PUT PDIMPRIM_DOC RESET

    LET IMPLIG    = "X"
    LET IMPLIG    = " "
    PUT PDIMPRIM_DOC RESET

    LET IMPLIG    = "X"
    LET IMPLIG    = " "
    PUT PDIMPRIM_DOC RESET

    LET IMPLIG          = T_BLANC [1:121] + ASCII(T_NB_PAGE)
    PUT PDIMPRIM_DOC RESET

  END
  ELSE BEGIN
    IF T_NBRE_CPTCLE = 1
    THEN BEGIN
      LET T_ED_MO_1         = T_MNTVNT001
      LET T_ED_MO_2         = T_MNTVNT005
      LET IMPLIG            = T_BLANC[1:10] &
                              + T_TMEDSC &
                              + "  " &
                              + T_UNACLE001[1:4] &
                              + D_SIGLE_UNACLE001 &
                              + T_CPTCLE001 &
                              + D_SIGLE_CPTCLE001 &
                              + D_EDIT_1 &
                              + "  " &
                              + T_UNACLE005[1:4] &
                              + D_SIGLE_UNACLE005 &
                              + T_CPTCLE005 &
                              + D_SIGLE_CPTCLE005 &
                              + D_EDIT_2

      PUT PDIMPRIM_DOC RESET

      LET IMPLIG    = "X"
      LET IMPLIG    = " "
      PUT PDIMPRIM_DOC RESET

      LET IMPLIG    = "X"
      LET IMPLIG    = " "
      PUT PDIMPRIM_DOC RESET

      LET IMPLIG          = T_BLANC [1:121] + ASCII(T_NB_PAGE)
      PUT PDIMPRIM_DOC RESET

    END
    ELSE BEGIN
      IF T_NBRE_CPTCLE = 2
      THEN BEGIN
        LET T_ED_MO_1         = T_MNTVNT001
        LET T_ED_MO_2         = T_MNTVNT005
        LET IMPLIG            = T_BLANC[1:10] &
                                + T_TMEDSC &
                                + "  " &
                                + T_UNACLE001[1:4] &
                                + D_SIGLE_UNACLE001 &
                                + T_CPTCLE001 &
                                + D_SIGLE_CPTCLE001 &
                                + D_EDIT_1 &
                                + "  " &
                                + T_UNACLE005[1:4] &
                                + D_SIGLE_UNACLE005 &
                                + T_CPTCLE005 &
                                + D_SIGLE_CPTCLE005 &
                                + D_EDIT_2
        PUT PDIMPRIM_DOC RESET

        LET T_ED_MO_1       = (FTRMNT OF PDFACTURE * T_DEVTAU)
        LET T_ED_MO_2         = T_MNTVNT002
        LET T_ED_MO_3         = T_MNTVNT006
        LET IMPLIG          = T_BLANC[1:50] &
                              + "  " &
                              + T_UNACLE002[1:4] &
                              + D_SIGLE_UNACLE002 &
                              + T_CPTCLE002 &
                              + D_SIGLE_CPTCLE002 &
                              + D_EDIT_2 &
                              + "  " &
                              + T_UNACLE006[1:4] &
                              + D_SIGLE_UNACLE006 &
                              + T_CPTCLE006 &
                              + D_SIGLE_CPTCLE006 &
                              + D_EDIT_3 &
                              + "  " &
                              + D_EDIT_1
        PUT PDIMPRIM_DOC RESET

        LET IMPLIG    = "X"
        LET IMPLIG    = " "
        PUT PDIMPRIM_DOC RESET

        LET IMPLIG          = T_BLANC [1:121] + ASCII(T_NB_PAGE)
        PUT PDIMPRIM_DOC RESET

      END
      ELSE BEGIN
        IF T_NBRE_CPTCLE = 3
        THEN BEGIN

          LET T_ED_MO_1         = T_MNTVNT001
          LET T_ED_MO_2         = T_MNTVNT005
          LET IMPLIG            = T_BLANC[1:10] &
                                  + T_TMEDSC &
                                  + "  " &
                                  + T_UNACLE001[1:4] &
                                  + D_SIGLE_UNACLE001 &
                                  + T_CPTCLE001 &
                                  + D_SIGLE_CPTCLE001 &
                                  + D_EDIT_1 &
                                  + "  " &
                                  + T_UNACLE005[1:4] &
                                  + D_SIGLE_UNACLE005 &
                                  + T_CPTCLE005 &
                                  + D_SIGLE_CPTCLE005 &
                                  + D_EDIT_2

          PUT PDIMPRIM_DOC RESET

          LET T_ED_MO_1       = (FTRMNT OF PDFACTURE * T_DEVTAU)
          LET T_ED_MO_2         = T_MNTVNT002
          LET T_ED_MO_3         = T_MNTVNT006
          LET IMPLIG          = T_BLANC[1:50] &
                                + "  " &
                                + T_UNACLE002[1:4] &
                                + D_SIGLE_UNACLE002 &
                                + T_CPTCLE002 &
                                + D_SIGLE_CPTCLE002 &
                                + D_EDIT_2 &
                                + "  " &
                                + T_UNACLE006[1:4] &
                                + D_SIGLE_UNACLE006 &
                                + T_CPTCLE006 &
                                + D_SIGLE_CPTCLE006 &
                                + D_EDIT_3 &
                                + "  " &
                                + D_EDIT_1
          PUT PDIMPRIM_DOC RESET

          LET T_ED_MO_1         = T_MNTVNT003
          LET T_ED_MO_2         = T_MNTVNT007
          LET IMPLIG          = T_BLANC[1:50] &
                                + "  " &
                                + T_UNACLE003[1:4] &
                                + D_SIGLE_UNACLE003 &
                                + T_CPTCLE003 &
                                + D_SIGLE_CPTCLE003 &
                                + D_EDIT_1 &
                                + "  " &
                                + T_UNACLE007[1:4] &
                                + D_SIGLE_UNACLE007 &
                                + T_CPTCLE007 &
                                + D_SIGLE_CPTCLE007 &
                                + D_EDIT_2
          PUT PDIMPRIM_DOC RESET

          LET IMPLIG          = T_BLANC [1:121] + ASCII(T_NB_PAGE)
          PUT PDIMPRIM_DOC RESET

        END
        ELSE BEGIN
          IF T_NBRE_CPTCLE >= 4
          THEN BEGIN
            LET T_ED_MO_1         = T_MNTVNT001
            LET T_ED_MO_2         = T_MNTVNT005
            LET IMPLIG            = T_BLANC[1:10] &
                                    + T_TMEDSC &
                                    + "  " &
                                    + T_UNACLE001[1:4] &
                                    + D_SIGLE_UNACLE001 &
                                    + T_CPTCLE001 &
                                    + D_SIGLE_CPTCLE001 &
                                    + D_EDIT_1 &
                                    + "  " &
                                    + T_UNACLE005[1:4] &
                                    + D_SIGLE_UNACLE005 &
                                    + T_CPTCLE005 &
                                    + D_SIGLE_CPTCLE005 &
                                    + D_EDIT_2
            PUT PDIMPRIM_DOC RESET

            LET T_ED_MO_1       = (FTRMNT OF PDFACTURE * T_DEVTAU)
            LET T_ED_MO_2         = T_MNTVNT002
            LET T_ED_MO_3         = T_MNTVNT006
            LET IMPLIG          = T_BLANC[1:50] &
                                  + "  " &
                                  + T_UNACLE002[1:4] &
                                  + D_SIGLE_UNACLE002 &
                                  + T_CPTCLE002 &
                                  + D_SIGLE_CPTCLE002 &
                                  + D_EDIT_2 &
                                  + "  " &
                                  + T_UNACLE006[1:4] &
                                  + D_SIGLE_UNACLE006 &
                                  + T_CPTCLE006 &
                                  + D_SIGLE_CPTCLE006 &
                                  + D_EDIT_3 &
                                  + "  " &
                                  + D_EDIT_1
            PUT PDIMPRIM_DOC RESET

            LET T_ED_MO_1         = T_MNTVNT003
            LET T_ED_MO_2         = T_MNTVNT007
            LET IMPLIG          = T_BLANC[1:50] &
                                  + "  " &
                                  + T_UNACLE003[1:4] &
                                  + D_SIGLE_UNACLE003 &
                                  + T_CPTCLE003 &
                                  + D_SIGLE_CPTCLE003 &
                                  + D_EDIT_1 &
                                  + "  " &
                                  + T_UNACLE007[1:4] &
                                  + D_SIGLE_UNACLE007 &
                                  + T_CPTCLE007 &
                                  + D_SIGLE_CPTCLE007 &
                                  + D_EDIT_2
            PUT PDIMPRIM_DOC RESET

            LET T_ED_MO_1         = T_MNTVNT004
            LET T_ED_MO_2         = T_MNTVNT008
            LET IMPLIG          = T_BLANC[1:50] &
                                  + "  " &
                                  + T_UNACLE004[1:4] &
                                  + D_SIGLE_UNACLE004 &
                                  + T_CPTCLE004 &
                                  + D_SIGLE_CPTCLE004 &
                                  + D_EDIT_1 &
                                  + "  " &
                                  + T_UNACLE008[1:4] &
                                  + D_SIGLE_UNACLE008 &
                                  + T_CPTCLE008 &
                                  + D_SIGLE_CPTCLE008 &
                                  + D_EDIT_2 &
                                  + "           " &
                                  + ASCII(T_NB_PAGE)
            PUT PDIMPRIM_DOC RESET
          END
        END
      END
    END
  END
END

;-------------------------------------------------------------------------------
;
; Procedure pour le page footing
;

PROCEDURE INTERNAL PAGE_FOOTING_BLANC
BEGIN

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG    = "X"
  LET IMPLIG    = " "
  PUT PDIMPRIM_DOC RESET

  LET IMPLIG          = T_BLANC [1:121] + ASCII(T_NB_PAGE)
  PUT PDIMPRIM_DOC RESET

END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer le détail de la facture
;
PROCEDURE INTERNAL IMPRIM_DETAIL
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END

 IF T_TYPE = "DI"
 THEN LET T_TYPE = "PCE"

 IF T_TYPE ="TR" AND COMCODLNGCOR OF PDCOMMAN_INTERNE = "A"
 THEN LET T_TYPE = "SL"

 IF T_FLAG_AJFOR = "O"
 THEN BEGIN

  LET IMPLIG = "  " &
               + T_NOMBRE &
               + " " &
               + T_TYPE &
               + "    " &
               + T_DESCRIPTION &
               + "     " &
               + T_QTE &
               + " " &
               + "  "&;T_UN &
               + " " &
               + "     " &
               + "  " &
               + T_UN &
               + "        " &
               + " "
 END
 ELSE BEGIN
 LET IMPLIG = "  " &
               + T_NOMBRE &
               + " " &
               + T_TYPE &
               + "    " &
               + T_DESCRIPTION &
               + "      " &
               + T_QTE &
               + " " &
               + "" &;T_UN &
               + "" &
               + T_PRIX[3:12] &
               + " " &
               + T_UN &
               + "        " &
               + T_MONTANT
 END
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procedure pour imprimer le detail de la facture
;
PROCEDURE INTERNAL IMPRIM_DETAIL2
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  LET IMPLIG = "  " &
               + T_NOMBRE &
               + " " &
               + T_TYPE2 &
               + "  " &
               + T_DETAIL &
               + "    " &
               + T_SUR_VEN &
               + " " &
               + T_PRI_VEN[3:12] &
               + "  " &
               + T_UNI_VEN &
               + "        " &
               + T_TOT_VEN
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer les commentaires des tranches
;
PROCEDURE INTERNAL IMPRIM_COM_TRAN
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  LET IMPLIG = T_BLANC[1:24] + COTCOM OF PDCOMMEN_TRANCHE
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour rechercher les commentaires des tranches
;
PROCEDURE INTERNAL RECHER_COMMEN_TRAN
BEGIN
  WHILE RETRIEVING PDCOMMEN_TRANCHE        &
    VIA    FTRNUMFAC,                    &
           TRANUMTRA002,                 &
           CIECLE                        &
    USING  FTRNUMFAC OF PDTRANCHE_FAC,   &
           TRANUMTRA002 OF PDTRANCHE_FAC,&
           CIECLE OF PDTRANCHE_FAC
  BEGIN
    IF COTFLGIMP <> "N" AND COTFLGIMP <> " "
    THEN BEGIN
      DO INTERNAL IMPRIM_COM_TRAN
    END
  END
END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer les commentaires des produits de dimension
;
PROCEDURE INTERNAL IMPRIM_COM_PROD
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  LET IMPLIG = T_BLANC[1:24] + COPCOM OF PDCOMMEN_PROD
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour rechercher les commentaires des produits de dimension
;
PROCEDURE INTERNAL RECHER_COMMEN_PROD
BEGIN
   WHILE RETRIEVING PDCOMMEN_PROD                 &
     VIA    FTRNUMFAC,                    &
            PDILON,                       &
            PDIHAU,                       &
            PDIEPA,                       &
            TGRCODGRA,                    &
            TYFCODFIN,                    &
            CIECLE                        &
     USING  FTRNUMFAC OF PDPROD_FACTURE,  &
            PDILON OF PDPROD_FACTURE,     &
            PDIHAU OF PDPROD_FACTURE,     &
            PDIEPA OF PDPROD_FACTURE,     &
            TGRCODGRA OF PDPROD_FACTURE,  &
            TYFCODFIN OF PDPROD_FACTURE,  &
            CIECLE OF PDPROD_FACTURE
   BEGIN
    IF COPFLGIMP <> "N" AND COPFLGIMP <> " "
    THEN BEGIN
      DO INTERNAL IMPRIM_COM_PROD
    END
  END
END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer les commentaires des produits de dimension
;
PROCEDURE INTERNAL IMPRIM_COM_FACT
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  LET T_NOMBRE = "      "
  LET T_TYPE   = "  "
  LET T_QTE    = "               "
  LET T_PRIX   = "            "
  LET T_UN     = "  "
LET T_MNTTOT = COFMNT OF PDCOM_FACTURE
  LET T_ED_MO_1 = T_MNTTOT
  LET T_MONTANT = D_EDIT_1
  LET T_DESCRIPTION = COFCOM OF PDCOM_FACTURE
  LET IMPLIG = "  " &
               + T_NOMBRE &
               + " " &
               + T_TYPE &
               + "    " &
               + T_DESCRIPTION &
               + "     " &
               + T_QTE &
               + " " &
               + T_PRIX[3:12] &
               + "  " &
               + T_UN &
               + "        " &
               + T_MONTANT
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour rechercher les commentaires des produits de dimension
;
PROCEDURE INTERNAL RECHER_COMMEN_FACT
BEGIN
  LET IMPLIG          = "X"
  LET IMPLIG          = " "
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET

  WHILE RETRIEVING PDCOM_FACTURE         &
    VIA    FTRNUMFAC                     &
    USING  FTRNUMFAC OF PDFACTURE
  BEGIN
    IF COFFLGIMP OF PDCOM_FACTURE <> "0" AND COFFLGIMP OF PDCOM_FACTURE <> " "
    THEN BEGIN
      DO INTERNAL IMPRIM_COM_FACT
    END
  END
END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer les charges divers
;
PROCEDURE INTERNAL IMPRIM_CHARGES_DIVERS
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  IF T_AJFOR <> 0
  THEN BEGIN
  LET T_NOMBRE = "      "
  LET T_TYPE   = "  "
  LET T_QTE    = "               "
  LET T_PRIX   = "            "
  LET T_UN     = "  "
  LET T_MNTTOT = TDEPRI OF PDTRANP_DOU_ECT + T_AJFOR
  LET T_ED_MO_1 = T_MNTTOT
  LET T_MONTANT = D_EDIT_1
  IF T_CLILNG = "F"
  THEN LET T_DESCRIPTION = CDIDSCFRA OF PDCHARGES_DIVERS
  ELSE LET T_DESCRIPTION = CDIDSCANG OF PDCHARGES_DIVERS
  END

  ELSE BEGIN
  LET T_NOMBRE = "      "
  LET T_TYPE   = "  "
  LET T_QTE    = "               "
  LET T_PRIX   = "            "
  LET T_UN     = "  "
  LET T_MNTTOT = TDEPRI OF PDTRANP_DOU_ECT
  LET T_ED_MO_1 = T_MNTTOT
  LET T_MONTANT = D_EDIT_1
  IF T_CLILNG = "F"
  THEN LET T_DESCRIPTION = CDIDSCFRA OF PDCHARGES_DIVERS
  ELSE LET T_DESCRIPTION = CDIDSCANG OF PDCHARGES_DIVERS
  END
  LET IMPLIG = "  " &
               + T_NOMBRE &
               + " " &
               + T_TYPE &
               + "    " &
               + T_DESCRIPTION &
               + "     " &
               + T_QTE &
               + " " &
               + T_PRIX[3:12] &
               + "  " &
               + T_UN &
               + "        " &
               + T_MONTANT
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour rechercher les charges diveres autre que COURT ET TRANS
;
PROCEDURE INTERNAL RECHER_CHARGES_DIVERS
BEGIN
  LET IMPLIG          = "X"
  LET IMPLIG          = " "
  LET T_NB_LIGNE = T_NB_LIGNE + 1
  PUT PDIMPRIM_DOC RESET
  WHILE RETRIEVING PDTRANP_DOU_ECT &
    VIA    CIECLE,                    &
           FTRNUMFAC                  &
    USING  CIECLE    OF PDFACTURE,    &
           FTRNUMFAC OF PDFACTURE
  BEGIN
    GET PDCHARGES_DIVERS OPTIONAL &
        VIA   CIECLE,   &
              CDICODCHR &
        USING CIECLE    OF PDTRANP_DOU_ECT, &
              CDICODCHR OF PDTRANP_DOU_ECT
    IF CDICODCHR OF PDTRANP_DOU_ECT <> "TRANS" AND &
       CDICODCHR OF PDTRANP_DOU_ECT <> "COURT"
    THEN BEGIN
      DO INTERNAL IMPRIM_CHARGES_DIVERS
    END
  END
END

;-------------------------------------------------------------------------------
;
; Procédure pour imprimer les commentaires des blocs
;
PROCEDURE INTERNAL IMPRIM_COM_BLOC
BEGIN
  IF D_FLAG_LIGNE = 1
  THEN BEGIN
    DO INTERNAL PAGE_FOOTING_BLANC
    LET T_NB_LIGNE = 0
    DO INTERNAL IMPRIME_ENTETE
  END
  LET IMPLIG = T_BLANC[1:24] + COBCOM OF PDCOMMEN_BLOC
  PUT PDIMPRIM_DOC RESET
  LET T_NB_LIGNE = T_NB_LIGNE + 1
END

;-------------------------------------------------------------------------------
;
; Procédure pour rechercher les commentaires des blocs
;
PROCEDURE INTERNAL RECHER_COMMEN_BLOC
BEGIN
  WHILE RETRIEVING PDCOMMEN_BLOC                 &
    VIA    FTRNUMFAC,                    &
           BLONUMBLOAPR,                 &
           CIECLE                        &
    USING  FTRNUMFAC OF PDBLOC_FACTURE,  &
           BLONUMBLOAPR OF PDBLOC_FACTURE,&
           CIECLE OF PDBLOC_FACTURE
  BEGIN
    IF COBFLGIMP <> "N" AND COBFLGIMP <> " "
    THEN BEGIN
      DO INTERNAL IMPRIM_COM_BLOC
    END
  END
END

;-------------------------------------------------------------------------------
;
PROCEDURE INTERNAL IMPRIME_DETAIL_C_I
BEGIN

  WHILE RETRIEVING PDTRANP_DOU_ECT &
    VIA    CIECLE,                    &
           FTRNUMFAC                  &
    USING  CIECLE    OF PDFACTURE,    &
           FTRNUMFAC OF PDFACTURE
  BEGIN
    GET PDCHARGES_DIVERS OPTIONAL &
        VIA   CIECLE,   &
              CDICODCHR &
        USING CIECLE    OF PDTRANP_DOU_ECT, &
              CDICODCHR OF PDTRANP_DOU_ECT
      IF CDICODCHR OF PDTRANP_DOU_ECT = "AJFOR"
      THEN BEGIN
        LET T_FLAG_AJFOR = "O"
        LET T_FOR     = TDEPRI OF PDTRANP_DOU_ECT
      END
  END

;---
    LET T_AJFOR   = T_AJFOR + T_MNTTOT

    LET T_NOMBRE  = RJ(ASCII(T_CTRPIE))
    LET T_ED_MO_1 = T_MNTTOT

    LET T_MONTANT = D_EDIT_1

    LET T_ED_SU_1 = T_SURFACE * 10
    LET T_QTE     = D_EDIT_SU_1
    LET T_ED_MO_1 = DCIPRIVEN OF PDDETAIL_C_I
    LET T_PRIX    = D_EDIT_1
    LET T_UN      = DCIUNMVEN OF PDDETAIL_C_I
    LET T_TYPE    = T_TPDTYPPRD

    GET PDTYPE_GRANIT &
      VIA   CIECLE,               &
            TGRCODGRA             &
      USING CIECLE OF PDFACTURE,  &
            T_TGRCODGRA

    GET PDTYPE_FINI      &
      VIA   CIECLE,               &
            TYFCODFIN             &
      USING CIECLE OF PDFACTURE,  &
            T_TYFCODFIN

    IF T_CLILNG = "F"
    THEN BEGIN
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "1"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCFRA001 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "2"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCFRA002 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "3"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCFRA003 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "4"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCFRA004 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de fini selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPFIN OF PDDETAIL_C_I = "1"
      THEN BEGIN
        LET T_TYFDSC = TYFDSCFRA001 OF PDTYPE_FINI
      END
      ;
      ; Évaluation du code de fini selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPFIN OF PDDETAIL_C_I = "2"
      THEN BEGIN
        LET T_TYFDSC = TYFDSCFRA002 OF PDTYPE_FINI
      END
    END
    ELSE BEGIN
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "1"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCANG001 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "2"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCANG002 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "3"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCANG003 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de granit selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPGRA OF PDDETAIL_C_I = "4"
      THEN BEGIN
        LET T_TGRDSC = TGRDSCANG004 OF PDTYPE_GRANIT
      END
      ;
      ; Évaluation du code de fini selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPFIN OF PDDETAIL_C_I = "1"
      THEN BEGIN
        LET T_TYFDSC = TYFDSCANG001 OF PDTYPE_FINI
      END
      ;
      ; Évaluation du code de fini selon le code de langue du client et
      ; de la commande interne
      ;
      IF DCITYPFIN OF PDDETAIL_C_I = "2"
      THEN BEGIN
        LET T_TYFDSC = TYFDSCANG002 OF PDTYPE_FINI
      END
    END
    LET T_DESCRIPTION = TRUNCATE(T_TGRDSC) + ", " + &
                        TRUNCATE(T_TYFDSC) + ", " + &
                        ASCII(DCIEPA OF PDDETAIL_C_I) + " mm."

    ; Sommarisation des frais de courtage

       ; Allez checher les frais de courtage et de transport dans la table
       ; PDTRANP_DOU_ECT
       GET PDTRANP_DOU_ECT OPTIONAL      &
           VIA   CIECLE,                 &
                 FTRNUMFAC,              &
                 CDICODCHR               &
         USING   CIECLE OF PDFACTURE, &
                 FTRNUMFAC OF PDFACTURE, &
                 "COURT"
       IF ACCESSOK
       THEN BEGIN
        GET PDCHARGES_DIVERS OPTIONAL &
            VIA   CIECLE,   &
                  CDICODCHR &
            USING CIECLE    OF PDTRANP_DOU_ECT, &
                  CDICODCHR OF PDTRANP_DOU_ECT
        IF ACCESSOK
        THEN BEGIN
          LET T_STTCOUR = (TDEPRI OF PDTRANP_DOU_ECT)
          IF 0 = SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLECOU = CPTCLE OF PDCHARGES_DIVERS
            LET T_UNACLECOU = UNACLE OF PDCHARGES_DIVERS
            LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
          END
        END
       END
       GET PDTRANP_DOU_ECT OPTIONAL      &
           VIA   CIECLE,                 &
                 FTRNUMFAC,              &
                 CDICODCHR               &
         USING   CIECLE    OF PDFACTURE, &
                 FTRNUMFAC OF PDFACTURE, &
                 "TRANS"
       IF ACCESSOK
       THEN BEGIN
        GET PDCHARGES_DIVERS OPTIONAL &
            VIA   CIECLE,   &
                  CDICODCHR &
            USING CIECLE    OF PDTRANP_DOU_ECT, &
                  CDICODCHR OF PDTRANP_DOU_ECT
        IF ACCESSOK
        THEN BEGIN
          LET T_STTTRPTER = (TDEPRI OF PDTRANP_DOU_ECT)
          IF 0 = SIZE(TRUNCATE(T_CPTCLETRPTER))
          THEN BEGIN
            LET T_CPTCLETRPTER = CPTCLE OF PDCHARGES_DIVERS
            LET T_UNACLETRPTER = UNACLE OF PDCHARGES_DIVERS
            LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
          END
        END
       END

     WHILE RETRIEVING PDVENTILATION & ;boucle pour compter la sum des prix
      VIA    PJTABR,                            &
             PJTANN,                            &
             COMNUMCOMINT,                      &
             DCINUMLIG,                         &
             CIECLE                             &
      USING  PJTABR            OF PDDETAIL_C_I, &
             PJTANN            OF PDDETAIL_C_I, &
             COMNUMCOMINT      OF PDDETAIL_C_I, &
             DCINUMLIG         OF PDDETAIL_C_I, &
             CIECLE             OF PDDETAIL_C_I
      BEGIN
       LET T_AJFVEN = T_AJFVEN + VENPRIUNI OF PDVENTILATION
      END


     WHILE RETRIEVING PDVENTILATION &
      VIA    PJTABR,                            &
             PJTANN,                            &
             COMNUMCOMINT,                      &
             DCINUMLIG,                         &
             CIECLE                             &
      USING  PJTABR            OF PDDETAIL_C_I, &
             PJTANN            OF PDDETAIL_C_I, &
             COMNUMCOMINT      OF PDDETAIL_C_I, &
             DCINUMLIG         OF PDDETAIL_C_I, &
             CIECLE             OF PDDETAIL_C_I
      BEGIN

;      IF CPTCLE OF PDVENTILATION = "402630" AND &
;         COMFRSCOUINC OF PDCOMMAN_INTERNE = "IN"
;      THEN BEGIN
;        LET T_STTCOUR = T_STTCOUR + (T_SURFACE * VENPRIUNI OF PDVENTILATION)
;        IF 0 = SIZE(TRUNCATE(T_CPTCLECOU))
;        THEN BEGIN
;          LET T_CPTCLECOU = CPTCLE OF PDVENTILATION
;          LET T_UNACLECOU = UNACLE OF PDVENTILATION
;          LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
;        END
;      END
;      IF CPTCLE OF PDVENTILATION = "402610" AND &
;         COMFRSTRPTERINC OF PDCOMMAN_INTERNE = "IN"
;      THEN BEGIN
;        LET T_STTTRPTER = T_STTTRPTER + (T_SURFACE * VENPRIUNI OF PDVENTILATION)
;        IF 0 = SIZE(TRUNCATE(T_CPTCLETRPTER))
;        THEN BEGIN
;          LET T_CPTCLETRPTER = CPTCLE OF PDVENTILATION
;          LET T_UNACLETRPTER = UNACLE OF PDVENTILATION
;          LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
;        END
;      END
;      IF CPTCLE OF PDVENTILATION = "402620" AND &
;         COMFRSTRPMARINC OF PDCOMMAN_INTERNE = "IN"
;      THEN BEGIN
;        LET T_STTTRPMER = T_STTTRPMER + (T_SURFACE * VENPRIUNI OF PDVENTILATION)
;        IF 0 = SIZE(TRUNCATE(T_CPTCLETRPMER))
;        THEN BEGIN
;          LET T_CPTCLETRPMER = CPTCLE OF PDVENTILATION
;          LET T_UNACLETRPMER = UNACLE OF PDVENTILATION
;          LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
;        END
;      END
;      IF CPTCLE OF PDVENTILATION <> "402610" AND &
;         CPTCLE OF PDVENTILATION <> "402620" AND &
;         CPTCLE OF PDVENTILATION <> "402630"
;      THEN BEGIN
        IF 0 = SIZE(TRUNCATE(T_CPTCLE001)) AND &
           0 = SIZE(TRUNCATE(T_CPTCLE002)) AND &
           0 = SIZE(TRUNCATE(T_CPTCLE003)) AND &
           0 = SIZE(TRUNCATE(T_CPTCLE004)) AND &
           0 = SIZE(TRUNCATE(T_CPTCLE005))
        THEN BEGIN
          LET T_UNACLE001 = UNACLE OF PDVENTILATION
          LET T_CPTCLE001 = CPTCLE OF PDVENTILATION
          LET T_NBRE_CPTCLE_AUTRE = 1
          LET T_AJFVEN001 = VENPRIUNI OF PDVENTILATION
        END
        IF 0 <> SIZE(TRUNCATE(T_CPTCLE001)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE002)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE003)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE004)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE005)) AND &
           T_CPTCLE001 <> CPTCLE OF PDVENTILATION
         THEN BEGIN
          LET T_UNACLE002 = UNACLE OF PDVENTILATION
          LET T_CPTCLE002 = CPTCLE OF PDVENTILATION
          LET T_NBRE_CPTCLE_AUTRE = 2
          LET T_AJFVEN002 = VENPRIUNI OF PDVENTILATION
        END
        IF 0 <> SIZE(TRUNCATE(T_CPTCLE001)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE002)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE003)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE004)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE005)) AND &
           T_CPTCLE001 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE002 <> CPTCLE OF PDVENTILATION
        THEN BEGIN
          LET T_UNACLE003 = UNACLE OF PDVENTILATION
          LET T_CPTCLE003 = CPTCLE OF PDVENTILATION
          LET T_NBRE_CPTCLE_AUTRE = 3
          LET T_AJFVEN003 = VENPRIUNI OF PDVENTILATION
        END
        IF 0 <> SIZE(TRUNCATE(T_CPTCLE001)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE002)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE003)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE004)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE005)) AND &
           T_CPTCLE001 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE002 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE003 <> CPTCLE OF PDVENTILATION
        THEN BEGIN
          LET T_UNACLE004 = UNACLE OF PDVENTILATION
          LET T_CPTCLE004 = CPTCLE OF PDVENTILATION
         LET T_NBRE_CPTCLE_AUTRE = 4
          LET T_AJFVEN004 = VENPRIUNI OF PDVENTILATION
        END
        IF 0 <> SIZE(TRUNCATE(T_CPTCLE001)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE002)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE003)) AND &
           0 <> SIZE(TRUNCATE(T_CPTCLE004)) AND &
           0 =  SIZE(TRUNCATE(T_CPTCLE005)) AND &
           T_CPTCLE001 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE002 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE003 <> CPTCLE OF PDVENTILATION AND &
           T_CPTCLE004 <> CPTCLE OF PDVENTILATION
        THEN BEGIN
          LET T_UNACLE005 = UNACLE OF PDVENTILATION
          LET T_CPTCLE005 = CPTCLE OF PDVENTILATION
          LET T_NBRE_CPTCLE_AUTRE = 5
          LET T_AJFVEN005 = VENPRIUNI OF PDVENTILATION
        END

;        LET T_AJFVEN = T_AJFVEN001 + T_AJFVEN002 + T_AJFVEN003 + T_AJFVEN004 + T_AJFVEN005
        LET T_SOMPRIX = VENPRIUNI OF PDVENTILATION

        IF T_CPTCLE001 = CPTCLE OF PDVENTILATION
        THEN BEGIN
         IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
         THEN BEGIN
          IF T_VENPRIUNI <> VENPRIUNI OF PDVENTILATION
          THEN BEGIN
             if t_surface_t <> t_surface_old
             then LET T_SURFACE_T = T_SURFACE_T - T_SURFACE_OLD
           LET T_VENPRIUNI = VENPRIUNI OF PDVENTILATION
          END
          LET T_SURFACE_OLD = T_SURFACE_T
         END
         LET T_SURFACE_1 = VENPRIUNI OF PDVENTILATION * T_SURFACE_T
         IF TPDTYPPRD OF PDDETAIL_C_I ="TR"
         THEN LET T_SURFACE_T = 0
         LET T_AJFSUR  = (T_FOR/ T_AJFVEN)*VENPRIUNI OF PDVENTILATION;T_AJFVEN001

         LET T_MNTVNT001 = T_MNTVNT001 + T_SURFACE_1 + T_AJFSUR
        END

        IF T_CPTCLE002 = CPTCLE OF PDVENTILATION
        THEN BEGIN
         IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
         THEN BEGIN
          IF T_VENPRIUNI <> VENPRIUNI OF PDVENTILATION
          THEN BEGIN
             if t_surface_t <> t_surface_old
             then LET T_SURFACE_T = T_SURFACE_T - T_SURFACE_OLD
           LET T_VENPRIUNI = VENPRIUNI OF PDVENTILATION
          END
          LET T_SURFACE_OLD = T_SURFACE_T
         END
         LET T_SURFACE_2 = ROUND(VENPRIUNI OF PDVENTILATION * T_SURFACE_T,5)
         IF TPDTYPPRD OF PDDETAIL_C_I ="TR"
         THEN LET T_SURFACE_T = 0
          LET T_AJFSUR  = (T_FOR / T_AJFVEN)*VENPRIUNI OF PDVENTILATION;T_AJFVEN002
          LET T_MNTVNT002 = T_MNTVNT002 + T_SURFACE_2 + T_AJFSUR
        END

        IF T_CPTCLE003 = CPTCLE OF PDVENTILATION
        THEN BEGIN
         IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
         THEN BEGIN
          IF T_VENPRIUNI <> VENPRIUNI OF PDVENTILATION
          THEN BEGIN
             if t_surface_t <> t_surface_old
             then LET T_SURFACE_T = T_SURFACE_T - T_SURFACE_OLD
           LET T_VENPRIUNI = VENPRIUNI OF PDVENTILATION
          END
           LET T_SURFACE_OLD = T_SURFACE_T
         END
         LET T_SURFACE_3 = ROUND(VENPRIUNI OF PDVENTILATION * T_SURFACE_T,5)
         IF TPDTYPPRD OF PDDETAIL_C_I ="TR"
         THEN LET T_SURFACE_T = 0
          LET T_AJFSUR  = (T_FOR / T_AJFVEN)*VENPRIUNI OF PDVENTILATION;T_AJFVEN003
          LET T_MNTVNT003 = T_MNTVNT003 + T_SURFACE_3 + T_AJFSUR
        END
        IF T_CPTCLE004 = CPTCLE OF PDVENTILATION
        THEN BEGIN
         IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
         THEN BEGIN
          IF T_VENPRIUNI <> VENPRIUNI OF PDVENTILATION
          THEN BEGIN
             if t_surface_t <> t_surface_old
             then LET T_SURFACE_T = T_SURFACE_T - T_SURFACE_OLD
           LET T_VENPRIUNI = VENPRIUNI OF PDVENTILATION
          END
          LET T_SURFACE_OLD = T_SURFACE_T
         END
         LET T_SURFACE_4 = ROUND(VENPRIUNI OF PDVENTILATION * T_SURFACE_T,5)
         IF TPDTYPPRD OF PDDETAIL_C_I ="TR"
         THEN LET T_SURFACE_T = 0
          LET T_AJFSUR  = (T_FOR / T_AJFVEN)*VENPRIUNI OF PDVENTILATION;T_AJFVEN004
          LET T_MNTVNT004 = T_MNTVNT004 + T_SURFACE_4 + T_AJFSUR
        END
        IF T_CPTCLE005 = CPTCLE OF PDVENTILATION
        THEN BEGIN
         IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
         THEN BEGIN
          IF T_VENPRIUNI <> VENPRIUNI OF PDVENTILATION
          THEN BEGIN
             if t_surface_t <> t_surface_old
             then LET T_SURFACE_T = T_SURFACE_T - T_SURFACE_OLD
           LET T_VENPRIUNI = VENPRIUNI OF PDVENTILATION
          END
          LET T_SURFACE_OLD = T_SURFACE_T
         END
         LET T_SURFACE_5 = ROUND(VENPRIUNI OF PDVENTILATION * T_SURFACE_T,5)
         IF TPDTYPPRD OF PDDETAIL_C_I ="TR"
         THEN LET T_SURFACE_T = 0
          LET T_AJFSUR  = (T_FOR / T_AJFVEN)*VENPRIUNI OF PDVENTILATION;T_AJFVEN005
          LET T_MNTVNT005 = T_MNTVNT005 + T_SURFACE_5 + T_AJFSUR
        END
     END

END
;--------------------------------------------------------------------------
;
PROCEDURE INTERNAL RECHERCHE_DIAGRAMME
BEGIN
       WHILE RETRIEVING PDEMBAL_DIAG &
           VIA    CIECLE,                      &
                  CAINUMCAI &
           USING  CIECLE    OF PDLIVRE_CAISSON,&
                  CAINUMCAI OF PDLIVRE_CAISSON
       BEGIN
            GET PDDIAGRAMME OPT &
             VIA  CIECLE,&
                  DIANUM002 ,&
                  PJTABR          ,&
                  PJTANN          ,&
                 COMNUMCOMINT    ,&
                  DCINUMLIG        &
            USING CIECLE        OF PDEMBAL_DIAG ,&
                  DIANUM002     OF PDEMBAL_DIAG ,&
                  PJTABR        OF PDDETAIL_C_I,&
                  PJTANN        OF PDDETAIL_C_I,&
                  COMNUMCOMINT  OF PDDETAIL_C_I,&
                  DCINUMLIG     OF PDDETAIL_C_I

            IF ACCESSOK
            THEN BEGIN

             GET   VEXPDIA  OPTIONAL                &
              VIA     CIECLE,                   &
                      FTRNUMFAC,&
                      COMNUMCOM, &
                      DIANUM002,                 &
                      BLINUMBLI                ,&
                      EXPNUMEXP                 &
              USING   CIECLE OF PDFACTURE,      &
                      FTRNUMFAC OF PDFACTURE,&
                      COMNUMCOM OF PDFACTURE, &
                      DIANUM002 OF PDDIAGRAMME,&
                      T_BLINUMBLI,&
                      T_EXPNUMEXP
             IF ACCESSOK
               THEN BEGIN
                 LET T_IMPLIGDET = 1
                 LET T_CTRPIE = T_CTRPIE + EMDQTEVEN OF PDEMBAL_DIAG ;V_QTE_TOT_DIA
                 LET T_MNTTOT = T_MNTTOT + EMDPRIUNI OF VEXPDIA * EMDQTEVEN OF PDEMBAL_DIAG ;V_QTE_TOT_DIA
                 LET T_SURFACE_M2 = T_SURFACE_M2 + (DIASURMC2 OF PDDIAGRAMME * EMDQTEVEN OF PDEMBAL_DIAG) ;V_QTE_TOT_DIA)
                  LET T_SURFACE_T =T_SURFACE_T + ROUND (DIASURMC2 OF PDDIAGRAMME * EMDQTEVEN OF PDEMBAL_DIAG,5)
                  IF T_UN = "M2"
                  THEN BEGIN
                   LET T_SURFACE = T_SURFACE + (DIASURMC2 OF PDDIAGRAMME * EMDQTEVEN OF PDEMBAL_DIAG);V_QTE_TOT_DIA)
                  END

                  ELSE BEGIN
                  LET T_UNM = "M2"

                   GET   PDCONVERT_UN_M OPTIONAL         &
                       VIA     CIECLE,                   &
                               CUMCODUNMINT,             &
                               CUMCODUNMEXT              &
                       USING   T_CIECLEMNU,              &
                               T_UNM,                    &
                               DCIUNMCMD OF PDDETAIL_C_I

                   IF ACCESSOK
                    ;THEN LET T_SURFACE = T_SURFACE + (DIASURMC2 OF PDDIAGRAMME * V_QTE_TOT_DIA) * CUMFACCON OF PDCONVERT_UN_M
                    THEN LET T_SURFACE = T_SURFACE + (DIASURMC2 OF PDDIAGRAMME * EMDQTEVEN OF PDEMBAL_DIAG) * CUMFACCON OF PDCONVERT_UN_M
              ;      LET T_SURFACE_T = (DIASURMC2 OF PDDIAGRAMME * EMDQTEVEN OF PDEMBAL_DIAG) * CUMFACCON OF PDCONVERT_UN_M

                  END
                  LET T_SURFACE_MNT = T_SURFACE_MNT + (EMDPRIUNI OF VEXPDIA * EMDQTEVEN OF PDEMBAL_DIAG);V_QTE_TOT_DIA)
               END
             END
     END
 END
;-------------------------------------------------------------------------------
; Calcul des lignes de détail de diagramme pour la facture
;
PROCEDURE INTERNAL TRAITE_DETAIL_C_I_DIAG
BEGIN
  LET T_IMPLIGDET = 0
     WHILE RETRIEVING PDLIVRE_CAISSON &
       VIA   CIECLE,&
             EXPNUMEXP ,&
             BLINUMBLI &
       USING T_CIECLEMNU,&
             T_EXPNUMEXP,&
             T_BLINUMBLI
      BEGIN
       LET T_UN      = DCIUNMVEN OF PDDETAIL_C_I
       DO INTERNAL RECHERCHE_DIAGRAMME
      END
END
;--------------------------------------------------------------------------
;
PROCEDURE INTERNAL RECHERCHE_TRANCHE
BEGIN
  WHILE RETRIEVING PDEMBAL_TRANCHE              &
           VIA    CIECLE,                         &
                  CAINUMCAI ,                      &
                  PJTABR                         ,&
                  PJTANN                         ,&
                  COMNUMCOMINT                   ,&
                  DCINUMLIG                      &
           USING  CIECLE       OF PDLIVRE_CAISSON,&
                  CAINUMCAI    OF PDLIVRE_CAISSON,&
                  PJTABR       OF PDDETAIL_C_I   ,&
                  PJTANN       OF PDDETAIL_C_I   ,&
                  COMNUMCOMINT OF PDDETAIL_C_I   ,&
                  DCINUMLIG    OF PDDETAIL_C_I
  BEGIN
    GET VEXPTRA OPTIONAL                        &
      VIA    CIECLE,                            &
             TRANUMTRA002,                       &
             COMNUMCOM, &
             FTRNUMFAC, &
             BLINUMBLI,&
             EXPNUMEXP &
      USING  CIECLE    OF PDFACTURE,            &
             TRANUMTRA002 OF PDEMBAL_TRANCHE ,&
             COMNUMCOM OF PDFACTURE,&
             FTRNUMFAC OF PDFACTURE,&
             T_BLINUMBLI,&
             T_EXPNUMEXP
    IF ACCESSOK
    THEN BEGIN
        LET T_IMPLIGDET = 1
        LET T_CTRPIE = T_CTRPIE + 1
        LET T_MNTTOT = T_MNTTOT + ROUND((EMTSURMC2VEN OF PDEMBAL_TRANCHE * DCIPRIUNMPRD OF PDDETAIL_C_I),0)
        LET T_SURFACE_M2 = T_SURFACE_M2 + EMTSURMC2VEN OF PDEMBAL_TRANCHE
          LET T_SURFACE_T = T_SURFACE_T + EMTSURMC2VEN OF PDEMBAL_TRANCHE

        IF T_UN = "M2"
         THEN BEGIN
          LET T_SURFACE = T_SURFACE + EMTSURMC2VEN OF PDEMBAL_TRANCHE
         END
         ELSE BEGIN
         LET T_UNM = "M2"
             GET   PDCONVERT_UN_M OPTIONAL         &
               VIA     CIECLE,                   &
                       CUMCODUNMINT,             &
                       CUMCODUNMEXT              &
               USING   T_CIECLEMNU,              &
                       T_UNM ,&     ;DCIUNMCMD OF PDDETAIL_C_I,&
                       T_UN         ;T_TYPE


            IF ACCESSOK
            THEN BEGIN
              LET T_SURFACE = T_SURFACE + EMTSURMC2VEN OF PDEMBAL_TRANCHE * CUMFACCON OF PDCONVERT_UN_M
;              LET T_SURFACE_T = T_SURFACE_T + EMTSURMC2VEN OF PDEMBAL_TRANCHE * CUMFACCON OF PDCONVERT_UN_M

           END
          END
        LET T_SURFACE_MNT = T_SURFACE_MNT + ROUND((EMTSURMC2VEN OF PDEMBAL_TRANCHE * DCIPRIUNMPRD OF PDDETAIL_C_I),0)
    END
  END
END

;-------------------------------------------------------------------------------
; Calcul des lignes de détail de diagramme pour la facture
;
PROCEDURE INTERNAL TRAITE_DETAIL_C_I_TRANCHE
BEGIN
  LET T_IMPLIGDET = 0
     WHILE RETRIEVING PDLIVRE_CAISSON &
       VIA   CIECLE,&
             EXPNUMEXP ,&
             BLINUMBLI &
       USING T_CIECLEMNU,&
             T_EXPNUMEXP,&
             T_BLINUMBLI
      BEGIN
       LET T_UN      = DCIUNMVEN OF PDDETAIL_C_I
       DO INTERNAL RECHERCHE_TRANCHE
      END
END
;-------------------------------------------------------------------------------
; Procédure pour le détail de la facture
;
PROCEDURE INTERNAL LIRE_DETAIL
BEGIN
LET T_NOMBRE_NUM = 0
  ;
  ; Lire le detail de la facture s'il sagit d'une commande interne
  ;
  IF FTRTYPFAC OF PDFACTURE = "C"
  THEN BEGIN

    WHILE RETRIEVING PDDETAIL_C_I               &
      VIA   CIECLE,                             &
            COMNUMCOM                           &
      USING CIECLE      OF PDFACTURE,           &
            COMNUMCOM   OF PDFACTURE            &
      ORDERBY CIECLE,                           &
              COMNUMCOM,                        &
              TPDTYPPRD,                        &
              DCINUMLIG
    BEGIN

      LET T_TGRCODGRA = TGRCODGRA OF PDDETAIL_C_I
      LET T_TYFCODFIN = TYFCODFIN OF PDDETAIL_C_I
      LET T_TPDTYPPRD = TPDTYPPRD OF PDDETAIL_C_I
      LET T_DCIPRIVEN = DCIPRIVEN OF PDDETAIL_C_I
      LET T_DCIUNMVEN = DCIUNMVEN OF PDDETAIL_C_I

      LET T_MNTTOT  = 0
      LET T_CTRPIE  = 0
      LET T_SURFACE = 0
      LET T_SURFACE_MNT = 0
      IF TPDTYPPRD OF PDDETAIL_C_I = "DI"
      THEN BEGIN

        DO INTERNAL INIT_LIGNE_DETAIL
        DO INTERNAL TRAITE_DETAIL_C_I_DIAG

        ; Imprime la ligne de détail seulement si le numéro d'expédition et
        ; de bon de livraison sont les mêmes que ceux de la facture
        IF T_IMPLIGDET = 1
        THEN BEGIN
          DO INTERNAL IMPRIME_DETAIL_C_I
          DO INTERNAL IMPRIM_DETAIL
        END

      END

      IF TPDTYPPRD OF PDDETAIL_C_I = "TR"
      THEN BEGIN

        DO INTERNAL INIT_LIGNE_DETAIL
        DO INTERNAL TRAITE_DETAIL_C_I_TRANCHE

        ; Imprime la ligne de détail seulement si le numéro d'expédition et
        ; de bon de livraison sont les mêmes que ceux de la facture
        IF T_IMPLIGDET = 1
        THEN BEGIN
          DO INTERNAL IMPRIME_DETAIL_C_I
          DO INTERNAL IMPRIM_DETAIL
        END

      END
    END
  END
  ELSE BEGIN
    WHILE RETRIEVING PDTRANCHE_FAC     &
      VIA     FTRNUMFAC,               &
              CIECLE                   &
      USING   FTRNUMFAC OF PDFACTURE,  &
              CIECLE OF PDFACTURE      &
      ORDERBY TRANUMTRA002
    BEGIN
LET T_NOMBRE_NUM = 0
      GET PDTRANCHE                             &
        VIA   CIECLE,                           &
              TRANUMTRA002                      &
        USING CIECLE OF PDTRANCHE_FAC,          &
              TRANUMTRA002 OF PDTRANCHE_FAC OPTIONAL
      IF ACCESSOK
      THEN BEGIN

        GET PDTYPE_GRANIT                         &
          VIA   CIECLE,                           &
                TGRCODGRA                         &
          USING CIECLE OF PDTRANCHE_FAC,          &
                TGRCODGRA OF PDTRANCHE OPTIONAL

        GET PDTYPE_FINI                         &
          VIA   CIECLE,                         &
                TYFCODFIN                       &
          USING CIECLE OF PDTRANCHE_FAC,        &
                TYFCODFIN OF PDTRANCHE OPTIONAL

      END

      GET PDEMBAL_TRANCHE                    &
        VIA   CIECLE,                      &
              TRANUMTRA002                 &
        USING CIECLE OF PDTRANCHE_FAC,     &
              TRANUMTRA002 OF PDTRANCHE_FAC OPTIONAL

      GET PDCAISSON                          &
        VIA   CIECLE,                      &
              CAINUMCAI                    &
        USING CIECLE OF PDEMBAL_TRANCHE,   &
              CAINUMCAI OF PDEMBAL_TRANCHE OPTIONAL

      GET PDLIVRE_CAISSON                    &
        VIA   CIECLE,                      &
              CAINUMCAI                    &
        USING CIECLE OF PDCAISSON,         &
              CAINUMCAI OF PDCAISSON OPTIONAL

      GET PDBON_LIVRAISON                     &
        VIA   CIECLE,                       &
              EXPNUMEXP                     &
        USING CIECLE OF PDLIVRE_CAISSON,    &
              EXPNUMEXP OF PDLIVRE_CAISSON OPTIONAL

      DO INTERNAL INIT_LIGNE_DETAIL2

      LET T_NOMBRE_NUM = T_NOMBRE_NUM + 1
      LET T_NOMBRE  =  ASCII(T_NOMBRE_NUM); BLIQTECAI OF PDBON_LIVRAISON)
      LET T_TYPE2   = "TR/SL"
      LET T_TYP_GRA = TRUNCATE(TGRDSCFRA001 OF PDTYPE_GRANIT)
      LET T_TYP_FIN = TRUNCATE(TYFDSCFRA001 OF PDTYPE_FINI)
      LET T_EPAI    = ASCII(TRAEPA OF PDTRANCHE);TRFEPAVEN OF PDTRANCHE_FAC)
      LET T_ED_SU_1 = TRFSURMC2VEN OF PDTRANCHE_FAC
      LET T_SUR_VEN = D_EDIT_SU_1
      LET T_ED_MO_1 = TRFPRIVEN OF PDTRANCHE_FAC
      LET T_PRI_VEN = D_EDIT_1
      LET T_UNI_VEN = TRFUNMVEN
      LET T_ED_MO_1 = TRFMNT OF PDTRANCHE_FAC
      LET T_TOT_VEN = D_EDIT_1
      LET T_DETAIL  = PACK(T_TYP_GRA + " , " + T_TYP_FIN + " , " + &
                                  T_EPAI)
      DO INTERNAL IMPRIM_DETAIL2
      DO INTERNAL RECHER_COMMEN_TRAN

    END
    WHILE RETRIEVING PDPROD_FACTURE             &
      VIA     FTRNUMFAC,                        &
              CIECLE                            &
      USING   FTRNUMFAC OF PDFACTURE,           &
              CIECLE OF PDFACTURE
    BEGIN
LET T_NOMBRE_NUM = 0
;      GET PDPROD_DIMENSION                      &
;        VIA   CIECLE,                           &
;              PDILON,                           &
;              PDIHAU,                           &
;              PDIEPA,                           &
;              TGRCODGRA,                        &
;              TYFCODFIN                         &
;        USING CIECLE OF PDPROD_FACTURE,         &
;              PDILON OF PDPROD_FACTURE,         &
;              PDIHAU OF PDPROD_FACTURE,         &
;              PDIEPA OF PDPROD_FACTURE,         &
;              TGRCODGRA OF PDPROD_FACTURE,      &
;              TYFCODFIN OF PDPROD_FACTURE OPTIONAL

;      IF ACCESSOK
;      THEN BEGIN

;        GET PDTYPE_GRANIT                         &
;          VIA   CIECLE,                           &
;                TGRCODGRA                         &
;          USING CIECLE OF PDFACTURE,              &
;                TGRCODGRA OF PDPROD_FACTURE OPTIONAL

;        GET PDTYPE_FINI                           &
;          VIA   CIECLE,                           &
;                TYFCODFIN                         &
;          USING CIECLE OF PDFACTURE,              &
;                TYFCODFIN OF PDPROD_FACTURE OPTIONAL

;      END

      GET PDLIVRE_CAISSON                       &
        VIA   CIECLE,                           &
              CAINUMCAI                         &
        USING CIECLE OF PDCAISSON,              &
              CAINUMCAI OF PDPROD_FACTURE OPTIONAL

      GET PDBON_LIVRAISON                       &
        VIA   CIECLE,                           &
              EXPNUMEXP                         &
        USING CIECLE OF PDLIVRE_CAISSON,        &
              EXPNUMEXP OF PDLIVRE_CAISSON OPTIONAL
      DO INTERNAL INIT_LIGNE_DETAIL2
      LET T_NOMBRE_NUM = T_NOMBRE_NUM + 1
      LET T_NOMBRE  =  ASCII(T_NOMBRE_NUM);BLIQTECAI OF PDBON_LIVRAISON)
      LET T_TYPE2   = "PCE"

    GET PDTYPE_GRANIT             &
      VIA   CIECLE,               &
            TGRCODGRA             &
      USING CIECLE OF PDPROD_FACTURE,  &
            TGRCODGRA OF PDPROD_FACTURE
      LET T_TYP_GRA = TRUNCATE(TGRDSCFRA001 OF PDTYPE_GRANIT)

    GET PDTYPE_FINI               &
      VIA   CIECLE,               &
            TYFCODFIN             &
      USING CIECLE OF PDPROD_FACTURE,  &
            TYFCODFIN OF PDPROD_FACTURE
      LET T_TYP_FIN = TRUNCATE(TYFDSCFRA001 OF PDTYPE_FINI)

      LET T_EPAI    = ASCII(PDIEPA OF PDPROD_FACTURE)
      LET T_HAUT    = ASCII(PDIHAU OF PDPROD_FACTURE)
      LET T_LONG    = ASCII(PDILON OF PDPROD_FACTURE)
      LET T_ED_SU_1 = PDISURMC2 OF PDPROD_FACTURE
      LET T_SUR_VEN = D_EDIT_SU_1
      LET T_ED_MO_1 = PFAPRIVEN OF PDPROD_FACTURE
      LET T_PRI_VEN = D_EDIT_1
      LET T_UNI_VEN = PFAUNMVEN OF PDPROD_FACTURE
      LET T_ED_MO_1 = PFAMNT OF PDPROD_FACTURE
      LET T_TOT_VEN = D_EDIT_1
      LET T_DETAIL  = PACK(T_TYP_GRA + " , " + T_TYP_FIN + " , " + &
                                  T_EPAI)
      DO INTERNAL IMPRIM_DETAIL2
      DO INTERNAL RECHER_COMMEN_PROD

    END
    WHILE RETRIEVING PDBLOC_FACTURE         &
      VIA     CIECLE,                  &
              FTRNUMFAC                &
      USING   CIECLE OF PDFACTURE,     &
              FTRNUMFAC OF PDFACTURE   &
      ORDERBY BLONUMBLOAPR
    BEGIN
      GET PDBLOC                                &
        VIA   BLONUMBLOAPR,                     &
              CIECLE                            &
        USING BLONUMBLOAPR OF PDBLOC_FACTURE,   &
              CIECLE OF PDBLOC_FACTURE OPTIONAL
      IF ACCESSOK
      THEN BEGIN

        GET PDTYPE_GRANIT                       &
          VIA   CIECLE,                         &
                TGRCODGRA                       &
          USING CIECLE OF PDBLOC,               &
                TGRCODGRA OF PDBLOC  OPTIONAL

      END

      DO INTERNAL INIT_LIGNE_DETAIL2

      LET T_NOMBRE  = " 1 "
      LET T_TYPE2   = "BLOC"
      LET T_TYP_GRA = TRUNCATE(TGRDSCFRA001 OF PDTYPE_GRANIT)
      LET T_TYP_FIN = " "
      LET T_EPAI    = ASCII(BLFLARVEN OF PDBLOC_FACTURE)
      LET T_HAUT    = ASCII(BLFHAUVEN OF PDBLOC_FACTURE)
      LET T_LONG    = ASCII(BLFLONVEN OF PDBLOC_FACTURE)
      LET T_ED_SU_1 = BLOVOLMC3 OF PDBLOC
      LET T_SUR_VEN = D_EDIT_SU_1
      LET T_ED_MO_1 = BLFPRIVEN OF PDBLOC_FACTURE
      LET T_PRI_VEN = D_EDIT_1
      LET T_UNI_VEN = BLFUNMVEN
      LET T_ED_MO_1 = BLFMNT OF PDBLOC_FACTURE
      LET T_TOT_VEN = D_EDIT_1
      LET T_DETAIL  = PACK(T_TYP_GRA + " , " + T_EPAI + " , " + &
                                  T_HAUT + " , " + T_LONG )




       ; Allez checher les frais de courtage et de transport dans la table
       ; PDTRANP_DOU_ECT
       GET PDTRANP_DOU_ECT OPTIONAL      &
           VIA   CIECLE,                 &
                 FTRNUMFAC,              &
                 CDICODCHR               &
         USING   CIECLE OF PDFACTURE, &
                 FTRNUMFAC OF PDFACTURE, &
                 "COURT"
       IF ACCESSOK
       THEN BEGIN
        GET PDCHARGES_DIVERS OPTIONAL &
            VIA   CIECLE,   &
                  CDICODCHR &
            USING CIECLE    OF PDTRANP_DOU_ECT, &
                  CDICODCHR OF PDTRANP_DOU_ECT
        IF ACCESSOK
        THEN BEGIN
          LET T_STTCOUR = (TDEPRI OF PDTRANP_DOU_ECT)
          IF 0 = SIZE(TRUNCATE(T_CPTCLECOU))
          THEN BEGIN
            LET T_CPTCLECOU = CPTCLE OF PDCHARGES_DIVERS
            LET T_UNACLECOU = UNACLE OF PDCHARGES_DIVERS
            LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
          END
        END
       END
       GET PDTRANP_DOU_ECT OPTIONAL      &
           VIA   CIECLE,                 &
                 FTRNUMFAC,              &
                 CDICODCHR               &
         USING   CIECLE    OF PDFACTURE, &
                 FTRNUMFAC OF PDFACTURE, &
                 "TRANS"
       IF ACCESSOK
       THEN BEGIN
        GET PDCHARGES_DIVERS OPTIONAL &
            VIA   CIECLE,   &
                  CDICODCHR &
            USING CIECLE    OF PDTRANP_DOU_ECT, &
                  CDICODCHR OF PDTRANP_DOU_ECT
        IF ACCESSOK
        THEN BEGIN
          LET T_STTTRPTER = (TDEPRI OF PDTRANP_DOU_ECT)
          IF 0 = SIZE(TRUNCATE(T_CPTCLETRPTER))
          THEN BEGIN
            LET T_CPTCLETRPTER = CPTCLE OF PDCHARGES_DIVERS
            LET T_UNACLETRPTER = UNACLE OF PDCHARGES_DIVERS
            LET T_NBRE_CPTCLE_FRAIS = T_NBRE_CPTCLE_FRAIS + 1
          END
        END
       END

      DO INTERNAL IMPRIM_DETAIL2
      DO INTERNAL RECHER_COMMEN_BLOC

    END


  END

  DO INTERNAL RECHER_COMMEN_FACT


  DO INTERNAL RECHER_CHARGES_DIVERS

END

;---------------------------------------------------------------------------
;
;  Procédure ENTRY.
;
PROCEDURE ENTRY
BEGIN

ACCEPT T_CIECLEMNU
ACCEPT T_FACNUMDEB
ACCEPT T_FACNUMFIN

WHILE RETRIEVING PDFACTURE VIA CIECLE USING T_CIECLEMNU
BEGIN
 IF CIECLE OF PDFACTURE = T_CIECLEMNU AND &
   (FTRNUMFAC OF PDFACTURE >= T_FACNUMDEB AND &
    FTRNUMFAC OF PDFACTURE <= T_FACNUMFIN)
 THEN BEGIN

 GET PDLOT_FACTURE VIA CIECLE , FTRNUMFAC USING CIECLE OF PDFACTURE,&
                                FTRNUMFAC OF PDFACTURE OPT
 IF ACCESSOK
 THEN BEGIN
  LET T_LTRNUMLOT = LTRNUMLOT OF PDLOT_FACTURE

  RUN SCREEN fac003a MODE E PASSING &
                            T_CIECLEMNU,&
                            T_LTRNUMLOT


 LET T_FACNUM = FTRNUMFAC OF PDFACTURE


  DO INTERNAL PREPARATION_FICHIER_PRT
  ;
  ; Assignation du maximum de ligne pour l'impression
  ;
  LET T_MAX_LIGNE   = 49
  LET T_MIN_PAG_FOO = 9
  ;

    LET T_PREMIER_MONTANT = 0
    LET T_FACNUMFAC = ASCII(FTRNUMFAC OF PDFACTURE,7)
    LET T_CLICLE    = CLICLE OF PDFACTURE
    LET T_FACDATFAC = ASCII(FTRDATFAC OF PDFACTURE)[1:4] + "/" + &
                      ASCII(FTRDATFAC OF PDFACTURE)[5:2] + "/" + &
                      ASCII(FTRDATFAC OF PDFACTURE)[7:2]

    DO INTERNAL LIRE_FICHIER

    DO INTERNAL IMPRIME_ENTETE

    DO INTERNAL LIRE_DETAIL
    ;
    ;Faire imprimer le page footing
    ;
    DO INTERNAL IMPRIME_FIN_PAGE
    DO INTERNAL PAGE_FOOTING

  CLOSE PDIMPRIM_DOC
  ;
  GET VXPRIMP OPTIONAL

  LET T_CMD = "$LOG_PRO/print.sh -f ${PG_TEMP}/${PDIMP_DOC}.dat" + &
              " -d" + TRUNCATE(XILQUENAM OF VXPRIMP) + &
              " -p" + TRUNCATE(XFRPHYNAM OF VXPRIMP) + &
              " -g" + TRUNCATE(XILGRPIMP OF VXPRIMP) + &
              " -n 1 " + &
              " -- -c"
  RUN COMMAND T_CMD
  ;
  LET T_CMD = "rm -f ${PG_TEMP}/${PDIMP_DOC}.dat"
  RUN COMMAND T_CMD

  END
  END
  END
  RETURN
END

BUILD DETAIL LIST

