;/T/ 2.1.5 Enregistrer les rejet (Diagramme)
;
;/P/ Programmeur..: Martin Bruyère
;    Date Création: 1994-08-08
;
;    Description..: Cette unité de traitement permet d'enregistrer les
;                   rejets de diagramme.
;
;/M/ François Déry, 6 mai 1999
;       Modification de la table des diagrammes pour enlever les champs compute
;       qu'elle contenait et création d'une vue pour compenser.
;       Ajout du in dict sur la transaction des séquences.
;       Modifier l'affectation du # de rejet pour mettre l'item final.
;
;/M/ Programmeur...: Nicolas Groleau
;    Date..........: 8 Septembre 1998
;    But...........: Ne pas mettre à jour le qte coupee pour granicor
;                    (PDGQTECPEPRDGRA) car mis à jour dans PD7777.
;
;-------------------------------------------------------------------------------

;/V/ Écran vérifier pour le passage à l'an 2000


SCREEN pd221b ACTIONBAR                     &
              MODE LABEL "" AT 2,80         &
              NOACTION                      &
              ACTIVITIES ENTRY,DELETE & ;CHANGE       &
              FIELDMARK RETAIN STARTUP      &
              HELP POPUP FROM 4,9 TO 20,72  &
              RECEIVING T_CIECLEMNU,        &
                        T_CIENOM,           &
                        PDREJET





;-------------------------------------------------------------------------------
;
; Déclaration de la transaction pour donner un numéro séquentiel
;

TRANSACTION NO_SEQ READ WRITE &
                   RESERVING FOR PROTECTED WRITE PDSEQ_REJET IN DICT


;-------------------------------------------------------------------------------
;
; Débute une transaction pour le sous-écran
;
USE ustrasse  NOLIST


;-------------------------------------------------------------------------------
;
; Variables pour la sécurité.
;

; Variables temporaire pour la sécurité
;
; Description: Déclaration des variables temporaire pour la gestion
;              de la sécurité-prosig.
;
; Utilisation: Doit être utiliser dans la partie déclaration de l'écran.
;              C'est à dire avant la définition du premier fichier.
;
;------------------------------------------------------------------------------
;
; Accès au programme.
;
TEMPORARY TZ_SECACC CHARACTER SIZE 1 RESET AT STARTUP
;
; Saisie de données(Entry).
;
TEMPORARY TZ_SECENT CHARACTER SIZE 1 RESET AT STARTUP
;
; Destruction.(Delete)
;
TEMPORARY TZ_SECDEL CHARACTER SIZE 1 RESET AT STARTUP
;
; Modification.(Change mode)
;
TEMPORARY TZ_SECMOD CHARACTER SIZE 1 RESET AT STARTUP
;
; Variable pour l'élément de la sécurité.
;
TEMPORARY TZ_XELNOM CHARACTER SIZE 16 RESET AT STARTUP
TEMPORARY TZ_FLGAUT CHARACTER SIZE  1 RESET AT STARTUP
;
; Nom de l'écran pour retrouver la sécurité.
;
TEMPORARY TZ_NOMECR CHARACTER SIZE 7 RESET AT STARTUP INIT &
;
;
;**FIN USSECTMP
    "PD221B"


;-------------------------------------------------------------------------------
;
; Documentation de l'écran.
;

Description of screen &
@IF FRANCAIS
"                                                            " &
"     Cet écran permet de gérer les rejets de diagramme.     " &
"                                                            " &
"                                                            "
@ELSE
"                                                            " &
"     This screen permits ....                               " &
@ENDIF


;-------------------------------------------------------------------------------
;
; Actionbar standard
;

; ACTIONBAR
;
; Description: Définition du menu déroulant standard situé dans le haut de
;              l'écran.
;
; Utilisation: Il faut l'utiliser dans la partie déclaration de l'écran.
;              C'est à dire avant la déclaration des fichiers.
;
;
;
@IF FRANCAIS
ACTIONMENU LABEL "Rech"   ACTION FIND
ACTIONMENU LABEL "MAJ"    ACTION UPDATE
ACTIONMENU LABEL "Entrée" ACTION ENTRY
ACTIONMENU LABEL "Ajout"  ACTION APPEND
ACTIONMENU LABEL "Select" ACTION SELECT
;ACTIONMENU LABEL "Supp"   ACTION DELETE
@ELSE
ACTIONMENU LABEL "Find"   ACTION FIND
ACTIONMENU LABEL "Update" ACTION UPDATE
ACTIONMENU LABEL "Entry"  ACTION ENTRY
ACTIONMENU LABEL "Append" ACTION APPEND
ACTIONMENU LABEL "Select" ACTION SELECT
;ACTIONMENU LABEL "Del"    ACTION DELETE
@ENDIF

@IF VAXVMS AND FRANCAIS
ACTIONMENU LABEL "Aide"
  MENUITEM LABEL "Ecran      <PF1 PF2>" ACTION EXTENDED HELP
  MENUITEM LABEL "Champ          <PF2>" ACTION FIELD HELP MARK
  MENUITEM LABEL "Champ dét. <PF1 PF2>" ACTION EXTENDED FIELD HELP MARK
  MENUITEM LABEL "Recherche     <rech>" ACTION FIND
  MENUITEM LABEL "MAJ            <PF3>" ACTION UPDATE
  MENUITEM LABEL "MAJ Retour <PF1 PF3>" ACTION UPDATE RETURN
  MENUITEM LABEL "MAJ Garde      <F19>" ACTION UPDATE STAY
  MENUITEM LABEL "Entrée         <ins>" ACTION ENTRY
  MENUITEM LABEL "Ajout      <PF1 ins>" ACTION APPEND
  MENUITEM LABEL "Sélection   <sélect>" ACTION SELECT
 ; MENUITEM LABEL "Supp.    <eff.texte>" ACTION DELETE
 ; MENUITEM LABEL "Supp.Lig  <PF1 eff.>" ACTION DELETE MARK
  MENUITEM LABEL "Edition         <F9>" ACTION FIELDMARK
  MENUITEM LABEL "Bar d'action    <F7>" ACTION ACTIONBAR
  MENUITEM LABEL "Suivant  <page suiv>" ACTION NEXT DATA
  MENUITEM LABEL " //            <F18>" ACTION ACTIONBAR
  MENUITEM LABEL "Ecran préc.    <PF4>" ACTION RETURN
  MENUITEM LABEL "Sortie         <F10>" ACTION ACTIONBAR
  MENUITEM LABEL "Information    <tab>" ACTION INFORMATION
  MENUITEM LABEL "Impression     <F20>" ACTION LIST
  MENUITEM LABEL "Système       <exec>" ACTION SYSTEM
@ENDIF

@IF VAXVMS AND ANGLAIS
ACTIONMENU LABEL "Help"
  MENUITEM LABEL "Screen     <pf1 PF2>" ACTION EXTENDED HELP
  MENUITEM LABEL "Field          <PF2>" ACTION FIELD HELP MARK
  MENUITEM LABEL "Ext. Field <PF1 PF2>" ACTION EXTENDED FIELD HELP MARK
  MENUITEM LABEL "Find Mode     <find>" ACTION FIND
  MENUITEM LABEL "Update         <PF3>" ACTION UPDATE
  MENUITEM LABEL "Update Ret.<PF1 PF3>" ACTION UPDATE RETURN
  MENUITEM LABEL "Update Stay    <F19>" ACTION UPDATE STAY
  MENUITEM LABEL "Entry Mode     <ins>" ACTION ENTRY
  MENUITEM LABEL "Append     <PF1 ins>" ACTION APPEND
  MENUITEM LABEL "Selection   <select>" ACTION SELECT
 ; MENUITEM LABEL "Delete      <remove>" ACTION DELETE
 ; MENUITEM LABEL "Del. Line <PF1 rem.>" ACTION DELETE MARK
  MENUITEM LABEL "Field Mark      <F9>" ACTION FIELDMARK
  MENUITEM LABEL "Action Bar      <F7>" ACTION ACTIONBAR
  MENUITEM LABEL "Next     <next page>" ACTION NEXT DATA
  MENUITEM LABEL " //            <F18>" ACTION ACTIONBAR
  MENUITEM LABEL "Prev. Screen   <pf4>" ACTION RETURN
  MENUITEM LABEL "Quick Exit     <F10>" ACTION ACTIONBAR
  MENUITEM LABEL "Information    <tab>" ACTION INFORMATION
  MENUITEM LABEL "List           <F20>" ACTION LIST
  MENUITEM LABEL "System          <Do>" ACTION SYSTEM
@ENDIF

@IF UNIX AND FRANCAIS
ACTIONMENU LABEL "Aide"
  MENUITEM LABEL "Aide            F1_H" ACTION HELP
  MENUITEM LABEL "Aide dét.       F1_?" ACTION EXTENDED HELP
  MENUITEM LABEL "Recherche      F1_F7" ACTION FIND
  MENUITEM LABEL "MAJ               F5" ACTION UPDATE
  MENUITEM LABEL "MAJ Retour     F1_F5" ACTION UPDATE RETURN
  MENUITEM LABEL "MAJ Garde           " ACTION UPDATE STAY
  MENUITEM LABEL "Entrée            F7" ACTION ENTRY
  MENUITEM LABEL "Ajout               " ACTION APPEND
  MENUITEM LABEL "Sélection      F1_F6" ACTION SELECT
 ; MENUITEM LABEL "Supp.             F2" ACTION DELETE
 ; MENUITEM LABEL "Supp.Lig            " ACTION DELETE MARK
  MENUITEM LABEL "Edition         F1_M" ACTION FIELDMARK
  MENUITEM LABEL "Bar d'action    F1_B" ACTION ACTIONBAR
  MENUITEM LABEL "Suivant       <Next>" ACTION NEXT DATA
  MENUITEM LABEL " //             F1_A" ACTION ACTIONBAR
  MENUITEM LABEL "Ecran préc.       F8" ACTION RETURN
  MENUITEM LABEL "Sortie         F1_F8" ACTION ACTIONBAR
  MENUITEM LABEL "Information     F1_I" ACTION INFORMATION
  MENUITEM LABEL "Impression écran  F3" ACTION LIST
@ENDIF

@IF UNIX AND ANGLAIS
ACTIONMENU LABEL "Help"
  MENUITEM LABEL "Help            F1_H" ACTION HELP
  MENUITEM LABEL "Ext. Help       F1_?" ACTION EXTENDED HELP
  MENUITEM LABEL "Find mode      F1_F7" ACTION FIND
  MENUITEM LABEL "Update            F5" ACTION UPDATE
  MENUITEM LABEL "Update Return  F1_F5" ACTION UPDATE RETURN
  MENUITEM LABEL "Update Stay         " ACTION UPDATE STAY
  MENUITEM LABEL "Entry Mode        F7" ACTION ENTRY
  MENUITEM LABEL "Append              " ACTION APPEND
  MENUITEM LABEL "Selection      F1_F6" ACTION SELECT
 ; MENUITEM LABEL "Delete            F2" ACTION DELETE
 ; MENUITEM LABEL "Del line            " ACTION DELETE MARK
  MENUITEM LABEL "Field Mark      F1_M" ACTION FIELDMARK
  MENUITEM LABEL "Action Bar      F1_B" ACTION ACTIONBAR
  MENUITEM LABEL "Next          <Next>" ACTION NEXT DATA
  MENUITEM LABEL " //             F1_A" ACTION ACTIONBAR
  MENUITEM LABEL "Prev. Screen      f8" ACTION RETURN
  MENUITEM LABEL "Quick Exit     F1_F8" ACTION ACTIONBAR
  MENUITEM LABEL "Information     F1_I" ACTION INFORMATION
  MENUITEM LABEL "List              F3" ACTION LIST
@ENDIF
;
;
;**FIN USACTECR


;-------------------------------------------------------------------------------
;
; Variables saisie ou affichée dans le menu. (et utilisés dans le passage de
; paramètres).
;
TEMPORARY T_CIECLEMNU CHARACTER SIZE 4  RESET AT STARTUP ; Compagnie menu
TEMPORARY T_CIENOM    CHARACTER SIZE 40 RESET AT STARTUP ; nom compagnie


;-------------------------------------------------------------------------------
;
; Numéro et nom de la compagnie pour l'en-tête de l'écran.
;
DEFINE DZ_CIECLE CHARACTER SIZE 4 = T_CIECLEMNU
DEFINE DZ_CIENOM CHARACTER SIZE 40 = CENTER( T_CIENOM )


;-------------------------------------------------------------------------------
;
; Variables nécessaires au traitement
;

TEMPORARY T_TOT_QTE_IMP   INTEGER SIGNED SIZE 04
TEMPORARY T_TOT_QTE_A_IMP INTEGER SIGNED SIZE 04
TEMPORARY T_QTE_IMP       INTEGER SIGNED SIZE 04
TEMPORARY T_RRECODREJ     CHARACTER SIZE 04



;-------------------------------------------------------------------------------
;
; Rejet
;

FILE PDREJET MASTER ;NODELETE


;-------------------------------------------------------------------------------
;
; Détail rejet
;

FILE PDDET_REJET     PRIMARY &
                     NOITEM &
;                     NODELETE &
                     OCCURS 9 TIMES

  ACCESS VIA     CIECLE,            &
                 REJNUMREJ          &
         USING   T_CIECLEMNU ,                            &
                 REJNUMREJ          OF PDREJET            &
         ORDERBY CIECLE,            &
                 REJNUMREJ,         &
                 DIANUM002

  ITEM CIECLE    OF PDDET_REJET INITIAL T_CIECLEMNU
  ITEM REJNUMREJ OF PDDET_REJET FINAL   REJNUMREJ OF PDREJET
  ITEM TRANUMTRA002 OF PDDET_REJET INITIAL " "

  SELECT IF DIANUM002 OF PDDET_REJET <> " "

TEMPORARY OLD_DREQTE INTEGER SIZE 2 OCCURS WITH PDDET_REJET
TEMPORARY NEW_DREQTE INTEGER SIZE 2 OCCURS WITH PDDET_REJET

;-------------------------------------------------------------------------------
;
; Numéro séquentiel pour les rejets
;

FILE PDSEQ_REJET   DESIGNER &
                   TRANSACTION NO_SEQ


;-------------------------------------------------------------------------------
;
; Diagramme
;

FILE PDDIAGRAMME SECONDARY &
;                 NODELETE &
                 OCCURS WITH PDDET_REJET

  ACCESS VIA   CIECLE,      &
               DIANUM002    &
         USING T_CIECLEMNU, &
               DIANUM002    OF PDDET_REJET
;
; Quantité calculé du diagramme
;
FILE VDIAQTE          REFERENCE
  ACCESS VIA   PJTABR, &
               DIANUMDIA001, &
               DIANUMDIA002, &
               CIECLE &
         USING PJTABR OF PDDIAGRAMME, &
               DIANUMDIA001 OF PDDIAGRAMME, &
               DIANUMDIA002 OF PDDIAGRAMME, &
               CIECLE OF PDDIAGRAMME

;-------------------------------------------------------------------------------
;
; Priorité diagramme
;

FILE PDPRIORITE_DIAG DESIGNER


;-------------------------------------------------------------------------------
;
; Raison rejet
;

FILE PDRAISON_REJET REFERENCE OCCURS WITH PDDET_REJET

  ACCESS VIA   CIECLE,          &
               RRECODREJ        &
         USING T_CIECLEMNU,     &
               RRECODREJ        OF PDDET_REJET


;-------------------------------------------------------------------------------
;
;

; DRAW des écrans pleine page.
;
; Description: Ce USE sert à dessiner le cadre des écrans pleine page.
;
; Utilisation: Doit être utlisé avant la première énoncée FIELD>
;
;
DRAW 3,01 TO 23,80
;
;
;**FIN USDRWECR
; En-tête standard des écrans pleine page.
;
; Description: Ce USE sert à afficher l'en-tête standard des écrans pleine
;              page.
;
; Utilisation: Doit être utlisé avant la première énoncée FIELD.
;
;
SKIP TO LINE 2

@IF VAXVMS
HILITE DISPLAY HALFTONE
@ENDIF

ALIGN(,,1) (,,21)

FIELD DZ_CIECLE FIXED
FIELD DZ_CIENOM FIXED

;
;
;**FIN USTITSTD
; HILITE standard de tous les écrans
;
; Description: Définition du HILITE standard de tous les écrans, menu
;              écrans pleine page, popup...
;
; Utilisation: Doit être utilisé avant la première énoncé FIELD.
;
;
@IF VAXVMS
HILITE ACTIONBAR     INVERSE                     , &
       ACTIONBARMARK HALFTONE INVERSE            , &
       FIELDMARK     INVERSE                     , &
       MENUMARK      HALFTONE INVERSE            , &
       MODE          HALFTONE                    , &
       TITLE         HALFTONE                    , &
       DISPLAY       HALFTONE UNDERLINE          , &
       INFORMATION   INVERSE                     , &
       WARNING       INVERSE HALFTONE AUDIBLE    , &
       ERROR         INVERSE HALFTONE AUDIBLE    , &
       SEVERE        INVERSE HALFTONE AUDIBLE BLINKING
@ELSE
HILITE ACTIONBAR     HALFTONE INVERSE            , &
       ACTIONBARMARK INVERSE                     , &
       FIELDMARK     INVERSE HALFTONE            , &
       MENUMARK      INVERSE HALFTONE            , &
       MODE          HALFTONE                    , &
       LABEL         HALFTONE                    , &
       LINEDRAWING   HALFTONE                    , &
       TITLE         HALFTONE                    , &
       DISPLAY       UNDERLINE                   , &
       INFORMATION   INVERSE                     , &
       WARNING       INVERSE AUDIBLE             , &
       ERROR         INVERSE AUDIBLE             , &
       SEVERE        INVERSE AUDIBLE BLINKING
@ENDIF
;
;**FIN USHILITE

SKIP

TITLE &
@IF FRANCAIS
      " Rejet " &
@ELSE
      " %%%Rejet " &
@ENDIF
      CENTERED AT ,1


; HILITE TITLE OFF
;
; Description: Sert à désactiver l'option HILITE pour toutes les
;              énoncés TITLE qui suit ce USE. Seul le titre principal
;              a un HILITE particulier.
;
; Utilisation: Doit être utilisé après le titre principal de l'écran.
;
;
HILITE TITLE OFF
;
;
;**FIN USHILITE


SKIP TO LINE 5


ALIGN (2,3,19) (49,50,66)


FIELD REJNUMREJ        OF PDREJET          &
label "No rejet......:"&
        HIDDEN ID 05                       &
        FIXED


FIELD REJDATREJ        OF PDREJET           FORMAT YYYYMMDD &
PATTERN "####/##/##"&
label "Date rejet....:"&
        HIDDEN ID 10                       &
        FIXED


ALIGN (2,3,19)


FIELD REJDSC001        OF PDREJET          &
label "Description...:"&
        HIDDEN ID 15                       &
        FIXED


ALIGN (,,19)


FIELD REJDSC002        OF PDREJET          &
        ID SAME                            &
        FIXED


FIELD REJDSC003        OF PDREJET          &
        ID SAME                            &
        FIXED


DRAW 10,2 TO 10,79


SKIP TO LINE 10


TITLE &
@IF FRANCAIS
      " Diagrammes " &
@ELSE
      " %%%Diagrammes " &
@ENDIF
      CENTERED AT ,1


SKIP TO LINE 12


TITLE &
@IF FRANCAIS
    " Diagr.  Long Haut Épai Gra Fi   Qte Ra Description  " &
@ELSE
    "%%%agr.  Long Haut Épai Gra Fi   Qte Ra Description  " &
@ENDIF
     AT ,2

SKIP


ALIGN (02,02,03) (,,11) (,,16) (,,21) (,,26) (,,30) (,,33) (,,39) (,,42)


CLUSTER OCCURS WITH PDDET_REJET ID BASE 25


FIELD DIANUM002        OF PDDET_REJET      &
        HIDDEN                             &
        LABEL " "                          &
        REQUIRED                           &
        LOOKUP ON PDDIAGRAMME              &
          VIA   CIECLE,                    &
                DIANUM002                  &
          USING T_CIECLEMNU,               &
                DIANUM002 OF PDDET_REJET   &
          MESSAGE 2998 ; Ce numéro de diagramme n'existe pas


FIELD DIALON           OF PDDIAGRAMME      &
        HIDDEN                             &
        DISPLAY


FIELD DIAHAU           OF PDDIAGRAMME      &
        HIDDEN                             &
        DISPLAY


FIELD DIAEPA           OF PDDIAGRAMME      &
        HIDDEN                             &
        DISPLAY


FIELD TGRCODGRA        OF PDDIAGRAMME      &
        HIDDEN                             &
        DISPLAY


FIELD TYFCODFIN        OF PDDIAGRAMME      &
        HIDDEN                             &
        DISPLAY


FIELD DREQTE           OF PDDET_REJET      &
        NOCHANGE &
        HIDDEN                             &
        REQUIRED


FIELD RRECODREJ        OF PDDET_REJET      &
        HIDDEN                             &
        LOOKUP ON PDRAISON_REJET           &
          MESSAGE 2976 ; Cette raison n'existe pas


FIELD DREDSCREJ        OF PDDET_REJET      &
        HIDDEN                             &
        DEFAULT RREDSC001 OF PDRAISON_REJET &
        SIZE 37


CLUSTER


;-------------------------------------------------------------------------------
;
; Valide la sécurité d'accès de l'écran.
;

PROCEDURE INITIALIZE
BEGIN
; Appel de l'écran de sécurité.
;
; Description: Appel de l'écran de sécurité du module Gestion de système.
;              Les variables temporaires utilisées proviennent du USEFILE
;              USSECTMP.
;
; Utilisation: Doit être inséré dans la procédure INITIALIZE de l'écran.
;
;
RUN SCREEN gs000 PASSING TZ_NOMECR, & ; Nom de l'écran
                         TZ_SECACC, & ; Accès
                         TZ_SECENT, & ; Entrée
                         TZ_SECMOD, & ; Modification
                         TZ_SECDEL    ; Destruction

IF "3" = TZ_SECACC
THEN ERROR 6 ; L'usager n'est pas défini au système.

IF "2" = TZ_SECACC
THEN ERROR 7 ; Votre accès au système est expiré.

IF "0" = TZ_SECACC
THEN ERROR 8 ; Vous n'avez pas accès à cet option.
;
;
;**FIN USSECECR
END



;-------------------------------------------------------------------------------
;
; Appel du dépisteur (POP-UP) pour le champ.
;

PROCEDURE INPUT RRECODREJ
BEGIN
  IF 0 <> INDEX(FIELDTEXT,"*")
  THEN BEGIN
    LET T_RRECODREJ = FIELDTEXT[1:INDEX(FIELDTEXT,"*") - 1] + "@"
    RUN SCREEN pd104 MODE F &
                     PASSING T_RRECODREJ, &
                             T_CIECLEMNU
    LET FIELDTEXT = TRUNCATE( T_RRECODREJ )
  END
END

;-------------------------------------------------------------------------------
;
; Validation de la quantité
;

PROCEDURE EDIT DREQTE
BEGIN
  IF DREQTE OF PDDET_REJET > DIAQTECMD OF PDDIAGRAMME
  THEN BEGIN
    ;ERROR 3101 ; La quantité ne doit pas être suppérieure à la quantité commandée
  ;END
    IF DREQTE OF PDDET_REJET > (DIAQTEDBTGRA  OF VDIAQTE - DIAQTEREJ OF PDDIAGRAMME)
    THEN BEGIN
      ERROR "La quantité rejetée est plus grande que la quantité débitée !"
    END
  END
  LET OLD_DREQTE = 0 ;OLDVALUE(DREQTE OF PDDET_REJET)
  LET NEW_DREQTE = FIELDVALUE
END


;-------------------------------------------------------------------------------
;
; Valide le statut du montage avant de permettre la saisit des tranches
;

PROCEDURE PREENTRY
BEGIN
; Sécurité pour le mode ENTRY.
;
; Description: Valide si l'usager peut faire de la saisie dans cette
;              écran.
;
; Utilisation: Peut être utiliser dans la procédure INPUT du premier
;              champ saisie à l'écran, ou dans la procédure ENTRY
;              si celle-ci a été altérée.
;
;
IF     ENTRYMODE       &
   AND TZ_SECENT = "0"
THEN SEVERE 16 ; Vous ne pouvez pas saisir de données.
;
;
;**FIN USSECENT
END


;-------------------------------------------------------------------------------
;
; Mise à jour des quantités par priorité de diagramme
;

PROCEDURE INTERNAL MAJ_IMPUTATION_PRIORITE_POS
BEGIN

  LET T_TOT_QTE_IMP   = 0
  LET T_TOT_QTE_A_IMP = DREQTE OF PDDET_REJET
  LET T_QTE_IMP       = 0

  WHILE RETRIEVING PDPRIORITE_DIAG &
    VIA     CIECLE,          &
            DIANUM002        &
    USING   T_CIECLEMNU,                          &
            DIANUM002        OF PDDET_REJET       &
    ORDERBY CIECLE,                               &
            DIANUM002        ASCENDING,           &
            PRICODPRI        ASCENDING
  BEGIN

    ;
    ; Calcul de la quantité restante
    ;
    LET T_QTE_IMP = T_TOT_QTE_A_IMP - T_TOT_QTE_IMP
    ;
    ; Si la QTE est plus petite que la QTE planifiée pour la priorité
    ;
    IF T_QTE_IMP < (PDGQTEPLACPEGRA OF PDPRIORITE_DIAG - PDGQTECPEPRDGRA OF PDPRIORITE_DIAG)
    THEN BEGIN
      LET PDGQTECPEPRDGRA OF PDPRIORITE_DIAG = PDGQTECPEPRDGRA OF PDPRIORITE_DIAG + T_QTE_IMP
      LET T_TOT_QTE_IMP = T_TOT_QTE_IMP + T_QTE_IMP
    END
    ELSE BEGIN
      ;
      ; Vérifie qu'il reste une QTE à imputer pour la priorité
      ;
      IF PDGQTEPLACPEGRA OF PDPRIORITE_DIAG > PDGQTECPEPRDGRA OF PDPRIORITE_DIAG
      THEN BEGIN
        ;
        ; Impute la QTE emballer pour la priorité
        ;
        LET T_QTE_IMP = PDGQTEPLACPEGRA OF PDPRIORITE_DIAG - PDGQTECPEPRDGRA OF PDPRIORITE_DIAG
        LET PDGQTECPEPRDGRA OF PDPRIORITE_DIAG = PDGQTECPEPRDGRA OF PDPRIORITE_DIAG + T_QTE_IMP
        LET T_TOT_QTE_IMP = T_TOT_QTE_IMP + T_QTE_IMP
      END
    END
    PUT PDPRIORITE_DIAG
  END

END


;-------------------------------------------------------------------------------
;
; Permet de faire afficher le numéro de séquence
;

PROCEDURE POSTUPDATE
BEGIN
  IF CORRECTMODE
  THEN BEGIN
    DISPLAY REJNUMREJ OF PDREJET
    WARNING = " "
  END
END


;-------------------------------------------------------------------------------
;
; Mise à jour des quantités par priorité de diagramme
;

PROCEDURE INTERNAL MAJ_IMPUTATION_PRIORITE_NEG
BEGIN

  LET T_TOT_QTE_IMP   = 0
  LET T_TOT_QTE_A_IMP = DREQTE OF PDDET_REJET
  LET T_QTE_IMP       = 0

  WHILE RETRIEVING PDPRIORITE_DIAG &
    VIA     CIECLE,          &
            DIANUM002        &
    USING   T_CIECLEMNU,                          &
            DIANUM002        OF PDDET_REJET       &
    ORDERBY CIECLE,                               &
            DIANUM002        ASCENDING,           &
            PRICODPRI        ASCENDING
  BEGIN
    ;
    ; Calcul de la quantité restante
    ;
    LET T_QTE_IMP = T_TOT_QTE_A_IMP - T_TOT_QTE_IMP
    ;
    ; Si la QTE est plus petite que la QTE planifiée pour la priorité
    ;
    IF T_QTE_IMP < PDGQTECPEPRDGRA OF PDPRIORITE_DIAG
    THEN BEGIN
      LET PDGQTECPEPRDGRA OF PDPRIORITE_DIAG = PDGQTECPEPRDGRA OF PDPRIORITE_DIAG + T_QTE_IMP
      LET T_TOT_QTE_IMP = T_TOT_QTE_IMP + T_QTE_IMP
    END
    ELSE BEGIN
      ;----A VOIR
      ; Vérifie qu'il reste une QTE à imputer pour la priorité
      ;
      ;IF PDGQTECPEPRDGRA OF PDPRIORITE_DIAG > 0
      ;THEN BEGIN
        ;
        ; Impute la QTE emballer pour la priorité
        ;
      ;  LET T_QTE_IMP = PDGQTECPEPRDGRA OF PDPRIORITE_DIAG * -1
      ;  LET PDGQTECPEPRDGRA OF PDPRIORITE_DIAG = PDGQTECPEPRDGRA OF PDPRIORITE_DIAG + T_QTE_IMP
      ;  LET T_TOT_QTE_IMP = T_TOT_QTE_IMP + T_QTE_IMP
      ;END
      PUT PDPRIORITE_DIAG
    END
  END
END

;-------------------------------------------------------------------------------
;
; Valide les traitements permis par écran et par usager.
;

PROCEDURE PREUPDATE
BEGIN
  ;
  ; Validation de la destruction
  ;
  IF     DELETEDRECORD OF PDDET_REJET &
      AND TZ_SECDEL = "0"
  THEN ERROR 1
  ;
  ; Validation de la modification.
  ;
  IF     ALTEREDRECORD     OF PDDET_REJET &
     AND NOT NEWRECORD     OF PDDET_REJET &
     AND NOT DELETEDRECORD OF PDDET_REJET &
     AND TZ_SECMOD = "0"
  THEN ERROR 2



  FOR PDDET_REJET
  BEGIN
;    IF ALTEREDRECORD OF PDDET_REJET &
;       OR &
;       NEWRECORD     OF PDDET_REJET &
;       and not deletedrecord of pddet_rejet

    IF NEWRECORD     OF PDDET_REJET &
;       AND NOT ALTEREDRECORD OF PDDET_REJET &
       and not deletedrecord of pddet_rejet

    THEN BEGIN
      LET DIADATMAJ OF PDDIAGRAMME = SYSDATE
      LET DIAHREMAJ OF PDDIAGRAMME = SYSTIME / 10000
      LET DIAUSRMAJ OF PDDIAGRAMME = LOGONID

      LET DIAQTEREJ    OF PDDIAGRAMME = DIAQTEREJ OF PDDIAGRAMME - &
                                    OLD_DREQTE + &
                                    NEW_DREQTE
    ;  LET DIAQTEPREGRA OF PDDIAGRAMME = DIAQTEPREGRA OF PDDIAGRAMME - &
    ;                                OLD_DREQTE + &
    ;                                NEW_DREQTE
;---modif
      LET PJTABR       OF PDDET_REJET = PJTABR       OF PDDIAGRAMME
      LET DIANUMDIA002 OF PDDET_REJET = DIANUMDIA002 OF PDDIAGRAMME
      PUT PDDIAGRAMME
;      DO INTERNAL MAJ_IMPUTATION_PRIORITE_POS
     END
    IF DELETEDRECORD OF PDDET_REJET
    THEN BEGIN
      LET DIADATMAJ OF PDDIAGRAMME = SYSDATE
      LET DIAHREMAJ OF PDDIAGRAMME = SYSTIME / 10000
      LET DIAUSRMAJ OF PDDIAGRAMME = LOGONID
;---modif
      LET DIAQTEREJ    OF PDDIAGRAMME = DIAQTEREJ OF PDDIAGRAMME - &
                                        DREQTE OF PDDET_REJET
     ; LET DIAQTEPREGRA OF PDDIAGRAMME = DIAQTEPREGRA OF PDDIAGRAMME - &
     ;                                   DREQTE OF PDDET_REJET
;---modif
      LET PJTABR       OF PDDET_REJET = PJTABR       OF PDDIAGRAMME
      LET DIANUMDIA002 OF PDDET_REJET = DIANUMDIA002 OF PDDIAGRAMME
      PUT PDDIAGRAMME
;      DO INTERNAL MAJ_IMPUTATION_PRIORITE_NEG

    END
  END

  ;
  ; Incrémentation du numéro de séquence
  ;
  IF 0 = REJNUMREJ OF PDREJET
  THEN BEGIN
    START TRANSACTION NO_SEQ
    GET PDSEQ_REJET OPTIONAL            &
      VIA   CIECLE                      &
      USING T_CIECLEMNU
    IF NOT ACCESSOK
    THEN BEGIN
      LET CIECLE OF PDSEQ_REJET = T_CIECLEMNU
    END
    LET SRJNUMSEQ        OF PDSEQ_REJET      = SRJNUMSEQ        OF PDSEQ_REJET      + 1
    LET REJNUMREJ        OF PDREJET          = SRJNUMSEQ        OF PDSEQ_REJET
    PUT PDSEQ_REJET
    DISPLAY REJNUMREJ OF PDREJET
  END
END



PROCEDURE APPEND
  BEGIN
    ACCEPT DIANUM002 OF PDDET_REJET
    DISPLAY DIALON OF PDDIAGRAMME
    DISPLAY DIAHAU OF PDDIAGRAMME
    DISPLAY DIAEPA OF PDDIAGRAMME
    DISPLAY TGRCODGRA OF PDDIAGRAMME
    DISPLAY TYFCODFIN OF PDDIAGRAMME
    ACCEPT DREQTE OF PDDET_REJET
    ACCEPT RRECODREJ OF PDDET_REJET
    ACCEPT DREDSCREJ OF PDDET_REJET
    END
PROCEDURE ENTRY
  BEGIN

    FOR PDDET_REJET
      BEGIN
        PERFORM APPEND
        END
    END
PROCEDURE PATH
  BEGIN
    LET PATH = 1
    END
PROCEDURE FIND
  BEGIN
    FOR MISSING PDDET_REJET
      BEGIN
        GET PDDET_REJET VIA CIECLE , REJNUMREJ ORDERBY CIECLE , &
              REJNUMREJ , DIANUM002 USING T_CIECLEMNU , REJNUMREJ OF &
              PDREJET
        GET PDDIAGRAMME OPTIONAL
        END
    END
PROCEDURE UPDATE
  BEGIN
    PUT PDREJET
    FOR PDDET_REJET
      BEGIN
        PUT PDDET_REJET
        END
    END
PROCEDURE DELETE
  BEGIN
    DELETE PDDET_REJET
    END
BUILD


@IF FORMAT

xxxx                xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                   x
************************************ Rejet *************************************
*                                                                              *
* No rejet......: xxxxxxxxx                      Date rejet....: xxxxxxxx      *
* Description...: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                     *
*                 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                     *
*                 xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx                     *
*                                                                              *
********************************** Diagrammes **********************************
*                                                                              *
* Diagr.  Long Haut Épai Gra Fi   Qte Ra Description                           *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
* xxxxxxx xxxx xxxx xxxx xxx xx xxxxx xx xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx *
*                                                                              *
********************************************************************************

@ENDIF
